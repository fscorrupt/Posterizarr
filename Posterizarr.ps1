param (
    [switch]$Manual,
    [switch]$Testing,
    [switch]$Tautulli,
    [string]$RatingKey,
    [string]$parentratingkey,
    [string]$grandparentratingkey,
    [string]$mediatype,
    [switch]$Backup,
    [switch]$dev,
    [switch]$SyncJelly,
    [switch]$SyncEmby,
    [switch]$PosterReset,
    [string]$LibraryToReset
)
Set-PSReadLineOption -HistorySaveStyle SaveNothing

$CurrentScriptVersion = "1.9.51"
$global:HeaderWritten = $false
$ProgressPreference = 'SilentlyContinue'
$env:PSMODULE_ANALYSIS_CACHE_PATH = $null
$env:PSMODULE_ANALYSIS_CACHE_ENABLED = $false

#################
# What you need #
#####################################################################################################################
# TMDB API Read Access Token      -> https://www.themoviedb.org/settings/api
# FANART API                      -> https://fanart.tv/get-an-api-key
# TVDB API                        -> https://thetvdb.com/api-information/signup
# ImageMagick                     -> https://imagemagick.org/archive/binaries/ImageMagick-7.1.1-27-Q16-HDRI-x64-dll.exe
# FanartTv API Powershell Wrapper -> https://github.com/Celerium/FanartTV-PowerShellWrapper
#####################################################################################################################

#### FUNCTION START ####
function Reset-PlexLibraryPictures {
    param (
        [string]$LibraryName
    )

    # Fetch the sections of the Plex library
    try {
        if ($PlexToken) {
            $sections = Invoke-RestMethod -Uri "$PlexUrl/library/sections?X-Plex-Token=$PlexToken"
        }
        Else {
            $sections = Invoke-RestMethod -Uri "$PlexUrl/library/sections"
        }
    }
    catch {
        Write-Entry -Subtext "Error fetching sections: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
        return
    }

    $section = $sections.MediaContainer.Directory | Where-Object { $_.title -eq $LibraryName }

    if (-not $section) {
        Write-Entry -Subtext "Library not found: $LibraryName" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
        return
    }

    # Determine if the library is a show or not
    $IsShow = $null
    if ($section.type -eq "show") {
        $ContainerUrl = "directory"
        $IsShow = 'True'
    } Else {
        $ContainerUrl = "video"
        $IsShow = 'False'
    }

    $PlexHeaders = @{}
    # Default headers for Plex API requests
    $PlexHeaders['X-Plex-Container-Size'] = '1000'

    if ($PlexToken) {
        $PlexHeaders['X-Plex-Token'] = $PlexToken
    }

    # Fetch all items in the library
    try {
        $url = "$PlexUrl/library/sections/$($section.key)/all"
        $items = Invoke-RestMethod -Uri $url -Headers $PlexHeaders
    }
    catch {
        Write-Entry -Subtext "Error fetching library items: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
        return
    }

    foreach ($item in $items.MediaContainer.$ContainerUrl) {
        $title = $item.title
        $ratingKey = $item.ratingKey
        Write-Entry -Message "Current Show/Movie: $title [$ratingKey]" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug

        # If the item is a show, handle seasons and episodes
        if ($IsShow -eq 'True') {
            try {
                $SeasondataUrl = "$PlexUrl/library/metadata/$ratingKey/children?"
                $Seasondata = Invoke-RestMethod -Uri $SeasondataUrl -Headers $PlexHeaders
            }
            catch {
                Write-Entry -Subtext "Error fetching season data for show [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                continue
            }

            foreach ($season in $Seasondata.MediaContainer.Directory) {
                $SeasonratingKey = $season.ratingKey
                Write-Entry -Subtext "Season $($season.index): $($season.title) [$SeasonratingKey]" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug

                # Get posters for the season
                try {
                    $seasonposterUrls = "$PlexUrl/library/metadata/$SeasonratingKey/posters?"
                    $seasonposters = Invoke-RestMethod -Uri $seasonposterUrls -Headers $PlexHeaders
                }
                catch {
                    Write-Entry -Subtext "Error fetching season posters for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                    continue
                }

                if ($seasonposters.MediaContainer.Photo.Count -gt 0) {
                    $firstPosterKey = $seasonposters.MediaContainer.Photo[0].ratingKey -replace "^metadata://posters/", ""
                    $setPosterUrl = "$PlexUrl/library/metadata/$SeasonratingKey/poster?url=$firstPosterKey"

                    try {
                        $response = Invoke-RestMethod -Uri $setPosterUrl -Method PUT -Headers $PlexHeaders
                        Write-Entry -Subtext "Poster reseted for: $title (Season $($season.index))" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
                    }
                    catch {
                        Write-Entry -Subtext "Error setting Season poster for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                    }
                } else {
                    Write-Entry -Subtext "No Season posters found for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
                }

                # Fetch episodes for the season
                try {
                    $EpisodedataUrl = "$PlexUrl/library/metadata/$SeasonratingKey/children?"
                    $Episodedata = Invoke-RestMethod -Uri $EpisodedataUrl -Headers $PlexHeaders
                }
                catch {
                    Write-Entry -Subtext "Error fetching episode data for season [$SeasonratingKey]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                    continue
                }

                foreach ($episode in $Episodedata.MediaContainer.Video) {
                    $EpisodeRatingKey = $episode.ratingKey
                    Write-Entry -Subtext "Season $($season.index) - Episode $($episode.index): $($episode.title) [$EpisodeRatingKey]" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug

                    # Get posters for the episode
                    try {
                        $EpisodeposterUrls = "$PlexUrl/library/metadata/$EpisodeRatingKey/posters?"
                        $EpisodePosters = Invoke-RestMethod -Uri $EpisodeposterUrls -Headers $PlexHeaders
                    }
                    catch {
                        Write-Entry -Subtext "Error fetching episode posters for [$episode.title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                        continue
                    }

                    if ($EpisodePosters.MediaContainer.Photo.Count -gt 0) {
                        $firstPosterKey = $EpisodePosters.MediaContainer.Photo[0].ratingKey -replace "^metadata://posters/", ""
                        $setPosterUrl = "$PlexUrl/library/metadata/$EpisodeRatingKey/poster?url=$firstPosterKey"

                        try {
                            $response = Invoke-RestMethod -Uri $setPosterUrl -Method PUT -Headers $PlexHeaders
                            Write-Entry -Subtext "Poster reseted for: $title (Season $($season.index) - Episode $($episode.index))" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
                        }
                        catch {
                            Write-Entry -Subtext "Error setting Episode poster for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                        }
                    } else {
                        Write-Entry -Subtext "No Episode posters found for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
                    }
                }
            }
        }

        # Get posters for the main show
        try {
            $postersUrl = "$PlexUrl/library/metadata/$ratingKey/posters?"
            $posters = Invoke-RestMethod -Uri $postersUrl -Headers $PlexHeaders
        }
        catch {
            Write-Entry -Subtext "Error fetching posters for main show [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
            continue
        }

        if ($posters.MediaContainer.Photo.Count -gt 0) {
            $firstPosterKey = $posters.MediaContainer.Photo[0].ratingKey -replace "^metadata://posters/", ""
            $setPosterUrl = "$PlexUrl/library/metadata/$ratingKey/poster?url=$firstPosterKey"

            try {
                $response = Invoke-RestMethod -Uri $setPosterUrl -Method PUT -Headers $PlexHeaders
                Write-Entry -Subtext "Poster reseted for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
            }
            catch {
                Write-Entry -Subtext "Error setting poster for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
            }
        } else {
            Write-Entry -Subtext "No posters found for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
        }

        Start-Sleep -Seconds 1  # Avoid hammering server
    }
}
function Get-Resolution {
    param ($Width)
    switch ($true) {
        ($Width -ge 7680) { return "8K" }
        ($Width -ge 5120) { return "5K" }
        ($Width -ge 3840) { return "4K" }
        ($Width -ge 2560) { return "1440p" }
        ($Width -ge 1920) { return "1080p" }
        ($Width -ge 1280)  { return "720p" }
        ($Width -ge 854)   { return "480p" }
        ($Width -ge 640)   { return "360p" }
        ($Width -ge 426)   { return "240p" }
        default { return "unknown" }
    }
}
function Get-CPUModel {
    if ($Platform -eq 'Docker') {
        $cpuInfo = cat /proc/cpuinfo | Out-String
        $cpuModelLine = $cpuInfo -split "`n" | Where-Object { $_ -like "model name*" }
        $cpuModel = $cpuModelLine -replace "model name\s*:\s*", ""
        $cpuModel = $cpuModel[0]
    }
    Elseif ($Platform -eq 'Windows') {
        $cpuModel = (Get-CimInstance win32_processor).name
    }
    Elseif ($Platform -eq 'Linux') {
        $cpuInfo = lscpu | Out-String
        $cpuInfoLines = $cpuInfo -split "`n"
        $cpuModel = ($cpuInfoLines | Where-Object { $_ -like "Model name*" }) -replace "Model name\s*:\s*", ""
    }
    Elseif ($Platform -eq 'macOS') {
        $cpuModel = system_profiler SPHardwareDataType | grep "Processor Name" | awk -F': ' '{print $2}' | xargs
    }
    Else {
        $cpuModel = 'Unknown'
    }
    return $cpuModel
}
function GetHash {
    param ([byte[]]$imageBytes)

    # Create a hash algorithm instance (SHA256)
    $hashAlgorithm = [System.Security.Cryptography.SHA256]::Create()

    # Compute the hash from the byte array
    $hashBytes = $hashAlgorithm.ComputeHash($imageBytes)

    # Convert the hash bytes to a readable hex string
    $hashString = [BitConverter]::ToString($hashBytes) -replace "-", ""
    return $hashString
}
function Set-OSTypeAndScriptRoot {
    if ($env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
        $global:OSType = "Docker"
        $currentuser = whoami
        if ($currentuser -eq 'posterizarr' -or $currentuser -eq 'abc' -or $env:VIRTUAL_ENV -eq '/lsiopy' -or $env:POSTERIZARR_NON_ROOT -eq 'TRUE') {
            $global:ScriptRoot = "/config"
        }
        Else {
            $global:ScriptRoot = "./config"
        }
    }
    elseif ($env:APP_DATA) {
        $global:ScriptRoot = $env:APP_DATA
    }
    Else {
        $global:ScriptRoot = $PSScriptRoot
        $global:OSType = [System.Environment]::OSVersion.Platform
    }
}
function Write-Entry {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$Path,

        [Parameter(Mandatory = $false)]
        [string]$Message,

        [Parameter(Mandatory = $true)]
        [ValidateSet('Info', 'Warning', 'Error', 'Optional', 'Debug', 'Trace', 'Success')]
        [string]$log,

        [Parameter(Mandatory = $true)]
        [ValidateSet('White', 'Yellow', 'Red', 'Blue', 'DarkMagenta', 'Cyan', 'Green')]
        [string]$Color,

        [string]$Subtext = $null
    )
    switch ($log) {
        'Info' { $theLog = 2 }
        'Warning' { $theLog = 1 }
        'Error' { $theLog = 1 }
        'Debug' { $theLog = 3 }
        'Optional' { $theLog = 3 }
    }
    if (!(Test-Path -path $path)) {
        New-Item -Path $Path -Force | out-null
    }
    # ASCII art header
    if (-not $global:HeaderWritten) {
        # Retrieve CPU model
        $cpuModel = Get-CPUModel
        # Retrieve RAM Info
        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
            # Check Memory Usage (Total and Free)
            $memoryUsage = free -m | Out-String
            $memoryUsageLines = $memoryUsage -split "`n"
            $memValues = $memoryUsageLines[1] -split "\s+"

            $totalMemory = [int]$memValues[1]
            $usedMemory = [int]$memValues[2]
            $freeMemory = [int]$memValues[3]
            $sharedMemory = [int]$memValues[4]
            $buffersCache = [int]$memValues[5]
            $availableMemory = [int]$memValues[6]
            if (Test-Path /etc/os-release) {
                $OSVersion = (Get-Content /etc/os-release | Select-String -Pattern "^PRETTY_NAME=").ToString().Split('=')[1].Trim('"')
            }
            $Header = @"
======================================================
  _____          _            _
 |  __ \        | |          (_)
 | |__) |__  ___| |_ ___ _ __ _ ______ _ _ __ _ __
 |  ___/ _ \/ __| __/ _ \ '__| |_  / _``` | '__| '__|
 | |  | (_) \__ \ ||  __/ |  | |/ / (_| | |  | |
 |_|   \___/|___/\__\___|_|  |_/___\__,_|_|  |_|

 Current Version: $CurrentScriptVersion
 Latest Version: $LatestScriptVersion
 Platform: $Platform
 OS Version: $OSVersion
 Branch: $Branch

 CPU Model: $cpuModel

 Total Memory: $totalMemory MB
 Used Memory: $usedMemory MB
 Free Memory: $freeMemory MB
 Shared Memory: $sharedMemory MB
 Buffers/Cache: $buffersCache MB
 Available: $availableMemory MB
 ======================================================
"@
        }
        Elseif ($Platform -eq 'Windows') {
            # Retrieve memory information in GB or MB
            $memoryInfo = Get-CimInstance Win32_OperatingSystem | Select-Object @{Name = "FreePhysicalMemory"; Expression = {
                    if ($_.FreePhysicalMemory -ge 1GB) {
                        "$([math]::Round($_.FreePhysicalMemory / 1GB, 2)) MB"
                    }
                    elseif ($_.FreePhysicalMemory -ge 1MB) {
                        "$([math]::Round($_.FreePhysicalMemory / 1MB, 2)) GB"
                    }
                    else {
                        "$($_.FreePhysicalMemory)"
                    } }
            },
            @{Name = "TotalVisibleMemorySize"; Expression = {
                    if ($_.TotalVisibleMemorySize -ge 1GB) {
                        "$([math]::Round($_.TotalVisibleMemorySize / 1GB, 2)) MB"
                    }
                    elseif ($_.TotalVisibleMemorySize -ge 1MB) {
                        "$([math]::Round($_.TotalVisibleMemorySize / 1MB, 2)) GB"
                    }
                    else {
                        "$($_.TotalVisibleMemorySize)"
                    }
                }
            },
            @{Name = "UsedMemory"; Expression = {
                    $totalMemory = $_.TotalVisibleMemorySize
                    $freeMemory = $_.FreePhysicalMemory
                    $usedMemory = $totalMemory - $freeMemory

                    if ($usedMemory -ge 1GB) {
                        "$([math]::Round($usedMemory / 1GB, 2)) MB"
                    }
                    elseif ($usedMemory -ge 1MB) {
                        "$([math]::Round($usedMemory / 1MB, 2)) GB"
                    }
                    else {
                        $usedMemory
                    }
                }
            }
            $totalMemory = $memoryInfo.TotalVisibleMemorySize
            $usedMemory = $memoryInfo.UsedMemory
            $freeMemory = $memoryInfo.FreePhysicalMemory
            $OSVersion = (Get-WmiObject -class Win32_OperatingSystem).Caption
            $Header = @"
======================================================
  _____          _            _
 |  __ \        | |          (_)
 | |__) |__  ___| |_ ___ _ __ _ ______ _ _ __ _ __
 |  ___/ _ \/ __| __/ _ \ '__| |_  / _``` | '__| '__|
 | |  | (_) \__ \ ||  __/ |  | |/ / (_| | |  | |
 |_|   \___/|___/\__\___|_|  |_/___\__,_|_|  |_|

 Current Version: $CurrentScriptVersion
 Latest Version: $LatestScriptVersion
 Platform: $Platform
 OS Version: $OSVersion
 Branch: $Branch

 CPU Model: $cpuModel

 Total Memory: $totalMemory
 Used Memory: $usedMemory
 Free Memory: $freeMemory
 ======================================================
"@
        }
        Else {
            $Header = @"
======================================================
  _____          _            _
 |  __ \        | |          (_)
 | |__) |__  ___| |_ ___ _ __ _ ______ _ _ __ _ __
 |  ___/ _ \/ __| __/ _ \ '__| |_  / _``` | '__| '__|
 | |  | (_) \__ \ ||  __/ |  | |/ / (_| | |  | |
 |_|   \___/|___/\__\___|_|  |_/___\__,_|_|  |_|

 Current Version: $CurrentScriptVersion
 Latest Version: $LatestScriptVersion
 Platform: $Platform
 Branch: $Branch
 CPU Model: $cpuModel
 ======================================================
"@
        }
        Write-Host $Header
        $Header | Out-File $Path -Append
        $global:HeaderWritten = $true
    }
    if ($theLog -le $global:logLevel) {
        $Timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        $PaddedType = "[" + $log + "]"
        $PaddedType = $PaddedType.PadRight(10)
        $Linenumber = "L" + "." + "$($MyInvocation.ScriptLineNumber)"
        if ($Linenumber.Length -eq '4') {
            $Linenumber = $Linenumber + "   "
        }
        if ($Linenumber.Length -eq '5') {
            $Linenumber = $Linenumber + "  "
        }
        if ($Linenumber.Length -eq '6') {
            $Linenumber = $Linenumber + " "
        }
        $TypeFormatted = "[{0}] {1}|{2}" -f $Timestamp, $PaddedType.ToUpper(), $Linenumber

        if ($Message) {
            $FormattedLine1 = "{0}| {1}" -f ($TypeFormatted, $Message)
            $FormattedLineWritehost = "{0}| " -f ($TypeFormatted)
        }

        if ($Subtext) {
            $FormattedLine = "{0}|      {1}" -f ($TypeFormatted, $Subtext)
            $FormattedLineWritehost = "{0}|      " -f ($TypeFormatted)
            Write-Host $FormattedLineWritehost -NoNewline
            Write-Host $Subtext -ForegroundColor $Color
            $FormattedLine | Out-File $Path -Append
        }
        else {

            Write-Host $FormattedLineWritehost -NoNewline
            Write-Host $Message -ForegroundColor $Color
            $FormattedLine1 | Out-File $Path -Append
        }
    }
}
function SendMessage {
    param(
        [string]$type,
        [string]$title,
        [string]$Lib,
        [string]$DLSource,
        [string]$lang,
        [string]$favurl,
        [string]$fallback,
        [string]$truncated
    )
    if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
        if ($global:NotifyUrl -like '*discord*') {
            if ($SkipTBA -eq 'true' -or $SkipJapTitle -eq 'true') {
                $jsonPayload = @"
    {
        "username": "$global:DiscordUserName",
        "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
        "content": "",
        "embeds": [
        {
            "author": {
            "name": "Posterizarr @Github",
            "url": "https://github.com/fscorrupt/Posterizarr"
            },
            "description": "Recently Added\n\n",
            "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
            "color": $(if ($errorCount -ge '1') {16711680}Elseif ($global:IsFallback -eq 'true' -or $global:IsTruncated -eq 'true'){15120384}Else{5763719}),
            "fields": [
            {
                "name": "",
                "value": ":bar_chart:",
                "inline": false
            },
            {
                "name": "Type",
                "value": "$type",
                "inline": false
            },
            {
                "name": "Fallback",
                "value": "$fallback",
                "inline": true
            },
            {
                "name": "Language",
                "value": "$lang",
                "inline": true
            },
            {
                "name": "Truncated",
                "value": "$truncated",
                "inline": true
            },
            {
                "name": "TBA Skipped",
                "value": "$SkipTBACount",
                "inline": true
            },
            {
                "name": "Jap/Chinese Skipped",
                "value": "$SkipJapTitleCount",
                "inline": true
            },
            {
                "name": "",
                "value": ":frame_photo:",
                "inline": false
            },
            {
                "name": "Title",
                "value": "$title",
                "inline": false
            },
            {
                "name": "Library",
                "value": "$Lib",
                "inline": true
            },
            {
                "name": "Fav Url",
                "value": "$favurl",
                "inline": true
            }
            ],
            "thumbnail": {
                "url": "$DLSource"
            },
            "footer": {
                "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
            }

        }
        ]
    }
"@
            }
            Else {
                $jsonPayload = @"
    {
        "username": "$global:DiscordUserName",
        "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
        "content": "",
        "embeds": [
        {
            "author": {
            "name": "Posterizarr @Github",
            "url": "https://github.com/fscorrupt/Posterizarr"
            },
            "description": "Recently Added\n\n",
            "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
            "color": $(if ($errorCount -ge '1') {16711680}Elseif ($global:IsFallback -eq 'true' -or $global:IsTruncated -eq 'true'){15120384}Else{5763719}),
            "fields": [
            {
                "name": "",
                "value": ":bar_chart:",
                "inline": false
            },
            {
                "name": "Type",
                "value": "$type",
                "inline": false
            },
            {
                "name": "Fallback",
                "value": "$fallback",
                "inline": true
            },
            {
                "name": "Language",
                "value": "$lang",
                "inline": true
            },
            {
                "name": "Truncated",
                "value": "$truncated",
                "inline": true
            },
            {
                "name": "",
                "value": ":frame_photo:",
                "inline": false
            },
            {
                "name": "Title",
                "value": "$title",
                "inline": false
            },
            {
                "name": "Library",
                "value": "$Lib",
                "inline": true
            },
            {
                "name": "Fav Url",
                "value": "$favurl",
                "inline": true
            }
            ],
            "thumbnail": {
                "url": "$DLSource"
            },
            "footer": {
                "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
            }

        }
        ]
    }
"@
            }
            $global:NotifyUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
            if ($global:SendNotification -eq 'true') {
                Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
            }
        }
        Else {
            if ($global:SendNotification -eq 'true') {
                if ($errorCount -ge '1') {
                    apprise --notification-type="failure" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images`n`nDuring execution '$errorCount' Errors occurred, please check log for detailed description." "$global:NotifyUrl"
                }
                Else {
                    apprise --notification-type="success" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images" "$global:NotifyUrl"
                }
            }
        }
    }
    if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -notlike 'PSDocker*') {
        if ($SkipTBA -eq 'true' -or $SkipJapTitle -eq 'true') {
            $jsonPayload = @"
    {
        "username": "$global:DiscordUserName",
        "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
        "content": "",
        "embeds": [
        {
            "author": {
            "name": "Posterizarr @Github",
            "url": "https://github.com/fscorrupt/Posterizarr"
            },
            "description": "Recently Added\n\n",
            "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
            "color": $(if ($errorCount -ge '1') {16711680}Elseif ($global:IsFallback -eq 'true' -or $global:IsTruncated -eq 'true'){15120384}Else{5763719}),
            "fields": [
            {
                "name": "",
                "value": ":bar_chart:",
                "inline": false
            },
            {
                "name": "Type",
                "value": "$type",
                "inline": false
            },
            {
                "name": "Fallback",
                "value": "$fallback",
                "inline": true
            },
            {
                "name": "Language",
                "value": "$lang",
                "inline": true
            },
            {
                "name": "Truncated",
                "value": "$truncated",
                "inline": true
            },
            {
                "name": "TBA Skipped",
                "value": "$SkipTBACount",
                "inline": true
            },
            {
                "name": "Jap/Chinese Skipped",
                "value": "$SkipJapTitleCount",
                "inline": true
            },
            {
                "name": "",
                "value": ":frame_photo:",
                "inline": false
            },
            {
                "name": "Title",
                "value": "$title",
                "inline": false
            },
            {
                "name": "Library",
                "value": "$Lib",
                "inline": true
            },
            {
                "name": "Fav Url",
                "value": "$favurl",
                "inline": true
            }
            ],
            "thumbnail": {
                "url": "$DLSource"
            },
            "footer": {
                "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
            }

        }
        ]
    }
"@
        }
        Else {
            jsonPayload = @"
    {
        "username": "$global:DiscordUserName",
        "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
        "content": "",
        "embeds": [
        {
            "author": {
            "name": "Posterizarr @Github",
            "url": "https://github.com/fscorrupt/Posterizarr"
            },
            "description": "Recently Added\n\n",
            "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
            "color": $(if ($errorCount -ge '1') {16711680}Elseif ($global:IsFallback -eq 'true' -or $global:IsTruncated -eq 'true'){15120384}Else{5763719}),
            "fields": [
            {
                "name": "",
                "value": ":bar_chart:",
                "inline": false
            },
            {
                "name": "Type",
                "value": "$type",
                "inline": false
            },
            {
                "name": "Fallback",
                "value": "$fallback",
                "inline": true
            },
            {
                "name": "Language",
                "value": "$lang",
                "inline": true
            },
            {
                "name": "Truncated",
                "value": "$truncated",
                "inline": true
            },
            {
                "name": "",
                "value": ":frame_photo:",
                "inline": false
            },
            {
                "name": "Title",
                "value": "$title",
                "inline": false
            },
            {
                "name": "Library",
                "value": "$Lib",
                "inline": true
            },
            {
                "name": "Fav Url",
                "value": "$favurl",
                "inline": true
            }
            ],
            "thumbnail": {
                "url": "$DLSource"
            },
            "footer": {
                "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
            }

        }
        ]
    }
"@
        }
        if ($global:SendNotification -eq 'true') {
            Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
        }
    }
}
function AddTrailingSlash($path) {
    if (-not ($path -match '[\\/]$')) {
        $path += if ($path -match '\\') { '\' } else { '/' }
    }
    return $path
}
function RemoveTrailingSlash($path) {
    if ($path -match '[\\/]$') {
        $path = $path.TrimEnd('\', '/')
    }
    return $path
}
function Get-OptimalPointSize {
    param(
        [string]$text,
        [string]$fontImagemagick,
        [int]$box_width,
        [int]$box_height,
        [int]$min_pointsize,
        [int]$max_pointsize,
        [int]$lineSpacing  # New parameter for line height
    )
    $global:IsTruncated = $null

    # Construct the command with interline spacing and font option
    $cmd = "& `"$magick`" -size ${box_width}x${box_height} -font `"$fontImagemagick`" -gravity center -fill black -interline-spacing ${lineSpacing} caption:`"$text`" -format `"%[caption:pointsize]`" info:"

    # Log the command for debugging purposes
    $cmd | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

    # Execute the command and get the current point size
    $current_pointsize = [int](Invoke-Expression $cmd | Out-String).Trim()

    # Apply point size limits
    if ($current_pointsize -gt $max_pointsize) {
        $current_pointsize = $max_pointsize
    }
    elseif ($current_pointsize -lt $min_pointsize) {
        Write-Entry -Subtext "Text truncated! optimalFontSize: $current_pointsize below min_pointsize: $min_pointsize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        $global:IsTruncated = $true
        $current_pointsize = $min_pointsize
    }

    # Return optimal point size
    return $current_pointsize
}
function GetTMDBMoviePoster {
    Write-Entry -Subtext "Searching on TMDB for a movie poster - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:PreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
            $errorCount++
        }
        if ($response) {
            if ($response.images.posters) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.images.posters | Where-Object iso_639_1 -eq $null)
                }
                if (!$NoLangPoster) {
                    Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:OnlyTextless -eq $false) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.posters

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.posters

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.posters

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                }
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($global:FavProvider -eq 'TMDB') {
                                $global:Fallback = "fanart"
                                $global:tmdbfallbackposterurl = $global:posterurl
                            }
                            Write-Entry -Subtext "Found Poster with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $global:TMDBAssetTextLang = $response.images.posters[0].iso_639_1
                            }
                            Else {
                                $global:TMDBAssetTextLang = (($response.images.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                        }
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                        return $global:posterurl
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.posters | Where-Object iso_639_1 -eq $null
                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                            }

                        }
                        Else {
                            $filteredPosters = $response.images.posters | Where-Object iso_639_1 -eq $null

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            }
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                        return $global:posterurl
                    }
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
        }
    }
    Else {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=$($PreferredLanguageOrder[0])&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
            $errorCount++
        }
        if ($response) {
            if ($response.images.posters) {
                foreach ($lang in $global:PreferredLanguageOrderTMDB) {
                    if ($lang -eq 'null') {
                        if ($global:WidthHeightFilter -eq 'true') {
                            $FavPoster = ($response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.posters | Where-Object iso_639_1 -eq $null)
                        }
                    }
                    Else {
                        if ($global:WidthHeightFilter -eq 'true') {
                            $FavPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.posters | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null') {
                            Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                        }
                        return $global:posterurl
                        continue
                    }
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
        }
    }
}
function GetTMDBMovieBackground {
    Write-Entry -Subtext "Searching on TMDB for a movie background - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:BackgroundPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
            $errorCount++
        }
        if ($response) {
            if ($response.images.backdrops) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $null)
                }
                if (!$NoLangPoster) {
                    Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:BackgroundOnlyTextless -eq $false) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $response.images.backdrops[0].file_path
                            }
                            Else {
                                $posterpath = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($global:FavProvider -eq 'TMDB') {
                                $global:Fallback = "fanart"
                                $global:tmdbfallbackposterurl = $global:posterurl
                            }
                            Write-Entry -Subtext "Found background with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $global:TMDBAssetTextLang = $response.images.backdrops[0].iso_639_1
                            }
                            Else {
                                $global:TMDBAssetTextLang = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                            return $global:posterurl
                        }
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = (($response.images.backdrops | Where-Object iso_639_1 -eq $null)[0]).file_path
                        }
                        Else {
                            $posterpath = (($response.images.backdrops | Where-Object iso_639_1 -eq $null | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless background on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                        return $global:posterurl
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -eq 'TMDB') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
        }
    }
    Else {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=$($PreferredBackgroundLanguageOrder[0])&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
            $errorCount++
        }
        if ($response) {
            if ($response.images.backdrops) {
                foreach ($lang in $global:PreferredBackgroundLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null') {
                            $FavPoster = ($response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null') {
                            $FavPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $null)
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null') {
                            Write-Entry -Subtext "Found background without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found background with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                        }
                        return $global:posterurl
                        continue
                    }
                }
                if (!$global:posterurl -and $global:WidthHeightFilter -eq 'false') {
                    Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
                if (!$global:posterurl -and $global:WidthHeightFilter -eq 'true') {
                    Write-Entry -Subtext "No Background found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -ne 'fanart') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
        }
    }
}
function GetTMDBShowPoster {
    Write-Entry -Subtext "Searching on TMDB for a show poster - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        $global:tmdbsearched = $true
    }
    Else {
        if ($global:PreferTextless -eq $true) {
            try {
                $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
            catch {
                Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                $errorCount++
            }
            if ($response) {
                if ($response.images.posters) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangPoster = ($response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                    }
                    Else {
                        $NoLangPoster = ($response.images.posters | Where-Object iso_639_1 -eq $null)
                    }
                    if (!$NoLangPoster) {
                        Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:OnlyTextless -eq $false) {
                            if ($global:WidthHeightFilter -eq 'true') {
                                if ($global:TMDBVoteSorting -eq 'primary') {
                                    $filteredPosters = $response.images.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                    if ($filteredPosters) {
                                        $posterpath = $filteredPosters[0].file_path
                                        $global:TMDBAssetTextLang = $filteredPosters[0].iso_639_1
                                        Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                }
                                Else {
                                    $filteredPosters = $response.images.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                    if ($filteredPosters) {
                                        $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                        $global:TMDBAssetTextLang = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                        Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                }
                            }
                            Else {
                                if ($global:TMDBVoteSorting -eq 'primary') {
                                    $posterpath = $response.images.posters[0].file_path
                                    $global:TMDBAssetTextLang = $response.images.posters[0].iso_639_1
                                }
                                Else {
                                    $posterpath = (($response.images.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    $global:TMDBAssetTextLang = (($response.images.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                }
                            }
                            if ($posterpath) {
                                $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                                if ($global:FavProvider -ne 'fanart') {
                                    $global:Fallback = "fanart"
                                    $global:tmdbfallbackposterurl = $global:posterurl
                                }
                                Write-Entry -Subtext "Found Poster with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:PosterWithText = $true

                                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                                return $global:posterurl
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                        }
                    }
                    Else {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = ($response.images.posters | Where-Object iso_639_1 -eq $null)
                                if ($posterpath) {
                                    $posterpath = $posterpath[0].file_path
                                }
                            }
                            Else {
                                $posterpath = ($response.images.posters | Where-Object iso_639_1 -eq $null | Sort-Object $global:TMDBVoteSorting -Descending)
                                if ($posterpath) {
                                    $posterpath = $posterpath[0].file_path
                                }
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            Write-Entry -Subtext "Found Textless Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                            return $global:posterurl
                        }
                    }
                    $global:tmdbsearched = $true
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                $global:tmdbsearched = $true
            }
        }
        Else {
            try {
                $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=$($PreferredLanguageOrder[0])&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
            catch {
                Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                $errorCount++
            }
            if ($response) {
                if ($response.images.posters) {
                    foreach ($lang in $global:PreferredLanguageOrderTMDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $FavPoster = ($response.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            }
                            Else {
                                $FavPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $FavPoster = ($response.images.posters | Where-Object iso_639_1 -eq $null)
                            }
                            Else {
                                $FavPoster = ($response.images.posters | Where-Object iso_639_1 -eq $lang)
                            }
                        }
                        if ($FavPoster) {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $FavPoster[0].file_path
                            }
                            Else {
                                $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            }
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TMDBAssetTextLang = $lang
                                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                            }
                            return $global:posterurl
                            continue
                        }
                        $global:tmdbsearched = $true
                    }
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                $global:tmdbsearched = $true
            }
        }
    }
}
function GetTMDBSeasonPoster {
    Write-Entry -Subtext "Searching on TMDB for Season '$global:SeasonNumber' poster - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:SeasonPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)/season/$global:SeasonNumber/images?append_to_response=images&language=xx&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
            $errorCount++
        }
        if ($response) {
            if ($response.posters) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.posters | Where-Object iso_639_1 -eq $null)
                }
                Write-Entry -Subtext "NoLangPoster: $NoLangPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                if (!$NoLangPoster) {
                    if (!$global:SeasonOnlyTextless) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.poster | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    $global:TMDBAssetTextLang = $filteredPosters[0].iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    $global:TMDBAssetTextLang = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $response.posters[0].file_path
                                $global:TMDBAssetTextLang = $response.posters[0].iso_639_1
                            }
                            Else {
                                $posterpath = (($response.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                $global:TMDBAssetTextLang = (($response.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            Write-Entry -Subtext "Found Season Poster with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                            $global:TMDBSeasonFallback = $global:posterurl
                            Write-Entry -Subtext "Posterpath: $posterpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterUrl: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TMDBAssetTextLang: $global:TMDBAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TMDBAssetChangeUrl: $global:TMDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TMDBSeasonFallback: $global:TMDBSeasonFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            return $global:posterurl
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Found Season Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = (($response.posters | Where-Object iso_639_1 -eq $null)[0]).file_path
                        }
                        Else {
                            $posterpath = (($response.posters | Where-Object iso_639_1 -eq $null | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless Season Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                        Write-Entry -Subtext "Posterpath: $posterpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterUrl: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TextlessPoster: $global:TextlessPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TMDBAssetChangeUrl: $global:TMDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        return $global:posterurl
                    }
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
            }
        }
        Else {
            Write-Entry -Subtext "No Season Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
        }
    }
    Else {
        try {
            if ($global:SeasonNumber -match '\b\d{1,2}\b') {
                $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)/season/$global:SeasonNumber/images?append_to_response=images&language=$($global:PreferredSeasonLanguageOrder[0])&include_image_language=$($global:PreferredSeasonLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
            Else {
                $responseBackup = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=$($global:PreferredSeasonLanguageOrder[0])&include_image_language=$($global:PreferredSeasonLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
            $errorCount++
        }
        if ($responseBackup) {
            if ($responseBackup.images.posters) {
                Write-Entry -Subtext "Could not get a result with '$global:SeasonNumber' on TMDB, likely season number not in correct format, fallback to Show poster." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                foreach ($lang in $global:PreferredSeasonLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null') {
                            $FavPoster = ($responseBackup.images.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($responseBackup.images.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null') {
                            $FavPoster = ($responseBackup.images.posters | Where-Object iso_639_1 -eq $null)
                        }
                        Else {
                            $FavPoster = ($responseBackup.images.posters | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null') {
                            Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                        }
                        Write-Entry -Subtext "Posterpath: $posterpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterUrl: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TMDBAssetTextLang: $global:TMDBAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TMDBAssetChangeUrl: $global:TMDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        return $global:posterurl
                        continue
                    }
                }
            }
        }
        if ($response) {
            if ($response.posters) {
                foreach ($lang in $global:PreferredSeasonLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null') {
                            $FavPoster = ($response.posters | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null') {
                            $FavPoster = ($response.posters | Where-Object iso_639_1 -eq $null)
                        }
                        Else {
                            $FavPoster = ($response.posters | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null') {
                            Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                        }
                        return $global:posterurl
                        continue
                    }
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
            }
        }
        Else {
            Write-Entry -Subtext "No Season Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
        }

    }
}
function GetTMDBShowBackground {
    Write-Entry -Subtext "Searching on TMDB for a show background - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:BackgroundPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
            $errorCount++
        }
        if ($response) {
            if ($response.images.backdrops) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $null)
                }
                if (!$NoLangPoster) {
                    Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:BackgroundOnlyTextless -eq $false) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    $global:TMDBAssetTextLang = $filteredPosters[0].iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    $global:TMDBAssetTextLang = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $response.images.backdrops[0].file_path
                                $global:TMDBAssetTextLang = $response.images.backdrops[0].iso_639_1
                            }
                            Else {
                                $posterpath = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                $global:TMDBAssetTextLang = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($global:FavProvider -ne 'fanart') {

                                $global:Fallback = "fanart"
                                $global:tmdbfallbackposterurl = $global:posterurl
                            }
                            Write-Entry -Subtext "Found background with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                        }
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = (($response.images.backdrops | Where-Object iso_639_1 -eq $null)[0]).file_path
                        }
                        Else {
                            $posterpath = (($response.images.backdrops | Where-Object iso_639_1 -eq $null | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless background on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                        return $global:posterurl
                    }
                }
                if (!$global:posterurl) {
                    Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -ne 'fanart') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
        }
    }
    Else {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=$($PreferredBackgroundLanguageOrder[0])&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
            $errorCount++
        }
        if ($response) {
            if ($response.images.backdrops) {
                foreach ($lang in $global:PreferredBackgroundLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null') {
                            $FavPoster = ($response.images.backdrops | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null') {
                            $FavPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $null)
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null') {
                            Write-Entry -Subtext "Found background without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found background with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                        }
                        return $global:posterurl
                        continue
                    }
                }
                if (!$global:posterurl) {
                    Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -ne 'fanart') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
        }
    }
}
function GetTMDBTitleCard {
    Write-Entry -Subtext "Searching on TMDB for: $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    try {
        $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)/season/$($global:season_number)/episode/$($global:episodenumber)/images?append_to_response=images&language=xx&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
    }
    catch {
        Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
        $errorCount++
    }
    if ($response) {
        if ($response.stills) {
            $NoLangPoster = ($response.stills | Where-Object iso_639_1 -eq $null)
            if (!$NoLangPoster) {
                if ($global:WidthHeightFilter -eq 'true') {
                    if ($global:TMDBVoteSorting -eq 'primary') {
                        $filteredPosters = $response.stills | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                        if ($filteredPosters) {
                            $posterpath = $filteredPosters[0].file_path
                            Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        else {
                            Write-Entry -Subtext "No Titlecards found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                    }
                    Else {
                        $filteredPosters = $response.stills | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                        if ($filteredPosters) {
                            $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        else {
                            Write-Entry -Subtext "No Titlecards found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                    }
                }
                Else {
                    if ($global:TMDBVoteSorting -eq 'primary') {
                        $posterpath = $response.stills[0].file_path
                    }
                    Else {
                        $posterpath = (($response.stills | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                    }
                }
                if ($posterpath) {
                    $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                    Write-Entry -Subtext "Found Title Card with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                    $global:PosterWithText = $true
                    if ($global:TMDBVoteSorting -eq 'primary') {
                        $global:TMDBAssetTextLang = $response.stills[0].iso_639_1
                    }
                    Else {
                        $global:TMDBAssetTextLang = (($response.stills | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                    }
                }
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
                if ($posterurl) {
                    return $global:posterurl
                }
            }
            Else {
                if ($global:WidthHeightFilter -eq 'true') {
                    if ($global:TMDBVoteSorting -eq 'primary') {
                        $filteredPosters = $response.stills | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                        if ($filteredPosters) {
                            $posterpath = $filteredPosters[0].file_path
                            Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        else {
                            Write-Entry -Subtext "No Titlecards found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                    }
                    Else {
                        $filteredPosters = $response.stills | Where-Object { $null -eq $_.iso_639_1 -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                        if ($filteredPosters) {
                            $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        else {
                            Write-Entry -Subtext "No Titlecards found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                    }
                }
                Else {
                    if ($global:TMDBVoteSorting -eq 'primary') {
                        $posterpath = (($response.stills | Where-Object iso_639_1 -eq $null)[0]).file_path
                    }
                    Else {
                        $posterpath = (($response.stills | Where-Object iso_639_1 -eq $null | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                    }
                }
                if ($posterpath) {
                    $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                    Write-Entry -Subtext "Found Textless Title Card on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $global:TextlessPoster = $true
                    $global:PosterWithText = $null
                }
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
                if ($posterurl) {
                    return $global:posterurl
                }
            }
        }
        Else {
            Write-Entry -Subtext "No Title Card found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
            if ($global:FavProvider -ne 'TVDB') {
                $global:Fallback = "TVDB"
            }
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }
    Else {
        Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
        if ($global:FavProvider -ne 'TVDB') {
            $global:Fallback = "TVDB"
        }
        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        $errorCount++
    }
}
function GetFanartMoviePoster {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if ($global:PreferTextless -eq $true) {
        $ids = @($global:tmdbid, $global:imdbid)
        $entrytemp = $null

        foreach ($id in $ids) {
            if ($id) {
                $entrytemp = Get-FanartTv -Type movies -id $id -ErrorAction SilentlyContinue
                if ($entrytemp -and $entrytemp.movieposter) {
                    if (!($entrytemp.movieposter | Where-Object lang -eq '00')) {
                        Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:OnlyTextless -eq $false) {
                            $global:posterurl = ($entrytemp.movieposter)[0].url
                            Write-Entry -Subtext "Found Poster with text on Fanart.tv"  -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            $global:FANARTAssetTextLang = ($entrytemp.movieposter)[0].lang
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"

                            if ($global:FavProvider -eq 'FANART') {
                                $global:Fallback = "TMDB"
                                $global:fanartfallbackposterurl = ($entrytemp.movieposter)[0].url
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                        }
                        return $global:posterurl
                        continue
                    }
                    Else {
                        $global:posterurl = ($entrytemp.movieposter | Where-Object lang -eq '00')[0].url
                        Write-Entry -Subtext "Found Textless Poster on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                        return $global:posterurl
                        break
                    }
                }
            }
        }
        if ($null -eq $ids[0] -and $null -eq $ids[1]) {
            Write-Entry -Subtext "Cannot search on FANART, missing IDs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No movie match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Else {
            return $global:posterurl
        }
    }
    Else {
        $ids = @($global:tmdbid, $global:imdbid)
        $entrytemp = $null

        foreach ($id in $ids) {
            if ($id) {
                $entrytemp = Get-FanartTv -Type movies -id $id -ErrorAction SilentlyContinue
                if ($entrytemp -and $entrytemp.movieposter) {
                    foreach ($lang in $global:PreferredLanguageOrderFanart) {
                        if (($entrytemp.movieposter | Where-Object lang -eq "$lang")) {
                            $global:posterurl = ($entrytemp.movieposter)[0].url
                            if ($lang -eq '00') {
                                Write-Entry -Subtext "Found Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne '00') {
                                $global:PosterWithText = $true
                                $global:FANARTAssetTextLang = $lang
                            }
                            return $global:posterurl
                            continue
                        }
                    }
                }
            }
        }
        if ($null -eq $ids[0] -and $null -eq $ids[1]) {
            Write-Entry -Subtext "Cannot search on FANART, missing IDs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No movie match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Else {
            return $global:posterurl
        }
    }
}
function GetFanartMovieBackground {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a Background poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $ids = @($global:tmdbid, $global:imdbid)
    $entrytemp = $null

    foreach ($id in $ids) {
        if ($id) {
            $entrytemp = Get-FanartTv -Type movies -id $id -ErrorAction SilentlyContinue
            if ($entrytemp -and $entrytemp.moviebackground) {
                if (!($entrytemp.moviebackground | Where-Object lang -eq '')) {
                    Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:BackgroundOnlyTextless -eq $false) {
                        $global:posterurl = ($entrytemp.moviebackground)[0].url
                        Write-Entry -Subtext "Found Background with text on Fanart.tv"  -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:PosterWithText = $true
                        $global:FANARTAssetTextLang = ($entrytemp.moviebackground)[0].lang
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"

                        if ($global:FavProvider -eq 'FANART') {
                            $global:Fallback = "TMDB"
                            $global:fanartfallbackposterurl = ($entrytemp.moviebackground)[0].url
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Found Background with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                    }
                    return $global:posterurl
                    continue
                }
                Else {
                    $global:posterurl = ($entrytemp.moviebackground | Where-Object lang -eq '')[0].url
                    Write-Entry -Subtext "Found Textless background on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $global:TextlessPoster = $true
                    $global:PosterWithText = $null
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                    return $global:posterurl
                    continue
                }
            }
        }
    }
    if ($null -eq $ids[0] -and $null -eq $ids[1]) {
        Write-Entry -Subtext "Cannot search on FANART, missing IDs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if (!$global:posterurl) {
        Write-Entry -Subtext "No movie match or background found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        return $global:posterurl
    }

}
function GetFanartShowPoster {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a show poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if ($global:PreferTextless -eq $true) {
        $id = $global:tvdbid
        $entrytemp = $null
        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp -and $entrytemp.tvposter) {
                if (!($entrytemp.tvposter | Where-Object lang -eq '00')) {
                    Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:OnlyTextless -eq $false) {
                        $global:posterurl = ($entrytemp.tvposter)[0].url

                        Write-Entry -Subtext "Found Poster with text on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:PosterWithText = $true
                        $global:FANARTAssetTextLang = ($entrytemp.tvposter)[0].lang
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"

                        if ($global:FavProvider -eq 'FANART') {
                            $global:Fallback = "TMDB"
                            $global:fanartfallbackposterurl = ($entrytemp.tvposter)[0].url
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        if ($global:FavProvider -eq 'FANART') {
                            $global:Fallback = "TMDB"
                        }
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                    }
                    return $global:posterurl
                    continue
                }
                Else {
                    $global:posterurl = ($entrytemp.tvposter | Where-Object lang -eq '00')[0].url
                    Write-Entry -Subtext "Found Textless Poster on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $global:TextlessPoster = $true
                    $global:PosterWithText = $null
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                    return $global:posterurl
                    break
                }
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            if ($global:FavProvider -eq 'FANART') {
                $global:Fallback = "TMDB"
            }
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No show match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            if ($global:FavProvider -eq 'FANART') {
                $global:Fallback = "TMDB"
            }
        }
        Else {
            return $global:posterurl
        }
    }
    Else {
        $id = $global:tvdbid
        $entrytemp = $null

        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp -and $entrytemp.tvposter) {
                foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                    if (($entrytemp.tvposter | Where-Object lang -eq "$lang")) {
                        $global:posterurl = ($entrytemp.tvposter)[0].url
                        if ($lang -eq '00') {
                            Write-Entry -Subtext "Found Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne '00') {
                            $global:PosterWithText = $true
                            $global:FANARTAssetTextLang = $lang
                        }
                        return $global:posterurl
                        continue
                    }
                }
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No show match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            if ($global:FavProvider -eq 'FANART') {
                $global:Fallback = "TMDB"
            }
        }
        Else {
            return $global:posterurl
        }
    }
}
function GetFanartShowBackground {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a Background poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $id = $global:tvdbid
    $entrytemp = $null

    if ($id) {
        $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
        if ($entrytemp -and $entrytemp.showbackground) {
            if (!($entrytemp.showbackground | Where-Object lang -eq '')) {
                Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                if ($global:BackgroundOnlyTextless -eq $false) {
                    $global:posterurl = ($entrytemp.showbackground)[0].url
                    Write-Entry -Subtext "Found Background with text on Fanart.tv"  -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                    $global:PosterWithText = $true
                    $global:FANARTAssetTextLang = ($entrytemp.showbackground)[0].lang
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"

                    if ($global:FavProvider -eq 'FANART') {
                        $global:Fallback = "TMDB"
                        $global:fanartfallbackposterurl = ($entrytemp.showbackground)[0].url
                    }
                }
                Else {
                    Write-Entry -Subtext "Found Background with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                }
                return $global:posterurl
                continue
            }
            Else {
                $global:posterurl = ($entrytemp.showbackground | Where-Object lang -eq '')[0].url
                Write-Entry -Subtext "Found Textless background on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $global:TextlessPoster = $true
                $global:PosterWithText = $null
                $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                return $global:posterurl
                continue
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if (!$global:posterurl) {
        Write-Entry -Subtext "No show match or background found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        return $global:posterurl
    }

}
function GetFanartSeasonPoster {
    Write-Entry -Subtext "Searching on Fanart.tv for Season '$global:SeasonNumber' poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $id = $global:tvdbid
    $entrytemp = $null
    if ($global:SeasonPreferTextless -eq $true) {
        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp.seasonposter) {
                if ($global:SeasonNumber -match '\b\d{1,2}\b') {
                    $NoLangPoster = ($entrytemp.seasonposter | Where-Object { $_.lang -eq '00' -and $_.Season -eq $global:SeasonNumber } | Sort-Object likes)
                    if ($NoLangPoster) {
                        $global:posterurl = ($NoLangPoster | Sort-Object likes)[0].url
                        Write-Entry -Subtext "Found Season Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                        Write-Entry -Subtext "NoLangPoster: $NoLangPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterUrl: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TextlessPoster: $global:TextlessPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "FANARTAssetChangeUrl: $global:FANARTAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    }
                    Else {
                        if (!$global:SeasonOnlyTextless) {
                            Write-Entry -Subtext "No Texless Season Poster on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                                $FoundPoster = ($entrytemp.seasonposter | Where-Object { $_.lang -eq "$lang" -and $_.Season -eq $global:SeasonNumber } | Sort-Object likes)
                                if ($FoundPoster) {
                                    $global:posterurl = $FoundPoster[0].url
                                    Write-Entry -Subtext "Found season Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    $global:PosterWithText = $true
                                    $global:FANARTAssetTextLang = $lang
                                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                    $global:FANARTSeasonFallback = $global:posterurl
                                    Write-Entry -Subtext "FoundPoster: $FoundPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "PosterUrl: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "FANARTAssetTextLang: $global:FANARTAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "FANARTAssetChangeUrl: $global:FANARTAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    return $global:posterurl
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "Could not get a result with '$global:SeasonNumber' on Fanart, likely season number not in correct format, fallback to Show poster." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                    if ($entrytemp -and $entrytemp.tvposter) {
                        foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                            if (($entrytemp.tvposter | Where-Object lang -eq "$lang")) {
                                $global:posterurl = ($entrytemp.tvposter)[0].url
                                if ($lang -eq '00') {
                                    Write-Entry -Subtext "Found Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    $global:TextlessPoster = $true
                                    $global:PosterWithText = $null
                                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                }
                                Else {
                                    if (!$global:SeasonOnlyTextless) {
                                        Write-Entry -Subtext "Found Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                }
                                if (!$global:SeasonOnlyTextless -and !$global:TextlessPoster) {
                                    if ($lang -ne '00') {
                                        $global:PosterWithText = $true
                                        $global:FANARTAssetTextLang = $lang
                                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                        $global:FANARTSeasonFallback = $global:posterurl
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                    $global:posterurl = $null
                                }
                                return $global:posterurl
                            }
                        }
                    }
                }
            }
            Else {
                $global:posterurl = $null
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if ($global:posterurl) {
            Write-Entry -Subtext "Found season poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            return $global:posterurl
        }
        Else {
            if ($global:OnlyTextless -eq $true) {
                Write-Entry -Subtext "No Textless Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                Write-Entry -Subtext "No Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
        }
    }
    Else {
        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp.seasonposter) {
                foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                    $FoundPoster = ($entrytemp.seasonposter | Where-Object { $_.lang -eq "$lang" -and $_.Season -eq $global:SeasonNumber } | Sort-Object likes)
                    if ($FoundPoster) {
                        $global:posterurl = $FoundPoster[0].url
                    }
                    if ($global:posterurl) {
                        if ($lang -eq '00') {
                            Write-Entry -Subtext "Found season Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                        }
                        Else {
                            Write-Entry -Subtext "Found season Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            $global:FANARTAssetTextLang = $lang
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                            return $global:posterurl
                        }
                    }
                }
            }
            Else {
                $global:posterurl = $null
                return $global:posterurl
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if ($global:posterurl) {
            return $global:posterurl
        }
        Else {
            if ($global:OnlyTextless -eq $true) {
                Write-Entry -Subtext "No Textless Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                Write-Entry -Subtext "No Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
        }
    }
}
function GetTVDBMoviePoster {
    if ($global:tvdbid) {
        if ($global:PreferTextless -eq $true) {
            Write-Entry -Subtext "Searching on TVDB for a movie poster - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data.artworks) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        $global:posterurltmp = ($response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score)
                    }
                    Else {
                        $global:posterurltmp = ($response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '14' } | Sort-Object Score)
                    }
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                    if ($global:posterurltmp) {
                        $global:posterurl = $global:posterurltmp[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $($global:posterurltmp[0].width) | height: $($global:posterurltmp[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless Poster on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        return $global:posterurl
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:OnlyTextless -eq $false) {
                            foreach ($lang in $global:PreferredLanguageOrderTVDB) {
                                if ($global:WidthHeightFilter -eq 'true') {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score)
                                    }
                                }
                                Else {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' } | Sort-Object Score)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' } | Sort-Object Score)
                                    }
                                }
                                if ($LangArtwork) {
                                    $global:posterurl = $LangArtwork[0].image
                                    if ($global:WidthHeightFilter -eq 'true') {
                                        Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($lang -eq 'null') {
                                        Write-Entry -Subtext "Found Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Found Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                    if ($lang -ne 'null') {
                                        $global:PosterWithText = $true
                                        $global:TVDBAssetTextLang = $lang
                                    }
                                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                                    return $global:posterurl
                                    continue
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "No Textless Poster on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
        Else {
            Write-Entry -Subtext "Searching on TVDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data.artworks) {
                    foreach ($lang in $global:PreferredLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' } | Sort-Object Score)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' } | Sort-Object Score)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                            return $global:posterurl
                            continue
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBMovieBackground {
    if ($global:tvdbid) {
        if ($global:BackgroundPreferTextless -eq $true) {
            Write-Entry -Subtext "Searching on TVDB for a movie Background - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data.artworks) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangArtwork = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }
                    }
                    Else {
                        $NoLangArtwork = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '15' }
                    }
                    if ($NoLangArtwork) {
                        $global:posterurl = ($NoLangArtwork | Sort-Object Score)[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $(($NoLangArtwork | Sort-Object Score)[0].width) | height: $(($NoLangArtwork | Sort-Object Score)[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless Background on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                        return $global:posterurl
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:BackgroundOnlyTextless -eq $false) {
                            # Trying other languages
                            foreach ($lang in $global:PreferredBackgroundLanguageOrderTVDB) {
                                if ($global:WidthHeightFilter -eq 'true') {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score)
                                    }
                                }
                                Else {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' } | Sort-Object Score)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' } | Sort-Object Score)
                                    }
                                }
                                if ($LangArtwork) {
                                    $global:posterurl = $LangArtwork[0].image
                                    if ($global:WidthHeightFilter -eq 'true') {
                                        Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($lang -eq 'null') {
                                        Write-Entry -Subtext "Found Background without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Found Background with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                    if ($lang -ne 'null') {
                                        $global:PosterWithText = $true
                                        $global:TVDBAssetTextLang = $lang
                                    }
                                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                                    return $global:posterurl
                                    continue
                                }
                            }
                            if (!$global:posterurl) {
                                Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found background with text on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
        Else {
            Write-Entry -Subtext "Searching on TVDB for a movie Background" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data.artworks) {
                    foreach ($lang in $global:PreferredBackgroundLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' } | Sort-Object Score)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' } | Sort-Object Score)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Background without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found Background with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                            return $global:posterurl
                            continue
                        }
                    }
                    if (!$global:posterurl) {
                        Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                    }
                }
                Else {
                    Write-Entry -Subtext "No Background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBShowPoster {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for a poster - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        if ($global:PreferTextless -eq $true) {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data) {
                    $defaultImageurl = $response.data.image
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '2' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }
                    }
                    Else {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '2' }
                    }
                    if ($NoLangImageUrl) {
                        $global:posterurl = $NoLangImageUrl[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $($NoLangImageUrl[0].width) | height: $($NoLangImageUrl[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless Poster on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:OnlyTextless -eq $false) {
                            $global:posterurl = $defaultImageurl
                            Write-Entry -Subtext "Found Poster with text on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                            if ($global:FavProvider -ne 'TVDB') {
                                if (!$global:tmdbsearched) {
                                    $global:Fallback = "TMDB"
                                }
                                $global:TVDBfallbackposterurl = $global:posterurl
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                        }
                    }
                    return $global:posterurl
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
            }
        }
        Else {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data) {
                    foreach ($lang in $global:PreferredLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '2' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '2' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '2' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '2' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                            return $global:posterurl
                            continue
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBSeasonPoster {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for a Season poster - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        try {
            $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
        }
        catch {
            Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
        if ($response) {
            if ($response.data.seasons) {
                # Select season id from current Seasonnumber
                $SeasonID = $response.data.seasons | Where-Object { $_.number -eq $global:SeasonNumber -and $_.type.type -eq 'official' }
                if (!$SeasonID) {
                    $SeasonID = $response.data.seasons | Where-Object { $_.number -eq $global:SeasonNumber -and $_.type.type -eq 'alternate' }
                }
                try {
                    $Seasonresponse = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/seasons/$($SeasonID.id)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
                }
                catch {
                    Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    $errorCount++
                }
                if ($Seasonresponse) {
                    foreach ($lang in $global:PreferredSeasonLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($Seasonresponse.data.artwork | Where-Object { $_.language -like "" -and $_.type -eq '7' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($Seasonresponse.data.artwork  | Where-Object { $_.language -like "$lang*" -and $_.type -eq '7' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($Seasonresponse.data.artwork | Where-Object { $_.language -like "" -and $_.type -eq '7' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($Seasonresponse.data.artwork  | Where-Object { $_.language -like "$lang*" -and $_.type -eq '7' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Season Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:TextlessPoster = $true
                                $global:PosterWithText = $null
                            }
                            Else {
                                Write-Entry -Subtext "Found Season Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            if (!$global:SeasonOnlyTextless -and !$global:TextlessPoster) {
                                $global:TVDBSeasonFallback = $global:posterurl
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/seasons/$($Seasonresponse.data.type.type)/$global:SeasonNumber#artwork"
                            Write-Entry -Subtext "LangArtwork: $LangArtwork" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterUrl: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TextlessPoster: $global:TextlessPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TVDBAssetTextLang: $global:TVDBAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TVDBAssetChangeUrl: $global:TVDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if ($global:SeasonOnlyTextless -and $global:PosterWithText) {
                                continue
                            }
                            Else {
                                return $global:posterurl
                            }
                            continue
                        }
                    }
                    if (!$global:posterurl -and $global:OnlyTextless -eq $true) {
                        Write-Entry -Subtext "No Textless Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    }
                    Else {
                        Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    }
                }
                return $global:posterurl
            }
            Else {
                Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/seasons/$($Seasonresponse.data.type.type)/$global:SeasonNumber#artwork"
            }
        }
        Else {
            Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/seasons/$($Seasonresponse.data.type.type)/$global:SeasonNumber#artwork"
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBShowBackground {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for a background - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        if ($global:BackgroundPreferTextless -eq $true) {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data) {
                    $defaultImageurltemp = $response.data.artworks | Where-Object {$_.type -eq '3' }
                    if ($defaultImageurltemp) {
                        $defaultImageurl = $defaultImageurltemp[0].image
                    }
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $_.language -eq $null -and $_.type -eq '3' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }
                    }
                    Else {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $_.language -eq $null -and $_.type -eq '3' }
                    }
                    if ($NoLangImageUrl) {
                        $global:posterurl = $NoLangImageUrl[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $($NoLangImageUrl[0].width) | height: $($NoLangImageUrl[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless background on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:BackgroundOnlyTextless -eq $false) {
                            $global:posterurl = $defaultImageurl
                            Write-Entry -Subtext "Found background with text on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                        }
                    }
                    return $global:posterurl
                }
                Else {
                    Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
            }
        }
        Else {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
            if ($response) {
                if ($response.data) {
                    foreach ($lang in $global:PreferredBackgroundLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '3' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '3' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '3' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '3' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found background without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found background with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"

                            return $global:posterurl
                            continue
                        }
                    }
                    if (!$global:posterurl) {
                        Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                    }
                }
                Else {
                    Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBTitleCard {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for: $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        $allEpisodes = @()
        $page = 0

        do {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/episodes/default?page=$page" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
                $episodes = $response.data.episodes
                $seriesData = $response.data

                if ($episodes) {
                    $allEpisodes += $seriesData
                    $page++
                }
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
                break
            }
        } while ($episodes -and $episodes.Count -gt 0)

        # Now $allEpisodes contains all the episodes retrieved from the API

        if ($response) {
            if ($allEpisodes.episodes) {
                $global:NoLangImageUrl = $allEpisodes.episodes | Where-Object { $_.seasonNumber -eq $global:season_number -and $_.number -eq $global:episodenumber }
                if ($global:NoLangImageUrl.image) {
                    $global:posterurl = $global:NoLangImageUrl.image
                    Write-Entry -Subtext "Found Title Card on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                    $global:TextlessPoster = $true
                    $global:PosterWithText = $null
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($allEpisodes.series.slug)/episodes/$($global:NoLangImageUrl.id)"

                    return $global:NoLangImageUrl.image
                }
                Else {
                    Write-Entry -Subtext "No Title Card found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($allEpisodes.slug)/#artwork"
                    $errorCount++
                }
            }
            Else {
                Write-Entry -Subtext "No Title Card found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($allEpisodes.slug)/#artwork"
                $errorCount++
            }
        }
        Else {
            Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
            $errorCount++
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetIMDBPoster {
    $response = Invoke-WebRequest -Uri "https://www.imdb.com/title/$($global:imdbid)/mediaviewer" -Method GET
    $global:posterurl = $response.images.src[1]
    if (!$global:posterurl) {
        Write-Entry -Subtext "No show match or poster found on IMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        Write-Entry -Subtext "Found Poster with text on IMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
        return $global:posterurl
    }
}
function GetPlexArtwork {
    param(
        [string]$Type,
        [string]$ArtUrl,
        [string]$TempImage
    )

    Write-Entry -Subtext "Searching on Plex for $Type" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    try {
        Invoke-WebRequest -Uri $ArtUrl -OutFile $TempImage -Headers $extraPlexHeaders
    }
    catch {
        Write-Entry -Subtext "Could not download Artwork from plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        $errorCount++
        continue
    }

    $magickcommand = "& `"$magick`" identify -verbose `"$TempImage`""
    $magickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

    # Execute command and get exif data
    $value = (Invoke-Expression $magickcommand | Select-String -Pattern 'overlay|titlecard|created with ppm|created with posterizarr')

    if ($value) {
        $ExifFound = $True
        if ($global:UploadExistingAssets -eq 'true') {
            Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, skip upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Else {
            Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, cant take it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Remove-Item -LiteralPath $TempImage | out-null
    }
    Else {
        Write-Entry -Subtext "No posterizarr/kometa/tcm exif data found, taking Plex artwork..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        $global:PlexartworkDownloaded = $true
        $global:posterurl = $ArtUrl
    }
}
function Push-ObjectToDiscord {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [string]$strDiscordWebhook,

        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [object]$objPayload
    )
    try {
        $null = Invoke-RestMethod -Method Post -Uri $strDiscordWebhook -Body $objPayload -ContentType 'Application/Json'
        Start-Sleep -Seconds 1
    }
    catch {
        Write-Entry -Message "Unable to send to Discord. $($_)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Write-Entry -Message "$objPayload" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
}
function CheckJson {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [string]$jsonExampleUrl,

        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [object]$jsonFilePath
    )
    try {
        $AttributeChanged = $null
        # Download the default configuration JSON file from the URL
        $defaultConfig = Invoke-RestMethod -Uri $jsonExampleUrl -Method Get -ErrorAction Stop

        # Read the existing configuration file if it exists
        if (Test-Path $jsonFilePath) {
            try {
                $config = Get-Content -Path $jsonFilePath -Raw | ConvertFrom-Json
            }
            catch {
                Write-Entry -Message "Failed to read the existing configuration file: $jsonFilePath. Please ensure it is valid JSON. Aborting..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Failed to read the existing configuration file."
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Failed to read config"
                }
                Exit
            }
        }
        else {
            $config = @{}
        }

        # Remove keys from config that are no longer in the default config
        foreach ($existingKey in $config.PSObject.Properties.Name) {
            if (-not $defaultConfig.PSObject.Properties.Name.Contains($existingKey)) {
                Write-Entry -Message "Removing obsolete Main Attribute from your Config file: $existingKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $config.PSObject.Properties.Remove($existingKey)
                $AttributeChanged = $True
            }
        }

        # Remove sub-attributes no longer in the default config
        foreach ($partKey in $config.PSObject.Properties.Name) {
            if ($defaultConfig.PSObject.Properties.Name.Contains($partKey)) {
                # Check each sub-attribute in the part
                foreach ($existingSubKey in $config.$partKey.PSObject.Properties.Name) {
                    if (-not $defaultConfig.$partKey.PSObject.Properties.Name.Contains($existingSubKey)) {
                        Write-Entry -Message "Removing obsolete Sub-Attribute from your Config file: $partKey.$existingSubKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        $config.$partKey.PSObject.Properties.Remove($existingSubKey)
                        $AttributeChanged = $True
                    }
                }
            }
        }

        # Check and add missing keys from the default configuration
        foreach ($partKey in $defaultConfig.PSObject.Properties.Name) {
            # Check if the part exists in the current configuration
            if (-not $config.PSObject.Properties.Name.Contains($partKey)) {
                if (-not $config.PSObject.Properties.Name.tolower().Contains($partKey.tolower())) {
                    # Add "SeasonPosterOverlayPart" if it's missing in $config
                    if (-not $config.PSObject.Properties.Name.tolower().Contains("seasonposteroverlaypart")) {
                        $config | Add-Member -MemberType NoteProperty -Name "SeasonPosterOverlayPart" -Value $defaultConfig.PosterOverlayPart
                        Write-Entry -Message "Missing Main Attribute in your Config file: $partKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        Write-Entry -Subtext "I will copy all settings from 'PosterOverlayPart'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        Write-Entry -Subtext "Adding it for you... In GH Readme, look for $partKey - if you want to see what changed..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        Write-Entry -Subtext "GH Readme -> https://github.com/fscorrupt/Posterizarr/blob/$($Branch)/README.md#configuration" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        # Convert the updated configuration object back to JSON and save it, then reload it
                        $configJson = $config | ConvertTo-Json -Depth 10
                        $configJson | Set-Content -Path $jsonFilePath -Force
                        $config = Get-Content -Path $jsonFilePath -Raw | ConvertFrom-Json
                    }
                    Else {
                        Write-Entry -Message "Missing Main Attribute in your Config file: $partKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        Write-Entry -Subtext "Adding it for you... In GH Readme, look for $partKey - if you want to see what changed..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        Write-Entry -Subtext "GH Readme -> https://github.com/fscorrupt/Posterizarr/blob/$($Branch)/README.md#configuration" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        $config | Add-Member -MemberType NoteProperty -Name $partKey -Value $defaultConfig.$partKey
                        $AttributeChanged = $True
                    }
                }
                else {
                    # Inform user about the case issue
                    Write-Entry -Message "The Main Attribute '$partKey' in your configuration file has a different casing than the expected property." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Please correct the casing of the property in your configuration file to '$partKey'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        Remove-Item -LiteralPath $CurrentlyRunning | out-null
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Wrong Main Attribute casing in config file"
                    }
                    Exit  # Abort the script
                }
            }
            else {
                # Check each key in the part
                foreach ($propertyKey in $defaultConfig.$partKey.PSObject.Properties.Name) {
                    # Show user that a sub-attribute is missing
                    if (-not $config.$partKey.PSObject.Properties.Name.Contains($propertyKey)) {
                        if (-not $config.$partKey.PSObject.Properties.Name.tolower().Contains($propertyKey.tolower())) {
                            Write-Entry -Message "Missing Sub-Attribute in your Config file: $partKey.$propertyKey" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "Adding it for you... In GH Readme, look for $partKey.$propertyKey - if you want to see what changed..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            Write-Entry -Subtext "GH Readme -> https://github.com/fscorrupt/Posterizarr/blob/$($Branch)/README.md#configuration" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            # Add the property using the expected casing
                            $config.$partKey | Add-Member -MemberType NoteProperty -Name $propertyKey -Value $defaultConfig.$partKey.$propertyKey -Force
                            $AttributeChanged = $True
                        }
                        else {
                            # Inform user about the case issue
                            Write-Entry -Message "The Sub-Attribute '$partKey.$propertyKey' in your configuration file has a different casing than the expected property." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Please correct the casing of the Sub-Attribute in your configuration file to '$partKey.$propertyKey'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            # Clear Running File
                            if (Test-Path $CurrentlyRunning) {
                                Remove-Item -LiteralPath $CurrentlyRunning | out-null
                            }
                            if ($global:UptimeKumaUrl) {
                                Send-UptimeKumaWebhook -status "down" -msg "Wrong Sub Attribute casing in config file"
                            }
                            Exit  # Abort the script
                        }
                    }
                }
            }
        }

        if ($AttributeChanged -eq 'true') {
            # Convert the updated configuration object back to JSON and save it
            $configJson = $config | ConvertTo-Json -Depth 10
            $configJson | Set-Content -Path $jsonFilePath -Force

            Write-Entry -Subtext "Configuration file updated successfully." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
    }
    catch [System.Net.WebException] {
        Write-Entry -Message "Failed to download the default configuration JSON file from the URL." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Config.json download failed."
        }
        Exit
    }
    catch {
        Write-Entry -Message "An unexpected error occurred: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "$($_.Exception.Message)"
        }
        Exit
    }
}
function CheckJsonPaths {
    param (
        [string]$font,
        [string]$RTLfont,
        [string]$backgroundfont,
        [string]$titlecardfont,
        [string]$Posteroverlay,
        [string]$titlecardoverlay,
        [string]$Seasonoverlay,
        [string]$Backgroundoverlay,
        [string]$Posteroverlay4k,
        [string]$Posteroverlay1080p
    )

    $paths = @($font, $RTLfont, $backgroundfont, $titlecardfont, $Posteroverlay, $Backgroundoverlay, $titlecardoverlay, $Seasonoverlay, $Posteroverlay4k, $Posteroverlay1080p)
    $errorCount = 0
    foreach ($path in $paths) {
        if (-not (Test-Path -LiteralPath $path.TrimEnd())) {
            Write-Entry -Message "Could not find file in: $path" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Check config for typos and make sure that the file is present in scriptroot." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }

    if ($errorCount -ge 1) {
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "File missing"
        }
        Exit
    }
}
function Get-Platform {
    if ($global:OSType -eq 'Docker') {
        return 'Docker'
    }
    elseif ($global:OSType -eq 'Unix' -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -notlike 'PSDocker*') {
        # Check if it is a Mac
        $unameOutput = & uname
        if ($unameOutput -like "*Darwin*") {
            return 'macOS'
        }
        Else {
            return 'Linux'
        }
    }
    elseif ($global:OSType -eq 'Win32NT') {
        return 'Windows'
    }
    else {
        return 'Unknown'
    }
}
function Get-LatestScriptVersion {
    try {
        return Invoke-RestMethod -Uri "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/Release.txt" -Method Get -ErrorAction Stop
    }
    catch {
        Write-Entry -Subtext "Could not query latest script version, Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return $null
    }
}
function RotateLogs {
    param (
        [string]$ScriptRoot
    )

    $logFolder = Join-Path $ScriptRoot "Logs"
    $global:RotationFolderName = "RotatedLogs"
    $RotationFolder = Join-Path $ScriptRoot $global:RotationFolderName

    # Create Rotation Folder if missing
    if (!(Test-Path -path $RotationFolder)) {
        New-Item -ItemType Directory -Path $ScriptRoot -Name $global:RotationFolderName -Force | Out-Null
    }

    # Check if the log folder exists
    if (Test-Path -Path $logFolder -PathType Container) {
        # Rename the existing log folder with a timestamp
        $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
        Rename-Item -Path $logFolder -NewName "Logs`_$timestamp"
        # Create Rotation Folder if missing
        if (!(Test-Path $RotationFolder)) {
            New-Item -ItemType Directory -Path $ScriptRoot -Name $global:RotationFolderName -Force | Out-Null
        }
        # Move logs to Rotation Folder
        Move-Item -Path "$logFolder`_$timestamp" $RotationFolder
    }
}
function CheckConfigFile {
    param (
        [string]$ScriptRoot
    )

    if (!(Test-Path (Join-Path $ScriptRoot 'config.json'))) {
        Write-Entry -Message "Config File missing, downloading it for you..." -Path "$ScriptRoot\Logs\Scriptlog.log" -Color White -log Info
        Invoke-WebRequest -Uri "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/config.example.json" -OutFile "$ScriptRoot\config.json"
        Write-Entry -Subtext "Config File downloaded here: '$ScriptRoot\config.json'" -Path "$ScriptRoot\Logs\Scriptlog.log" -Color White -log Info
        Write-Entry -Subtext "Please configure the config file according to GitHub, Exit script now..." -Path "$ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Configure config file"
        }
        Exit
    }
}
function Test-And-Download {
    param(
        [string]$url,
        [string]$destination
    )

    if (!(Test-Path $destination)) {
        Invoke-WebRequest -Uri $url -OutFile $destination
    }
}
function RedactMediaServerUrl {
    param(
        [string]$url
    )

    # Match Plex URLs containing X-Plex-Token
    $plexMatch = $url -match "(https?://)([^:/]+)(:\d+)?(/[^?]+)(\?X-Plex-Token=)([^&]+)(.*)"

    # Match Jellyfin/Emby URLs containing api_key
    $otherMatch = $url -match "(https?://)([^:/]+)(:\d+)?(/[^?]+)(\?api_key=)([^&]+)(.*)"

    if ($plexMatch -or $otherMatch) {
        $protocol = $Matches[1]
        $hostname = $Matches[2]
        $port = $Matches[3]
        $path = $Matches[4]
        $prefix = $Matches[5]   # Either "?X-Plex-Token=" or "?api_key="
        $token = $Matches[6]
        $suffix = $Matches[7]

        # Redact IP address or hostname
        $redactedHostname = $hostname -replace "(?<=.{3}).", "*"

        # Redact API Token
        $redactedToken = $($token[0..7] -join '') + "*******"

        # Construct the redacted URL
        $redactedUrl = $protocol + $redactedHostname + $port + $path + $prefix + $redactedToken + $suffix

        return $redactedUrl
    }
    else {
        return $url  # Return original if no match found
    }
}

function LogConfigSettings {
    Write-Entry -Message "Current Config.json Settings" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "___________________________________________" -Path $configLogging -Color DarkMagenta -log Info
    # Plex Part
    Write-Entry -Subtext "API Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| TVDB API Key:                    $($global:tvdbapi[0..7] -join '')****" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| TMDB API Read Access Token:      $($global:tmdbtoken[0..7] -join '')****" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Fanart API Key:                  $($FanartTvAPIKey[0..7] -join '')****" -Path $configLogging -Color White -log Info
    if ($PlexToken) {
        Write-Entry -Subtext "| Plex Token:                      $($PlexToken[0..7] -join '')****" -Path $configLogging -Color White -log Info
    }
    if ($JellyfinAPIKey) {
        Write-Entry -Subtext "| Jellyfin API Key:                $($JellyfinAPIKey[0..7] -join '')****" -Path $configLogging -Color White -log Info
    }
    if ($EmbyAPIKey) {
        Write-Entry -Subtext "| Emby API Key:                    $($EmbyAPIKey[0..7] -join '')****" -Path $configLogging -Color White -log Info
    }
    Write-Entry -Subtext "| Fav Provider:                    $global:FavProvider" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Width/Height Filtering:          $global:WidthHeightFilter" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Poster min width:                $global:PosterMinWidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Poster min height:               $global:PosterMinHeight" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Background/TC min width:         $global:BgTcMinWidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Background/TC min height:        $global:BgTcMinHeight" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| TMDB Vote Sorting:               $global:TMDBVoteSorting" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Preferred Lang Order:            $($global:PreferredLanguageOrder -join ',')" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Preferred Season Lang Order:     $($global:PreferredSeasonLanguageOrder -join ',')" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Preferred Background Lang Order: $($global:PreferredBackgroundLanguageOrder -join ',')" -Path $configLogging -Color White -log Info
    if ($UsePlex -eq 'true') {
        Write-Entry -Subtext "Plex Part" -Path $configLogging -Color Cyan -log Info
        Write-Entry -Subtext "| Excluded Libs:                   $($LibstoExclude -join ',')" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Plex Url:                        $($PlexUrl[0..10] -join '')****" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Upload Existing Assets:          $global:UploadExistingAssets" -Path $configLogging -Color White -log Info
    }
    if ($UseJellyfin -eq 'true') {
        Write-Entry -Subtext "Jellyfin Part" -Path $configLogging -Color Cyan -log Info
        Write-Entry -Subtext "| Excluded Libs:                   $($LibstoExclude -join ',')" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Jellyfin Url:                    $($JellyfinUrl[0..10] -join '')****" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Upload Existing Assets:          $global:UploadExistingAssets" -Path $configLogging -Color White -log Info
    }
    if ($UseEmby -eq 'true') {
        Write-Entry -Subtext "Emby Part" -Path $configLogging -Color Cyan -log Info
        Write-Entry -Subtext "| Excluded Libs:                   $($LibstoExclude -join ',')" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Emby Url:                        $($EmbyUrl[0..10] -join '')****" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Upload Existing Assets:          $global:UploadExistingAssets" -Path $configLogging -Color White -log Info
    }
    Write-Entry -Subtext "Prerequisites Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| Asset Path:                      $AssetPath" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Backup Path:                     $BackupPath" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Follow Symlink:                  $FollowSymlink" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Skip adding Text:                $SkipAddText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Manual Asset Path:               $ManualAssetPath" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Upload to Plex:                  $Upload2Plex" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Show skipped:                    $show_skipped" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Script Root:                     $global:ScriptRoot" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Magick Location:                 $magickinstalllocation" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| # of Log Folders to retain:      $maxLogs" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Log Level:                       $logLevel" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used Poster Font:                $font" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used RTL Font:                   $RTLfont" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used Background Font:            $backgroundfont" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used TitleCard Font:             $titlecardfont" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used Poster Overlay File:        $Posteroverlay" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used Season Overlay File:        $Seasonoverlay" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used Background Overlay File:    $Backgroundoverlay" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Used TitleCard Overlay File:     $titlecardoverlay" -Path $configLogging -Color White -log Info
    if ($UsePosterResolutionOverlays -eq 'true') {
        Write-Entry -Subtext "| Used 4K Overlay File:            $4kposter" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Used 1080P Overlay File:         $1080pPoster" -Path $configLogging -Color White -log Info
    }
    Write-Entry -Subtext "| Create Library Folders:          $LibraryFolders" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Create Season Posters:           $global:SeasonPosters" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Create Posters:                  $global:Posters" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Create Background Posters:       $global:BackgroundPosters" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Create Title Cards:              $global:TitleCards" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Skip TC creation on TBA:         $SkipTBA" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Skip TC creation on Jap char:    $SkipJapTitle" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Clear Asset:                     $AssetCleanup" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "OverLay General Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| Process Images:                  $global:ImageProcessing" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "OverLay Poster Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| All Caps on Text:                $fontAllCaps" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Border to Image:             $AddBorder" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Text to Image:               $AddText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Stroke to Text:              $AddTextStroke" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke color:                    $strokecolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke width:                    $strokewidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Overlay to Image:            $AddOverlay" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Font Color:                      $fontcolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Color:                    $bordercolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Min Font Size:                   $minPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Max Font Size:                   $maxPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Width:                    $borderwidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Width:                  $MaxWidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Height:                 $MaxHeight" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Offset:                 $text_offset" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Line Spacing:                    $lineSpacing" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "OverLay Season Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| Fallback to Show:                $ShowFallback" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| All Caps on Text:                $SeasonfontAllCaps" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Border to Image:             $AddSeasonBorder" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Text to Image:               $AddSeasonText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Stroke to Text:              $AddSeasonTextStroke" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke color:                    $Seasonstrokecolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke width:                    $Seasonstrokewidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Overlay to Image:            $AddSeasonOverlay" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Font Color:                      $Seasonfontcolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Color:                    $Seasonbordercolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Min Font Size:                   $SeasonminPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Max Font Size:                   $SeasonmaxPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Width:                    $Seasonborderwidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Width:                  $SeasonMaxWidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Height:                 $SeasonMaxHeight" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Offset:                 $Seasontext_offset" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Line Spacing:                    $SeasonlineSpacing" -Path $configLogging -Color White -log Info
    if ($AddShowTitletoSeason -eq 'true') {
        Write-Entry -Subtext "Show Text on Season Part" -Path $configLogging -Color Cyan -log Info
        Write-Entry -Subtext "| All Caps on Text:                $ShowOnSeasonfontAllCaps" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Add Stroke to Text:              $AddShowOnSeasonTextStroke" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Stroke color:                    $ShowOnSeasonstrokecolor" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Stroke width:                    $ShowOnSeasonstrokewidth" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Font Color:                      $ShowOnSeasonfontcolor" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Min Font Size:                   $ShowOnSeasonminPointSize" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Max Font Size:                   $ShowOnSeasonmaxPointSize" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Text Box Width:                  $ShowOnSeasonMaxWidth" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Text Box Height:                 $ShowOnSeasonMaxHeight" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Text Box Offset:                 $ShowOnSeasontext_offset" -Path $configLogging -Color White -log Info
        Write-Entry -Subtext "| Line Spacing:                    $ShowOnSeasonlineSpacing" -Path $configLogging -Color White -log Info
    }
    Write-Entry -Subtext "OverLay Background Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| All Caps on Text:                $BackgroundfontAllCaps" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Border to Background:        $AddBackgroundBorder" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Text to Background:          $AddBackgroundText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Stroke to Text:              $AddBackgroundTextStroke" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke color:                    $Backgroundstrokecolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke width:                    $Backgroundstrokewidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Overlay to Background:       $AddBackgroundOverlay" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Font Color:                      $Backgroundfontcolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Color:                    $Backgroundbordercolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Min Font Size:                   $BackgroundminPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Max Font Size:                   $BackgroundmaxPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Width:                    $Backgroundborderwidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Width:                  $BackgroundMaxWidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Height:                 $BackgroundMaxHeight" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Offset:                 $Backgroundtext_offset" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Line Spacing:                    $BackgroundlineSpacing" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "OverLay TitleCard Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| Use Background as Title Card:    $UseBackgroundAsTitleCard" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Fallback to Background:          $BackgroundFallback" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Border to Background:        $AddTitleCardBorder" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Color:                    $TitleCardbordercolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Overlay to Background:       $AddTitleCardOverlay" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Border Width:                    $TitleCardborderwidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "OverLay TitleCard Title Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| All Caps on Text:                $TitleCardEPTitlefontAllCaps" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Title to TitleCard:          $AddTitleCardEPTitleText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Stroke to Text:              $AddTitleCardEPTitleTextStroke" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke color:                    $TitleCardEPTitlestrokecolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke width:                    $TitleCardEPTitlestrokewidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Font Color:                      $TitleCardEPTitlefontcolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Min Font Size:                   $TitleCardEPTitleminPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Max Font Size:                   $TitleCardEPTitlemaxPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Width:                  $TitleCardEPTitleMaxWidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Height:                 $TitleCardEPTitleMaxHeight" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Offset:                 $TitleCardEPTitletext_offset" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Line Spacing:                    $TitleCardEPTitlelineSpacing" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "OverLay TitleCard EP Part" -Path $configLogging -Color Cyan -log Info
    Write-Entry -Subtext "| Season TC Text:                  $SeasonTCText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Episode TC Text:                 $EpisodeTCText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| All Caps on Text:                $TitleCardEPfontAllCaps" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Episode to TitleCard:        $AddTitleCardEPText" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Add Stroke to Text:              $AddTitleCardTextStroke" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke color:                    $TitleCardstrokecolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Stroke width:                    $TitleCardstrokewidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Font Color:                      $TitleCardEPfontcolor" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Min Font Size:                   $TitleCardEPminPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Max Font Size:                   $TitleCardEPmaxPointSize" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Width:                  $TitleCardEPMaxWidth" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Height:                 $TitleCardEPMaxHeight" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Text Box Offset:                 $TitleCardEPtext_offset" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "| Line Spacing:                    $TitleCardEPlineSpacing" -Path $configLogging -Color White -log Info
    Write-Entry -Subtext "___________________________________________" -Path $configLogging -Color DarkMagenta -log Info
}
function CheckPlexAccess {
    param (
        [string]$PlexUrl,
        [string]$PlexToken
    )

    if ($PlexToken) {
        Write-Entry -Message "Plex token found, checking access now..." -Path $configLogging -Color White -log Info
        try {
            $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/?X-Plex-Token=$PlexToken" -ErrorAction Stop -Headers $extraPlexHeaders
            if ($response.StatusCode -eq 200) {
                Write-Entry -Subtext "Plex access is working..." -Path $configLogging -Color Green -log Info
                # Check if libs are available
                [XML]$Libs = $response.Content
                if ($Libs.MediaContainer.size -ge 1) {
                    return $Libs
                }
                else {
                    Write-Entry -Subtext "No libs on Plex, abort script now..." -Path $configLogging -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        Remove-Item -LiteralPath $CurrentlyRunning | out-null
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "No Plex Libs found"
                    }
                    Exit
                }
            }
            else {
                Write-Entry -Message "Could not access Plex with this URL: $(RedactMediaServerUrl -url "$PlexUrl/library/sections/?X-Plex-Token=$PlexToken")" -Path $configLogging -Color Red -Log Error
                Write-Entry -Subtext "Please check token and access..." -Path $configLogging -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Could not access plex"
                }
                Exit
            }
        }
        catch {
            Write-Entry -Subtext "Could not access Plex with this URL: $(RedactMediaServerUrl -url "$PlexUrl/library/sections/?X-Plex-Token=$PlexToken")" -Path $configLogging -Color Red -Log Error
            Write-Entry -Subtext "Error occurred while accessing Plex server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Could not access plex"
            }
            Exit
        }
    }
    else {
        Write-Entry -Message "Checking Plex access now..." -Path $configLogging -Color White -log Info
        try {
            $result = Invoke-WebRequest -Uri "$PlexUrl/library/sections" -ErrorAction SilentlyContinue -Headers $extraPlexHeaders
            if ($result.StatusCode -eq 200) {
                Write-Entry -Subtext "Plex access is working..." -Path $configLogging -Color Green -log Info
                # Check if libs are available
                [XML]$Libs = $result.Content
                if ($Libs.MediaContainer.size -ge 1) {
                    Write-Entry -Subtext "Found libs on Plex..." -Path $configLogging -Color White -log Info
                    return $Libs
                }
                else {
                    Write-Entry -Subtext "No libs on Plex, abort script now..." -Path $configLogging -Color Red -log Error
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "No libs on plex"
                    }
                    Exit
                }
            }
        }
        catch {
            Write-Entry -Subtext "Error occurred while accessing Plex server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            Write-Entry -Subtext "Please check access and settings in Plex..." -Path $configLogging -Color Yellow -log Warning
            Write-Entry -Message "To be able to connect to Plex without authentication" -Path $configLogging -Color White -log Info
            Write-Entry -Message "You have to enter your IP range in 'Settings -> Network -> List of IP addresses and networks that are allowed without auth: '192.168.1.0/255.255.255.0''" -Path $configLogging -Color White -log Info
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Could not access plex"
            }
            Exit
        }
    }
}
function CheckImageMagick {
    param (
        [string]$magick,
        [string]$magickinstalllocation
    )

    if (!(Test-Path $magick)) {
        if ($global:OSType -ne "Win32NT") {
            if ($global:OSType -ne "Docker") {
                Write-Entry -Message "ImageMagick missing, downloading the portable version for you..." -Path $configLogging -Color Yellow -log Warning
                $magickUrl = "https://imagemagick.org/archive/binaries/magick"
                Invoke-WebRequest -Uri $magickUrl -OutFile "$global:ScriptRoot/magick"
                chmod +x "$global:ScriptRoot/magick"
                Write-Entry -Subtext "Made the portable Magick executable..." -Path $configLogging -Color Green -log Info
            }
        }
        else {
            Write-Entry -Message "ImageMagick missing, downloading it for you..." -Path $configLogging -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
            $result = Invoke-WebRequest "https://imagemagick.org/archive/binaries/?C=M;O=D"
            $LatestRelease = ($result.links.href | Where-Object { $_ -like '*portable-Q16-HDRI-x64.zip' } | Sort-Object -Descending)[0]
            $DownloadPath = Join-Path -Path $global:ScriptRoot -ChildPath (Join-Path -Path 'temp' -ChildPath $LatestRelease)

            # Ensure the $temp directory exists
            if (-not (Test-Path -LiteralPath $global:ScriptRoot\temp)) {
                New-Item -ItemType Directory -Path $global:ScriptRoot\temp | Out-Null
            }

            Invoke-WebRequest "https://imagemagick.org/archive/binaries/$LatestRelease" -OutFile $DownloadPath

            # Ensure the $magickinstalllocation directory exists
            if (-not (Test-Path -LiteralPath $magickinstalllocation)) {
                New-Item -ItemType Directory -Path $magickinstalllocation | Out-Null
            }

            Expand-Archive -Path $DownloadPath -DestinationPath $magickinstalllocation -Force
            if ((Get-ChildItem -Directory -LiteralPath $magickinstalllocation).name -eq $($LatestRelease.replace('.zip', ''))) {
                Copy-item -Force -Recurse "$magickinstalllocation\$((Get-ChildItem -Directory -LiteralPath $magickinstalllocation).name)\*" $magickinstalllocation
                Remove-Item -Recurse -LiteralPath "$magickinstalllocation\$((Get-ChildItem -Directory -LiteralPath $magickinstalllocation).name)" -Force
            }
            if (Test-Path -LiteralPath $magickinstalllocation\magick.exe) {
                Write-Entry -Subtext "Placed Portable ImageMagick here: $magickinstalllocation" -Path $configLogging -Color Green -log Info
            }
            Else {
                Write-Entry -Subtext "Error During extraction, please manually install/copy portable Imagemagick from here: https://imagemagick.org/archive/binaries/$LatestRelease" -Path $configLogging -Color Red -log Error
            }
        }
    }
}
function CheckOverlayDimensions {
    param (
        [string]$Posteroverlay,
        [string]$Seasonoverlay,
        [string]$Backgroundoverlay,
        [string]$Titlecardoverlay,
        [string]$Posteroverlay4k,
        [string]$Posteroverlay1080p,
        [string]$PosterSize,
        [string]$BackgroundSize
    )

    # Use magick to check dimensions
    $Posteroverlaydimensions = & $magick $Posteroverlay -format "%wx%h" info:
    $Seasonoverlaydimensions = & $magick $Seasonoverlay -format "%wx%h" info:
    $Backgroundoverlaydimensions = & $magick $Backgroundoverlay -format "%wx%h" info:
    $Titlecardoverlaydimensions = & $magick $Titlecardoverlay -format "%wx%h" info:
    $4kPosteroverlaydimensions = & $magick $Posteroverlay4k -format "%wx%h" info:
    $1080pPosteroverlaydimensions = & $magick $Posteroverlay1080p -format "%wx%h" info:

    # Check Poster Overlay Size
    if ($Posteroverlaydimensions -eq $PosterSize) {
        Write-Entry -Subtext "Poster overlay is correctly sized at: $Postersize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    else {
        Write-Entry -Subtext "Poster overlay is NOT correctly sized at: $Postersize. Actual dimensions: $Posteroverlaydimensions" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }

    # Check Poster Overlay Size
    if ($Seasonoverlaydimensions -eq $PosterSize) {
        Write-Entry -Subtext "Season overlay is correctly sized at: $Postersize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    else {
        Write-Entry -Subtext "Season overlay is NOT correctly sized at: $Postersize. Actual dimensions: $Seasonoverlaydimensions" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    # Check Background Overlay Size
    if ($Backgroundoverlaydimensions -eq $BackgroundSize) {
        Write-Entry -Subtext "Background overlay is correctly sized at: $BackgroundSize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    else {
        Write-Entry -Subtext "Background overlay is NOT correctly sized at: $BackgroundSize. Actual dimensions: $Backgroundoverlaydimensions" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }

    # Check TitleCard Overlay Size
    if ($Titlecardoverlaydimensions -eq $BackgroundSize) {
        Write-Entry -Subtext "TitleCard overlay is correctly sized at: $BackgroundSize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    else {
        Write-Entry -Subtext "TitleCard overlay is NOT correctly sized at: $BackgroundSize. Actual dimensions: $Titlecardoverlaydimensions" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }

    # Check 4K Poster Overlay Size
    if ($4kPosteroverlaydimensions -eq $PosterSize) {
        Write-Entry -Subtext "4K Poster overlay is correctly sized at: $Postersize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    else {
        Write-Entry -Subtext "4K Poster overlay is NOT correctly sized at: $Postersize. Actual dimensions: $4kPosteroverlaydimensions" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }

    # Check 1080p Poster Overlay Size
    if ($1080pPosteroverlaydimensions -eq $PosterSize) {
        Write-Entry -Subtext "1080p Poster overlay is correctly sized at: $Postersize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    else {
        Write-Entry -Subtext "1080p Poster overlay is NOT correctly sized at: $Postersize. Actual dimensions: $1080pPosteroverlaydimensions" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function InvokeMagickCommand {
    param (
        [string]$Command,
        [string]$Arguments
    )

    function GetMagickErrorMessage {
        param (
            [string]$ErrorMessage
        )

        # Split the error message into lines
        $lines = $ErrorMessage -split "convert: |magick.exe: |@"
        if ($lines[1]) {
            return $lines[1]
        }
        Else {
            return $lines[0]
        }
    }
        # Check if Pango rendering is needed for RTL languages on Docker
        if ($global:direction -eq "RTL" -and $Platform -eq 'Docker') {
            Write-Entry -Subtext "RTL language detected on Docker, attempting to use pango:" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            # Replace the first instance of 'caption:' with 'pango:'
            # Ensure we only replace the rendering method, not other occurrences of 'caption'
            if ($Arguments -match '(?<!\w)caption:') {
                $Arguments = [regex]::Replace($Arguments, '(?<!\w)caption:', 'pango:', 1)
                Write-Entry -Subtext "Modified Arguments for pango: $Arguments" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            } else {
                Write-Entry -Subtext "Argument string did not contain 'caption:' for pango replacement." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }


    try {
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = $Command
        $processInfo.Arguments = $Arguments
        $processInfo.RedirectStandardOutput = $true
        $processInfo.RedirectStandardError = $true
        $processInfo.UseShellExecute = $false
        $processInfo.CreateNoWindow = $true

        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $processInfo

        try {
            $process.Start() | Out-Null

            # Capture error
            $errorOutput = $process.StandardError.ReadToEnd()

            # Wait for the process to exit
            $process.WaitForExit()

            # Check if there was any error output
            if (-not [string]::IsNullOrWhiteSpace($errorOutput)) {
                Write-Entry -Subtext "An error occurred while executing the magick command:" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext (GetMagickErrorMessage $errorOutput) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "$errorOutput" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
        }
        catch {
            Write-Entry -Subtext "Failed to start the process or read the error output:" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext $_.Exception.Message -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
        finally {
            if ($process) {
                $process.Dispose()
            }
        }
    }
    catch {
        Write-Entry -Subtext "An unexpected error occurred while setting up the process:" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Write-Entry -Subtext $_.Exception.Message -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        $errorCount++
    }
}
function CheckCharLimit {
    # Attempt to get the registry key
    try {
        $regKey = Get-Item -ErrorAction Stop -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem"

        # Get the value of LongPathsEnabled
        $longPathsEnabled = $regKey.GetValue("LongPathsEnabled")

        if ($longPathsEnabled -eq 1) {
            return $true
        }
        Else {
            return $false
        }
    }
    catch {
        # Handle any errors accessing the registry key
        Write-Entry -Subtext "$($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return $false
    }
}
function CheckJellyfinAccess {
    param (
        [string]$JellyfinUrl,
        [string]$JellyfinAPI
    )

    if ($JellyfinAPI) {
        Write-Entry -Message "Checking Jellyfin access now..." -Path $configLogging -Color White -log Info
        try {
            $response = Invoke-RestMethod -Method Get -Uri "$JellyfinUrl/System/Info?api_key=$JellyfinAPI" -ErrorAction Stop
            if ($response.version) {
                Write-Entry -Subtext "Jellyfin access is working..." -Path $configLogging -Color Green -log Info
            }
            else {
                Write-Entry -Message "Could not access Jellyfin" -Path $configLogging -Color Red -Log Error
                Write-Entry -Subtext "Please check token and url..." -Path $configLogging -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Clould not access jellyfin"
                }
                Exit
            }
        }
        catch {
            Write-Entry -Subtext "Could not access Jellyfin" -Path $configLogging -Color Red -Log Error
            Write-Entry -Subtext "Error occurred while accessing Jellyfin server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Clould not access jellyfin"
            }
            Exit
        }
    }
}
function CheckEmbyAccess {
    param (
        [string]$EmbyUrl,
        [string]$EmbyAPI
    )

    if ($EmbyAPI) {
        Write-Entry -Message "Checking Emby access now..." -Path $configLogging -Color White -log Info
        try {
            $response = Invoke-RestMethod -Method Get -Uri "$EmbyUrl/System/Info?api_key=$EmbyAPI" -ErrorAction Stop
            if ($response.version) {
                Write-Entry -Subtext "Emby access is working..." -Path $configLogging -Color Green -log Info
            }
            else {
                Write-Entry -Message "Could not access Emby" -Path $configLogging -Color Red -Log Error
                Write-Entry -Subtext "Please check token and url..." -Path $configLogging -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Clould not access emby"
                }
                Exit
            }
        }
        catch {
            Write-Entry -Subtext "Could not access Emby" -Path $configLogging -Color Red -Log Error
            Write-Entry -Subtext "Error occurred while accessing Emby server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Clould not access emby"
            }
            Exit
        }
    }
}
function UploadOtherMediaServerArtwork {
    param (
        [string]$itemId,
        [string]$imageType,
        [string]$imagePath
    )

    # Check if current image already has exif data
    $Imageinfo = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/items/$itemId/images/?api_key=$OtherMediaServerApiKey"
    $Imageinfotemp = $Imageinfo | Where-Object imagetype -eq $imageType | Select-Object Height, Width, Path
    if ($Imageinfotemp) {
        $Imageinfotemp = $imageinfotemp[0]
    }
    # Set the API endpoint URL for magick exif check
    if (($imageinfotemp.Height) -and ($imageinfotemp.width)) {
        try {
            $ImageUrl = "$OtherMediaServerUrl/items/$itemId/images/$imageType/?api_key=$OtherMediaServerApiKey&width=$($imageinfotemp.width)&height=$($imageinfotemp.Height)"
            $tempFile = Join-Path -Path $global:ScriptRoot -ChildPath "temp\hashcompare.jpg"
            $response = Invoke-WebRequest -Uri $ImageUrl -OutFile $tempFile -ErrorAction Stop
            $magickcommand = "& `"$magick`" identify -verbose `"$tempFile`""
            $magickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
            $value = Invoke-Expression $magickcommand | Select-String -Pattern 'overlay|titlecard|created with ppm|created with posterizarr'
            Remove-Item $tempFile -Force -ErrorAction SilentlyContinue | out-null
        }
        catch {
            Write-Entry -Subtext "An error occurred during exif check: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
            continue
            if (Test-Path $tempFile) {
                Remove-Item $tempFile -Force -ErrorAction SilentlyContinue | out-null
            }
        }
    }

    if ($value) {
        $ExifFound = $True
        Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, skip upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        Write-Entry -Subtext "No posterizarr/kometa/tcm exif data found, starting upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

        # Read the image file as binary
        $imageData = [System.IO.File]::ReadAllBytes($imagePath)

        # Convert the image to a base64 string
        $imageBase64 = [Convert]::ToBase64String($imageData)

        # Determine the content type based on the file extension
        switch ([System.IO.Path]::GetExtension($imagePath).ToLower()) {
            ".jpg" { $contentType = "image/jpeg" }
            ".jpeg" { $contentType = "image/jpeg" }
            ".png" { $contentType = "image/png" }
            ".gif" { $contentType = "image/gif" }
            ".bmp" { $contentType = "image/bmp" }
            ".tiff" { $contentType = "image/tiff" }
            default {
                Write-Entry -Subtext "Unsupported image format." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Unsupported image format"
                }
                exit
            }
        }

        # Set the API endpoint URL
        $apiUrl = "$OtherMediaServerUrl/items/$itemId/images/$imageType/?api_key=$OtherMediaServerApiKey"

        if ($imageType -eq "Backdrop") {
            $deleteUrl = "$OtherMediaServerUrl/items/$itemId/images/$imageType/0?api_key=$OtherMediaServerApiKey"
            # Make the API request to delete the backdrop image
            try {
                # Delete the existing image first
                $response = Invoke-RestMethod -Uri $deleteUrl -Method Delete -ErrorAction Stop
                Write-Entry -Subtext "Image successfully deleted..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $UploadCount++
            }
            catch {
                if ($_.Exception.Response -is [System.Net.Http.HttpResponseMessage] -and $_.Exception.Response.Content) {
                    try {
                        $response = $_.Exception.Response.Content.ReadAsStringAsync().Result
                    }
                    catch {
                        $response = "Unable to read server response (content may be disposed)."
                    }
                    Write-Entry -Subtext "Failed to delete image. Server response: $response" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
                else {
                    Write-Entry -Subtext "Failed to delete image. Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:ReplaceThumbwithBackdrop -eq 'true'){
                # Make the API request to upload the Thumb image
                $thumbapiUrl = "$OtherMediaServerUrl/items/$itemId/images/Thumb/?api_key=$OtherMediaServerApiKey"
                try {
                    $response = Invoke-RestMethod -Uri $thumbapiUrl -Method Post -Body $imageBase64 -ContentType $contentType -ErrorAction Stop

                    Write-Entry -Subtext "Thumb Image successfully uploaded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $UploadCount++
                }
                catch {
                    if ($_.Exception.Response -is [System.Net.Http.HttpResponseMessage] -and $_.Exception.Response.Content) {
                        try {
                            $response = $_.Exception.Response.Content.ReadAsStringAsync().Result
                        }
                        catch {
                            $response = "Unable to read server response (content may be disposed)."
                        }
                        Write-Entry -Subtext "Failed to upload Thumb image. Server response: $response" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                    else {
                        Write-Entry -Subtext "Failed to upload Thumb image. Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
            }
        }
        # Make the API request to upload the image
        try {
            $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Body $imageBase64 -ContentType $contentType -ErrorAction Stop

            Write-Entry -Subtext "Image successfully uploaded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
            $UploadCount++
        }
        catch {
            if ($_.Exception.Response -is [System.Net.Http.HttpResponseMessage] -and $_.Exception.Response.Content) {
                try {
                    $response = $_.Exception.Response.Content.ReadAsStringAsync().Result
                }
                catch {
                    $response = "Unable to read server response (content may be disposed)."
                }
                Write-Entry -Subtext "Failed to upload image. Server response: $response" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
            else {
                Write-Entry -Subtext "Failed to upload image. Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
    }
}
function MassDownloadPlexArtwork {
    function GetPlexArtworkUrl {
        param(
            [string]$ArtUrl,
            [string]$TempImage
        )
        try {
            Invoke-WebRequest -Uri $ArtUrl -OutFile $TempImage -Headers $extraPlexHeaders
        }
        catch {
            Write-Entry -Subtext "Could not download Artwork from plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
            continue
        }

        $magickcommand = "& `"$magick`" identify -verbose `"$TempImage`""
        $magickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Execute command and get exif data
        $value = (Invoke-Expression $magickcommand | Select-String -Pattern 'overlay|titlecard|created with ppm|created with posterizarr')

        if ($value) {
            $ExifFound = $True
            Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, downloading it now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
            $global:posterurl = $ArtUrl
        }
        Else {
            Write-Entry -Subtext "No posterizarr/kometa/tcm exif data found, downloading it now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            $global:posterurl = $ArtUrl
        }
    }

    Write-Entry -Message "Query plex libs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libsoverview = @()
    foreach ($lib in $Libs.MediaContainer.Directory) {
        if ($lib.title -notin $LibstoExclude) {
            $libtemp = New-Object psobject
            $libtemp | Add-Member -MemberType NoteProperty -Name "ID" -Value $lib.key
            $libtemp | Add-Member -MemberType NoteProperty -Name "Name" -Value $lib.title
            $libtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $lib.language

            # Check if $lib.location.path is an array
            if ($lib.location.path -is [array]) {
                $paths = $lib.location.path -join ',' # Convert array to string
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $paths
            }
            else {
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $lib.location.path
            }
            # Check if Libname has chars we cant use for Folders
            if ($lib.title -notmatch "^[^\/:*?`"<>\|\\}]+$") {
                Write-Entry -Message  "Lib: '$($lib.title)' contains invalid characters." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Please rename your lib and remove all chars that are listed here: '/, :, *, ?, `", <, >, |, \, or }'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Invalid lib chars"
                }
                Exit
            }
            $Libsoverview += $libtemp
        }
    }
    if ($($Libsoverview.count) -lt 1) {
        Write-Entry -Subtext "0 libraries were found. Are you on the correct Plex server?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "No libs found"
        }
        Exit
    }
    Write-Entry -Subtext "Found '$($Libsoverview.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = $Libsoverview.Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libraries = @()
    Foreach ($Library in $Libsoverview) {
        if ($Library.Name -notin $LibstoExclude) {
            $PlexHeaders = @{}
            if ($PlexToken) {
                $PlexHeaders['X-Plex-Token'] = $PlexToken
            }

            # Create a parent XML document
            $Libcontent = New-Object -TypeName System.Xml.XmlDocument
            $mediaContainerNode = $Libcontent.CreateElement('MediaContainer')
            $Libcontent.AppendChild($mediaContainerNode) | Out-Null

            # Initialize variables for pagination
            $searchsize = 0
            $totalContentSize = 1

            # Loop until all content is retrieved
            do {
                # Set headers for the current request
                $PlexHeaders['X-Plex-Container-Start'] = $searchsize
                $PlexHeaders['X-Plex-Container-Size'] = '1000'

                # Fetch content from Plex server
                $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/$($Library.ID)/all" -Headers $PlexHeaders

                # Convert response content to XML
                [xml]$additionalContent = $response.Content

                # Get total content size if not retrieved yet
                if ($totalContentSize -eq 1) {
                    $totalContentSize = $additionalContent.MediaContainer.totalSize
                }

                # Import and append video nodes to the parent XML document
                $contentquery = if ($additionalContent.MediaContainer.video) {
                    'video'
                }
                else {
                    'Directory'
                }
                foreach ($videoNode in $additionalContent.MediaContainer.$contentquery) {
                    $importedNode = $Libcontent.ImportNode($videoNode, $true)
                    [void]$mediaContainerNode.AppendChild($importedNode)
                }

                # Update search size for next request
                $searchsize += [int]$additionalContent.MediaContainer.Size
            } until ($searchsize -ge $totalContentSize)
            if ($Libcontent.MediaContainer.video) {
                $contentquery = 'video'
            }
            Else {
                $contentquery = 'Directory'
            }
            foreach ($item in $Libcontent.MediaContainer.$contentquery) {
                $extractedFolder = $null
                $Seasondata = $null
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children? -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                }
                $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
                $tmdbpattern = 'tmdb://(\d+)'
                $imdbpattern = 'imdb://tt(\d+)'
                $tvdbpattern = 'tvdb://(\d+)'
                if ($Metadata.MediaContainer.$contentquery.Location) {
                    $location = $Metadata.MediaContainer.$contentquery.Location.path
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                Else {
                    $location = $Metadata.MediaContainer.$contentquery.media.part.file
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                        $CheckCharLimit = CheckCharLimit
                        if ($CheckCharLimit -eq $false) {
                            Write-Entry -Subtext "Skipping [$($item.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            continue
                        }
                    }

                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                if ($Seasondata) {
                    $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
                    $SeasonNames = $SeasonsTemp.Title -join ','
                    $SeasonNumbers = $SeasonsTemp.index -join ','
                    $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
                    $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
                }
                $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
                $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
                $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
                if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
                if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
                if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

                # check if there are more then 1 entry in ids
                if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
                if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
                if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

                if ($Metadata.MediaContainer.$contentquery.Label.tag) {
                    $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
                }
                Else {
                    $Labels = ""
                }
                $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata){
                    $FileMetadata | ForEach-Object {
                        if ($_.streamType -eq '1') {
                            $Resolution = $_.displayTitle
                        }
                    }
                }
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.Name
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $($item.title)
                if ($FileMetadata) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $($item.originalTitle)
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $item.year
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
                $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $item.ratingKey
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
                $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
                $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
                $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    Write-Entry -Message "Export everything to a csv: $global:ScriptRoot\Logs\PlexLibexport.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Initialize counter variable
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $PosterUnknownCount = 0
    $SkipTBACount = 0
    $SkipJapTitleCount = 0
    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    # Getting information of all Episodes
    if ($global:TitleCards -eq 'true') {
        Write-Entry -Message "Query episodes data from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata){
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        $Episodedata | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Test if csvs are missing and create dummy file.
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -ErrorAction SilentlyContinue)) {
        $EpisodeDummycsv = New-Object psobject

        # Add members to the object with empty values
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $null

        $EpisodeDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexEpisodeExport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexLibexport.csv" -ErrorAction SilentlyContinue)) {
        # Add members to the object with empty values
        $PlexLibDummycsv = New-Object psobject
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "title" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "year" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Path" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $null

        $PlexLibDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexLibexport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")

        if ($FollowSymlink){
            Get-ChildItem -Path $BackupPath -Recurse -FollowSymlink | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $BackupPath -Recurse | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }

        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }


    # Download poster foreach movie
    Write-Entry -Message "Starting asset download now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster/Background download part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

    $checkedItems = @()
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                $SkipingText = 'false'
                $global:posterurl = $null
                $global:ImageMagickError = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $global:IsFallback = $null
                $global:PlexartworkDownloaded = $null
                $global:langCode = $null
                $global:direction = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    $PosterImageoriginal = "$BackupPath\$($entry.RootFoldername).jpg"
                    $TestPath = $BackupPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }
                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $checkedItems += $hashtestpath
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexPosterUrl
                    }
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkipingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:TextlessPoster = $null
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:ImageMagickError = $null

                        Write-Entry -Message "Searching on Plex for $Titletext - Poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $PosterImage
                        if ($global:posterurl) {
                            try {
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                            }
                            catch {
                                $statusCode = $_.Exception.Response.StatusCode
                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $errorCount++
                            }
                            # Move file back to original naming with Brackets.
                            if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                try {
                                    # Attempt to move the item
                                    Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                    # Log success if move was successful
                                    Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                }
                                catch {
                                    # Log the error if the move operation fails
                                    Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $posterCount++
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
                # Now we can start the Background Poster Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        $backgroundImageoriginal = "$BackupPath\$($entry.RootFoldername)_background.jpg"
                        $TestPath = $BackupPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl
                    }
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkipingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:ImageMagickError = $null
                        $global:TextlessPoster = $null

                        Write-Entry -Message "Searching on Plex for $Titletext - Background" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                        if ($BackgroundfontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $BackgroundImage
                        if ($global:posterurl) {
                            try {
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                            }
                            catch {
                                $statusCode = $_.Exception.Response.StatusCode
                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $errorCount++
                            }

                            # Move file back to original naming with Brackets.
                            if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                try {
                                    # Attempt to move the item
                                    Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                    # Log success if move was successful
                                    Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                }
                                catch {
                                    # Log the error if the move operation fails
                                    Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $posterCount++
                                $BackgroundCount++
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }

    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Download part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # Define Global Variables
            $SkipingText = 'false'
            $global:tmdbid = $entry.tmdbid
            $global:tvdbid = $entry.tvdbid
            $global:imdbid = $entry.imdbid
            $Seasonpostersearchtext = $null
            $global:ImageMagickError = $null
            $Episodepostersearchtext = $null
            $global:TMDBfallbackposterurl = $null
            $global:fanartfallbackposterurl = $null
            $FanartSearched = $null
            $global:plexalreadysearched = $null
            $global:posterurl = $null
            $global:PosterWithText = $null
            $global:AssetTextLang = $null
            $global:TMDBAssetTextLang = $null
            $global:FANARTAssetTextLang = $null
            $global:TVDBAssetTextLang = $null
            $global:TMDBAssetChangeUrl = $null
            $global:FANARTAssetChangeUrl = $null
            $global:TVDBAssetChangeUrl = $null
            $global:IsFallback = $null
            $global:FallbackText = $null
            $global:Fallback = $null
            $global:TextlessPoster = $null
            $global:tvdbalreadysearched = $null
            $global:PlexartworkDownloaded = $null
            $global:langCode = $null
            $global:direction = $null

            # Determine the language direction
            $global:langCode = $entry.'Library Language'
            $global:direction = $global:languageDirections[$global:langCode]

            $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

            if ($entry.title -match $cjkPattern) {
                $Titletext = $entry.originalTitle
            }
            else {
                $Titletext = $entry.title
            }

            if ($LibraryFolders -eq 'true') {
                $LibraryName = $entry.'Library Name'
                $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                $PosterImageoriginal = "$EntryDir\poster.jpg"
                $TestPath = $EntryDir
                $Testfile = "poster"

                if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                    New-Item -ItemType Directory -path $EntryDir -Force | out-null
                }
            }
            Else {
                $PosterImageoriginal = "$BackupPath\$($entry.RootFoldername).jpg"
                $TestPath = $BackupPath
                $Testfile = $($entry.RootFoldername)
            }

            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
            }
            else {
                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                if ($fullTestPath) {
                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                }
                Else {
                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                }
            }

            Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

            $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
            $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
            if ($PlexToken) {
                $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
            }
            Else {
                $Arturl = $plexurl + $entry.PlexPosterUrl
            }
            # Now we can start the Poster Part
            if ($global:Posters -eq 'true') {
                $checkedItems += $hashtestpath
                if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                    Write-Entry -Message "Searching on Plex for $Titletext - Poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                    GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $PosterImage

                    if ($fontAllCaps -eq 'true') {
                        $joinedTitle = $Titletext.ToUpper()
                    }
                    Else {
                        $joinedTitle = $Titletext
                    }
                    if (!$global:TextlessPoster -eq 'true' -and $global:TMDBfallbackposterurl) {
                        $global:posterurl = $global:TMDBfallbackposterurl
                    }
                    if (!$global:TextlessPoster -eq 'true' -and $global:fanartfallbackposterurl) {
                        $global:posterurl = $global:fanartfallbackposterurl
                    }
                    if ($global:posterurl) {
                        try {
                            Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                        }
                        catch {
                            $statusCode = $_.Exception.Response.StatusCode
                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                        if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                            # Move file back to original naming with Brackets.
                            try {
                                # Attempt to move the item
                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                # Log success if move was successful
                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                            }
                            catch {
                                # Log the error if the move operation fails
                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $errorCount++
                            }
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $posterCount++
                        }

                    }
                    Else {
                        Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        $errorCount++
                    }
                }
                else {
                    if ($show_skipped -eq 'true' ) {
                        Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                    }
                }
            }
            # Now we can start the Background Part
            if ($global:BackgroundPosters -eq 'true') {
                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                    $backgroundImageoriginal = "$EntryDir\background.jpg"
                    $TestPath = $EntryDir
                    $Testfile = "background"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    $backgroundImageoriginal = "$BackupPath\$($entry.RootFoldername)_background.jpg"
                    $TestPath = $BackupPath
                    $Testfile = "$($entry.RootFoldername)_background"
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                $checkedItems += $hashtestpath
                if ($PlexToken) {
                    $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                }
                Else {
                    $Arturl = $plexurl + $entry.PlexBackgroundUrl
                }
                if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                    # Define Global Variables
                    $SkipingText = 'false'
                    $global:tmdbid = $entry.tmdbid
                    $global:tvdbid = $entry.tvdbid
                    $global:imdbid = $entry.imdbid
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:TextlessPoster = $null
                    $global:ImageMagickError = $null

                    Write-Entry -Message "Searching on Plex for $Titletext - Background" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                    GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $backgroundImage

                    if ($BackgroundfontAllCaps -eq 'true') {
                        $joinedTitle = $Titletext.ToUpper()
                    }
                    Else {
                        $joinedTitle = $Titletext
                    }
                    if ($global:posterurl) {
                        try {
                            Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                        }
                        catch {
                            $statusCode = $_.Exception.Response.StatusCode
                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                        # Move file back to original naming with Brackets.
                        if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                            try {
                                # Attempt to move the item
                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                # Log success if move was successful
                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                            }
                            catch {
                                # Log the error if the move operation fails
                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $errorCount++
                            }
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $BackgroundCount++
                            $posterCount++
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        $errorCount++
                    }
                }
                else {
                    if ($show_skipped -eq 'true' ) {
                        Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                    }
                }
            }
            # Now we can start the Season Part
            if ($global:SeasonPosters -eq 'true') {
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:AssetTextLang = $null
                $global:Fallback = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:PosterWithText = $null
                $global:ImageMagickError = $null
                $global:TextlessPoster = $null
                $global:seasonNames = $entry.SeasonNames -split ','
                $global:SeasonRatingKeys = $entry.SeasonRatingKeys -split ','
                $global:seasonNumbers = $entry.seasonNumbers -split ','
                $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                for ($i = 0; $i -lt $global:seasonNames.Count; $i++) {
                    $SkipingText = 'false'
                    $global:posterurl = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:TMDBSeasonFallback = $null
                    $global:TVDBSeasonFallback = $null
                    $global:FANARTSeasonFallback = $null
                    if ($SeasonfontAllCaps -eq 'true') {
                        $global:seasonTitle = $global:seasonNames[$i].ToUpper()
                    }
                    Else {
                        $global:seasonTitle = $global:seasonNames[$i]
                    }
                    $global:SeasonNumber = $global:seasonNumbers[$i]
                    $global:SeasonRatingKey = $global:SeasonRatingKeys[$i]
                    $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                    if ($global:SeasonNumber) {
                        $global:season = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                    }
                    if ($LibraryFolders -eq 'true') {
                        $SeasonImageoriginal = "$EntryDir\$global:season.jpg"
                        $TestPath = $EntryDir
                        $Testfile = "$global:season"
                    }
                    Else {
                        $SeasonImageoriginal = "$BackupPath\$($entry.RootFoldername)_$global:season.jpg"
                        $TestPath = $BackupPath
                        $Testfile = "$($entry.RootFoldername)_$global:season"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:season.jpg"
                    $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath
                    if ($PlexToken) {
                        $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $global:PlexSeasonUrl
                    }
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        if (!$Seasonpostersearchtext) {
                            Write-Entry -Message "Searching on Plex for $Titletext - Season" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $Seasonpostersearchtext = $true
                        }
                        GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $SeasonImage
                        if ($global:posterurl) {
                            try {
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                            }
                            catch {
                                $statusCode = $_.Exception.Response.StatusCode
                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $errorCount++
                            }
                            if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                # Move file back to original naming with Brackets.
                                try {
                                    # Attempt to move the item
                                    Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                    # Log success if move was successful
                                    Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                }
                                catch {
                                    # Log the error if the move operation fails
                                    Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $SeasonCount++
                                $posterCount++
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
            }
            # Now we can start the Episode Part
            if ($global:TitleCards -eq 'true') {
                # Loop through each episode
                foreach ($episode in $Episodedata) {
                    $SkipingText = 'false'
                    $global:AssetTextLang = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:season_number = $null
                    $Episodepostersearchtext = $null
                    $global:show_name = $null
                    $global:episodenumber = $null
                    $global:episode_numbers = $null
                    $global:titles = $null
                    $global:posterurl = $null
                    $global:FileNaming = $null
                    $EpisodeImageoriginal = $null
                    $EpisodeImage = $null
                    $global:Fallback = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:TextlessPoster = $null

                    if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title -and $episode.'Library Name' -eq $entry.'Library Name') {
                        $global:show_name = $episode."Show Name"
                        $global:season_number = $episode."Season Number"
                        $global:episode_numbers = $episode."Episodes".Split(",")
                        $global:episode_ratingkeys = $episode."ratingKeys".Split(",")
                        $global:titles = $episode."Title".Split(";")
                        $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")
                        $global:ImageMagickError = $null
                        for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                            $SkipingText = 'false'
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:PosterWithText = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:posterurl = $null
                            $Episodepostersearchtext = $null
                            $ExifFound = $null
                            $global:PlexartworkDownloaded = $null
                            $value = $null
                            $magickcommand = $null
                            $Arturl = $null
                            $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                            $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                            $global:EPTitle = $($global:titles[$i].Trim())
                            $global:episodenumber = $($global:episode_numbers[$i].Trim())
                            $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                            $bullet = [char]0x2022
                            $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                            if ($LibraryFolders -eq 'true') {
                                $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                $TestPath = $EntryDir
                                $Testfile = "$global:FileNaming"
                            }
                            Else {
                                $EpisodeImageoriginal = "$BackupPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                $TestPath = $BackupPath
                                $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                            }

                            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            }
                            else {
                                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                if ($fullTestPath) {
                                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                }
                                Else {
                                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                }
                            }

                            Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                            $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                            $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                            $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                            $checkedItems += $hashtestpath
                            if ($PlexToken) {
                                $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $global:PlexTitleCardUrl
                            }
                            if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                Write-Entry -Message "Searching on Plex for $global:show_name | $global:SeasonEPNumber - Titlecard" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                GetPlexArtworkUrl -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                if ($global:posterurl) {
                                    try {
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        Write-Entry -Subtext "Downloading Titlecard from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                    }
                                    catch {
                                        $statusCode = $_.Exception.Response.StatusCode
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $errorCount++
                                    }
                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $EpisodeCount++
                                        $posterCount++
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }

                            }
                            else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }

    # Asset Cleanup
    if ($AssetCleanup -eq 'true') {
        $ImagesCleared = 0
        $PathsCleared = 0
        $savedsizestring = 0
        Write-Entry -Subtext "Starting Asset Cleanup, this can take some time..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        Write-Entry -Subtext "Only removing Artwork with posterizarr exif data" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        $processedDirectories = @()
        $uncheckedItems = $directoryHashtable.Keys | Where-Object { $_ -notin $checkedItems }

        # Perform deletion of unchecked items
        foreach ($uncheckedItem in $uncheckedItems) {
            if ($uncheckedItem -notlike '*.jpg') {
                # Full path to the item
                $uncheckedItemPath = $uncheckedItem + ".jpg"

                # Check if its a asset from Posterizarr
                $exifmagickcommand = "& `"$magick`" identify -verbose `"$uncheckedItemPath`""
                $exifmagickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

                $ExifData = (Invoke-Expression $exifmagickcommand | Select-String -Pattern 'created with ppm|created with posterizarr')

                if ($ExifData) {
                    # Remove unchecked item from filesystem
                    Remove-Item -LiteralPath $uncheckedItemPath -Force | Out-Null
                    $ImagesCleared++
                    Write-Entry -Subtext "Artwork Removed: $uncheckedItemPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    if ($LibraryFolders -eq 'true') {
                        # Determine the parent directory of the item
                        $parentDir = Split-Path -Path $uncheckedItemPath -Parent

                        # Add the directory to the list if it's not already included
                        if ($parentDir -notin $processedDirectories) {
                            $processedDirectories += $parentDir
                        }
                    }
                }
            }
        }

        # Cleanup empty Asset dirs
        if ($LibraryFolders -eq 'true') {
            # After all files are removed, check each directory in the list
            foreach ($dir in $processedDirectories) {
                # Check if the directory is now empty (including hidden and system files)
                if (-not (Get-ChildItem -LiteralPath $dir -Force)) {
                    # Remove the parent directory if it is empty
                    $PathsCleared++
                    Remove-Item -LiteralPath $dir -Force -Recurse -Confirm:$false | Out-Null
                    Write-Entry -Subtext "Removed empty directory: $dir" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                }
            }
        }
        if ($ImagesCleared -ge '1' -or $PathsCleared -ge '1') {
            Write-Entry -Message "Asset Cleanup overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        # Check new dir Size
        if ($ImagesCleared -ge '1') {
            $newtotalSize = Get-ChildItem $BackupPath -Recurse | Measure-Object -Property Length -Sum
            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($newtotalSize.Sum -gt 1GB) {
                $newtotalSizeString = "{0:N2} GB" -f ($newtotalSize.Sum / 1GB)
            }
            elseif ($newtotalSize.Sum -gt 1MB) {
                $newtotalSizeString = "{0:N2} MB" -f ($newtotalSize.Sum / 1MB)
            }
            elseif ($newtotalSize.Sum -gt 1KB) {
                $newtotalSizeString = "{0:N2} KB" -f ($newtotalSize.Sum / 1KB)
            }
            else {
                $newtotalSizeString = "$($newtotalSize.Sum) bytes"
            }

            # Saved space
            $SavedSpace = $totalSize - $newtotalSize.Sum

            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($SavedSpace -gt 1GB) {
                $savedsizestring = "{0:N2} GB" -f ($SavedSpace / 1GB)
            }
            elseif ($SavedSpace -gt 1MB) {
                $savedsizestring = "{0:N2} MB" -f ($SavedSpace / 1MB)
            }
            elseif ($SavedSpace -gt 1KB) {
                $savedsizestring = "{0:N2} KB" -f ($SavedSpace / 1KB)
            }
            else {
                $savedsizestring = "$SavedSpace bytes"
            }

            if ($ImagesCleared -ge '1') {
                Write-Entry -Subtext "Images Cleared: $ImagesCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Images Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($PathsCleared -ge '1') {
            if ($PathsCleared -ge '1') {
                Write-Entry -Subtext "Empty Folders Cleared: $PathsCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Empty Folders Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($ImagesCleared -ge '1') {
            Write-Entry -Subtext "Cleanup saved: $savedsizestring" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images downloaded: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters downloaded: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images downloaded: $SeasonCount | Background images downloaded: $BackgroundCount | TitleCards downloaded: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    if ($global:NotifyUrl -like '*discord*' -and $global:SendNotification -eq 'true') {
        if ($SkipTBA -eq 'true' -or $SkipJapTitle -eq 'true') {
            if ($AssetCleanup -eq 'true') {
                $jsonPayload = @"
            {
                "username": "$global:DiscordUserName",
                "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                "content": "",
                "embeds": [
                {
                    "author": {
                    "name": "Posterizarr @Github",
                    "url": "https://github.com/fscorrupt/Posterizarr"
                    },
                    "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                    "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                    "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                    "fields": [
                    {
                        "name": "",
                        "value": ":frame_photo:",
                        "inline": false
                    },
                    {
                        "name": "Posters Downloaded",
                        "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                        "inline": false
                    },
                    {
                        "name": "Backgrounds Downloaded",
                        "value": "$BackgroundCount",
                        "inline": true
                    },
                    {
                        "name": "Seasons Downloaded",
                        "value": "$SeasonCount",
                        "inline": true
                    },
                    {
                        "name": "TitleCards Downloaded",
                        "value": "$EpisodeCount",
                        "inline": true
                    },
                    {
                        "name": "",
                        "value": ":recycle:",
                        "inline": false
                    },
                    {
                        "name": "Images cleared",
                        "value": "$ImagesCleared",
                        "inline": true
                    },
                    {
                        "name": "Folders Cleared",
                        "value": "$PathsCleared",
                        "inline": true
                    },
                    {
                        "name": "Space saved",
                        "value": "$savedsizestring",
                        "inline": true
                    }
                    ],
                    "thumbnail": {
                        "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                    },
                    "footer": {
                        "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                    }
                }
                ]
            }
"@
            }
            Else {
                $jsonPayload = @"
        {
            "username": "$global:DiscordUserName",
            "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
            "content": "",
            "embeds": [
            {
                "author": {
                "name": "Posterizarr @Github",
                "url": "https://github.com/fscorrupt/Posterizarr"
                },
                "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                "fields": [
                {
                    "name": "",
                    "value": ":frame_photo:",
                    "inline": false
                },
                {
                    "name": "Posters Downloaded",
                    "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                    "inline": false
                },
                {
                    "name": "Backgrounds Downloaded",
                    "value": "$BackgroundCount",
                    "inline": true
                },
                {
                    "name": "Seasons Downloaded",
                    "value": "$SeasonCount",
                    "inline": true
                },
                {
                    "name": "TitleCards Downloaded",
                    "value": "$EpisodeCount",
                    "inline": true
                }
                ],
                "thumbnail": {
                    "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                },
                "footer": {
                    "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                }
            }
            ]
        }
"@
            }
        }
        Else {
            if ($AssetCleanup -eq 'true') {
                $jsonPayload = @"
            {
                "username": "$global:DiscordUserName",
                "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                "content": "",
                "embeds": [
                {
                    "author": {
                    "name": "Posterizarr @Github",
                    "url": "https://github.com/fscorrupt/Posterizarr"
                    },
                    "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                    "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                    "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                    "fields": [
                    {
                        "name": "",
                        "value": ":frame_photo:",
                        "inline": false
                    },
                    {
                        "name": "Posters Downloaded",
                        "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                        "inline": false
                    },
                    {
                        "name": "Backgrounds Downloaded",
                        "value": "$BackgroundCount",
                        "inline": true
                    },
                    {
                        "name": "Seasons Downloaded",
                        "value": "$SeasonCount",
                        "inline": true
                    },
                    {
                        "name": "TitleCards Downloaded",
                        "value": "$EpisodeCount",
                        "inline": true
                    },
                    {
                        "name": "",
                        "value": ":recycle:",
                        "inline": false
                    },
                    {
                        "name": "Images cleared",
                        "value": "$ImagesCleared",
                        "inline": true
                    },
                    {
                        "name": "Folders Cleared",
                        "value": "$PathsCleared",
                        "inline": true
                    },
                    {
                        "name": "Space saved",
                        "value": "$savedsizestring",
                        "inline": true
                    }
                    ],
                    "thumbnail": {
                        "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                    },
                    "footer": {
                        "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                    }
                }
                ]
            }
"@
            }
            Else {
                $jsonPayload = @"
            {
                "username": "$global:DiscordUserName",
                "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                "content": "",
                "embeds": [
                {
                    "author": {
                    "name": "Posterizarr @Github",
                    "url": "https://github.com/fscorrupt/Posterizarr"
                    },
                    "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                    "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                    "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                    "fields": [
                    {
                        "name": "",
                        "value": ":frame_photo:",
                        "inline": false
                    },
                    {
                        "name": "Posters Downloaded",
                        "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                        "inline": false
                    },
                    {
                        "name": "Backgrounds Downloaded",
                        "value": "$BackgroundCount",
                        "inline": true
                    },
                    {
                        "name": "Seasons Downloaded",
                        "value": "$SeasonCount",
                        "inline": true
                    },
                    {
                        "name": "TitleCards Downloaded",
                        "value": "$EpisodeCount",
                        "inline": true
                    }
                    ],
                    "thumbnail": {
                        "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                    },
                    "footer": {
                        "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                    }
                }
                ]
            }
"@
            }
        }
        $global:NotifyUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
        Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
    }
    Else {
        if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*' -and $global:SendNotification -eq 'true') {
            if ($errorCount -ge '1') {
                apprise --notification-type="failure" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Downloaded '$posterCount' Images`n`nDuring execution '$errorCount' Errors occurred, please check log for detailed description." "$global:NotifyUrl"
            }
            Else {
                apprise --notification-type="success" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Downloaded '$posterCount' Images" "$global:NotifyUrl"
            }
        }
    }

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
function SyncPlexArtwork {
    param(
        [string]$ArtUrl,
        [string]$DestUrl,
        [string]$imageType,
        [string]$title,
        [string]$artworktype
    )
    $startmessage = $null

    if ($show_skipped -eq 'true'){
        Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $startmessage = $true
    }
    Else {
        Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
        if ($global:logLevel -eq '3'){
            $startmessage = $true
        }
    }

    try {
        Write-Entry -Subtext "Fetching image from source: $(RedactMediaServerUrl -url $ArtUrl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $imageResponse = Invoke-WebRequest -Uri $ArtUrl -Headers $extraPlexHeaders -UseBasicParsing -ErrorAction Stop
    }
    catch {
        # Attempt to parse JSON error response
        $errorResponse = $_.ErrorDetails.Message | ConvertFrom-Json -ErrorAction SilentlyContinue

        if ($errorResponse) {
            $errorTitle = $errorResponse.title
            $errorStatus = $errorResponse.status
            if (-not $startmessage){
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve source image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        } else {
            if (-not $startmessage){
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve source image: Unknown error" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }

        return
    }


    if ($imageResponse.StatusCode -ne 200) {
        if (-not $startmessage){
            Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-Entry -Subtext "Unexpected response from source ($(RedactMediaServerUrl -url $ArtUrl)): $($imageResponse.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return
    }

    $remoteImageBytes = $imageResponse.Content
    if (-not $remoteImageBytes) {
        if (-not $startmessage){
            Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-Entry -Subtext "Source image content is empty!" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return
    }

    $remoteImageContentType = $imageResponse.Headers.'Content-Type'
    if ($remoteImageContentType -is [System.Array]) {
        $remoteImageContentType = $remoteImageContentType[0]
    }

    Write-Entry -Subtext "Calculating hash for remote image..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    $remoteImageHash = GetHash -imageBytes $remoteImageBytes

    try {
        Write-Entry -Subtext "Fetching existing image from destination: $(RedactMediaServerUrl -url $DestUrl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $existingImageResponse = Invoke-WebRequest -Uri $DestUrl -UseBasicParsing -ErrorAction Stop
    }
    catch {
        # Attempt to parse JSON error response
        $errorResponse = $_.ErrorDetails.Message | ConvertFrom-Json -ErrorAction SilentlyContinue

        if ($errorResponse) {
            $errorTitle = $errorResponse.title
            $errorStatus = $errorResponse.status
            if (-not $startmessage){
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve destination image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        } else {
            if (-not $startmessage){
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve destination image: Unknown error" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }

        return
    }


    if ($existingImageResponse.StatusCode -ne 200) {
        if (-not $startmessage){
            Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-Entry -Subtext "Unexpected response from destination ($(RedactMediaServerUrl -url $DestUrl)): $($existingImageResponse.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return
    }

    $existingImageBytes = $existingImageResponse.Content
    if (-not $existingImageBytes) {
        Write-Entry -Subtext "Existing image content is empty!" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }

    $existingImageHash = GetHash -imageBytes $existingImageBytes
    if ($remoteImageHash -eq $existingImageHash) {
        if ($show_skipped -eq 'true'){
            Write-Entry -Subtext "Image hashes match, skipping upload for $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Else {
            Write-Entry -Subtext "Image hashes match, skipping upload for $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
        }
        return
    }

    Write-Entry -Subtext "Uploading new artwork to Jelly/Emby for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    if ($imageType -eq 'Backdrop') {
        try {
            Write-Entry -Subtext "Deleting old artwork before upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Invoke-RestMethod -Uri $DestUrl -Method Delete -ErrorAction Stop
            Write-Entry -Subtext "Successfully deleted old artwork." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        catch {
            # Attempt to parse JSON error response
            $errorResponse = $_.ErrorDetails.Message | ConvertFrom-Json -ErrorAction SilentlyContinue

            if ($errorResponse) {
                $errorTitle = $errorResponse.title
                $errorStatus = $errorResponse.status

                Write-Entry -Subtext "Error deleting image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            } else {
                Write-Entry -Subtext "Error deleting image: Unknown error" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }

    }

    try {
        $imageBase64 = [Convert]::ToBase64String($remoteImageBytes)
        $response = Invoke-RestMethod -Uri $DestUrl -Method Post -Body $imageBase64 -ContentType $remoteImageContentType -ErrorAction Stop
        Write-Entry -Subtext "Image uploaded successfully." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

        switch ($artworktype) {
            'poster' { $postercount++ }
            'tc' { $EpisodeCount++ }
            'background' { $BackgroundCount++ }
            'season' { $SeasonCount++ }
        }
        $UploadCount++
    }
    catch {
        # Attempt to parse JSON error response
        $message = $_.ErrorDetails.Message
        if ($message -match '^\s*\{.*\}\s*$') {
            $errorResponse = $message | ConvertFrom-Json -ErrorAction SilentlyContinue
        }

        if ($errorResponse) {
            $errorTitle = $errorResponse.title
            $errorStatus = $errorResponse.status

            Write-Entry -Subtext "Error uploading image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        } else {
            Write-Entry -Subtext "Error uploading image: $message" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }

}
function Send-UptimeKumaWebhook {
    param (
        [string]$status,
        [string]$msg = "OK",
        [int]$ping = 0
    )

    $uri = $global:UptimeKumaUrl + "?status=$status&msg=$msg&ping=$ping"
    try {
        $null = Invoke-RestMethod -Uri $uri
        Write-Entry -Message "Uptime Kuma webhook sent: Status=$status, Msg=$msg, Ping=$ping" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    catch {
        Write-Entry -Message "Failed to send Uptime Kuma webhook: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
}
#### FUNCTION END ####

##### PRE-START #####
# Set Branch
if ($dev) {
    $Branch = 'dev'
}
Else {
    $Branch = 'main'
}
# Set some global vars
Set-OSTypeAndScriptRoot
# Get platform
$Platform = Get-Platform
# Get Latest Script Version
$LatestScriptVersion = (Get-LatestScriptVersion -split "`r?`n" | Select-Object -First 1).Trim()
##### START #####
$startTime = Get-Date

# Check if the environment variable exists and is not empty, otherwise use the default
if (-not [string]::IsNullOrEmpty($env:FONTCONFIG_CACHE_DIR)) {
    $IM_Font_Cache = $env:FONTCONFIG_CACHE_DIR
} else {
    $IM_Font_Cache = "/var/cache/fontconfig"
}

$Font_Cache = "/usr/share/fonts/custom/"
# Rotate logs before doing anything!
$folderPattern = "Logs_*"
$global:RotationFolderName = $null
$global:logLevel = 2
RotateLogs -ScriptRoot $global:ScriptRoot
Write-Entry -Message "Starting..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
# Check if Config file is present
CheckConfigFile -ScriptRoot $global:ScriptRoot
# Test Json if something is missing
CheckJson -jsonExampleUrl "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/config.example.json" -jsonFilePath $(Join-Path $global:ScriptRoot 'config.json')
# Check if Script is Latest
if ($CurrentScriptVersion -eq $LatestScriptVersion) {
    Write-Entry -Message "You are Running Version - v$CurrentScriptVersion" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
}
Else {
    Write-Entry -Message "You are Running Version: v$CurrentScriptVersion - Latest Version is: v$LatestScriptVersion" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
}
# load config file
$config = Get-Content -Raw -Path $(Join-Path $global:ScriptRoot 'config.json') | ConvertFrom-Json

# Replace Script with Latest
if ($Platform -ne 'Docker' -and $config.PrerequisitePart.AutoUpdatePosterizarr.tolower() -eq 'true' -and $CurrentScriptVersion -ne $LatestScriptVersion) {
    Write-Entry -Subtext "Posterizarr version upgrade started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $CurrentScriptPath = $MyInvocation.MyCommand.Path

    # Backup the current script
    Write-Entry -Subtext "Backup current Script to: $CurrentScriptPath.bak" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Copy-Item -Path $CurrentScriptPath -Destination "$CurrentScriptPath.bak" -Force
    try {
        Invoke-WebRequest -Uri "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/Posterizarr.ps1" -OutFile $CurrentScriptPath -ErrorAction Stop
        Write-Entry -Subtext "Posterizarr script updated to v$LatestScriptVersion, please restart script..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    catch {
        Write-Entry -Subtext "Failed to download the latest script, Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "down" -msg "Script download failed"
    }
    Exit
}

# Now is the earliest that you can set your logLevel other than 2
# Read logLevel value from config.json
$global:logLevel = [int]$config.PrerequisitePart.logLevel
# Check if the cast was successful
if ($null -eq $global:logLevel) {
    Write-Entry -Message "Value for logLevel was null. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:logLevel = 1
}
# Ensure $logLevel is at least 1
if ($global:logLevel -le 0) {
    Write-Entry -Message "Value for logLevel -le 0. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:logLevel = 1
}# Ensure $logLevel is le 3
if ($global:logLevel -gt 3) {
    Write-Entry -Message "Value for logLevel -gt 3. Setting it to 3. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:logLevel = 3
}
# Read naxLogs value from config.json
$maxLogs = [int]$config.PrerequisitePart.maxLogs  # Cast to integer
# Check if the cast was successful
if ($null -eq $maxLogs) {
    Write-Entry -Message "Value for maxLogs was null. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $maxLogs = 1
}
# Ensure $maxLogs is at least 1
if ($maxLogs -le 0) {
    Write-Entry -Message "Value for maxLogs -le 0. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $maxLogs = 1
}
# Delete excess log folders
$logFolders = Get-ChildItem -Path $(Join-Path $global:ScriptRoot $global:RotationFolderName) -Directory | Where-Object { $_.Name -match $folderPattern } | Sort-Object CreationTime -Descending | Select-Object -First $maxLogs
foreach ($folder in (Get-ChildItem -Path $(Join-Path $global:ScriptRoot $global:RotationFolderName) -Directory | Where-Object { $_.Name -match $folderPattern })) {
    if ($folder.FullName -notin $logFolders.FullName) {
        Remove-Item -Path $folder.FullName -Recurse -Force
        $fldrName = $folder.FullName
        Write-Entry -Message "Deleting excess folder: $fldrName" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
}

# Access variables from the config file
# Notification Part
$global:SendNotification = $config.Notification.SendNotification.tolower()
$global:UseUptimeKuma = $config.Notification.UseUptimeKuma.tolower()
$global:DiscordUserName = $config.Notification.DiscordUserName
if ($global:UseUptimeKuma -eq 'true') {
    $global:UptimeKumaUrl = $config.Notification.UptimeKumaUrl
}

if ($env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
    $global:NotifyUrl = $config.Notification.AppriseUrl
    if ($global:NotifyUrl -eq 'discord://{WebhookID}/{WebhookToken}/' -and $global:SendNotification -eq 'true') {
        # Try the normal discord url
        $global:NotifyUrl = $config.Notification.Discord
        if ($global:NotifyUrl -eq 'https://discordapp.com/api/webhooks/{WebhookID}/{WebhookToken}' -and $global:SendNotification -eq 'true') {
            Write-Entry -Message "Found default Notification Url, please update url in config..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Default notify url in config"
            }
            Exit
        }
    }
    if (!$global:NotifyUrl -and $global:SendNotification -eq 'true') {
        $global:NotifyUrl = $config.Notification.Discord
    }
}
Else {
    $global:NotifyUrl = $config.Notification.Discord
    if ($global:NotifyUrl -eq 'https://discordapp.com/api/webhooks/{WebhookID}/{WebhookToken}' -and $global:SendNotification -eq 'true') {
        Write-Entry -Message "Found default Notification Url, please update url in config..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Default notify url in config"
        }
        Exit
    }
}

# API Part
$global:tvdbapi = $config.ApiPart.tvdbapi
if ($global:tvdbapi -match '#') {
    $global:tvdbpin = $global:tvdbapi.split('#')[1]
    $global:tvdbapi = $global:tvdbapi.split('#')[0]
}
$global:tmdbtoken = $config.ApiPart.tmdbtoken
$FanartTvAPIKey = $config.ApiPart.FanartTvAPIKey
$PlexToken = $config.ApiPart.PlexToken
$JellyfinAPIKey = $config.ApiPart.JellyfinAPIKey
$EmbyAPIKey = $config.ApiPart.EmbyAPIKey
$global:WidthHeightFilter = $config.ApiPart.WidthHeightFilter.tolower()
$global:PosterMinWidth = $config.ApiPart.PosterMinWidth
$global:PosterMinHeight = $config.ApiPart.PosterMinHeight
$global:BgTcMinWidth = $config.ApiPart.BgTcMinWidth
$global:BgTcMinHeight = $config.ApiPart.BgTcMinHeight
$global:FavProvider = $config.ApiPart.FavProvider.ToUpper()
$global:TMDBVoteSorting = $config.ApiPart.tmdb_vote_sorting.tolower()

if (!$global:TMDBVoteSorting) {
    Write-Entry -Message "TMDB Sorting option not set in config, setting it to 'vote_average' for you" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:TMDBVoteSorting = "vote_average"
}
$global:PreferredLanguageOrder = $config.ApiPart.PreferredLanguageOrder
$global:PreferredSeasonLanguageOrder = $config.ApiPart.PreferredSeasonLanguageOrder
$global:PreferredBackgroundLanguageOrder = $config.ApiPart.PreferredBackgroundLanguageOrder

if ($global:PreferredBackgroundLanguageOrder -eq 'PleaseFillMe') {
    $global:PreferredBackgroundLanguageOrder = $global:PreferredLanguageOrder
}

# Poster Lang Settings
if (!$global:PreferredLanguageOrder) {
    Write-Entry -Message "Poster Lang search Order not set in Config, setting it to 'xx,en,de' for you" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:PreferredLanguageOrder = "xx", "en", "de"
}
$global:PreferredLanguageOrderTMDB = $global:PreferredLanguageOrder.Replace('xx', 'null')
$global:PreferredLanguageOrderFanart = $global:PreferredLanguageOrder.Replace('xx', '00')
$global:PreferredLanguageOrderTVDB = $global:PreferredLanguageOrder.Replace('xx', 'null')
if ($global:PreferredLanguageOrder.count -eq '1' -and $global:PreferredLanguageOrder -eq 'xx') {
    $global:PreferTextless = $true
    $global:OnlyTextless = $true
    Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
}
Elseif ($global:PreferredLanguageOrder[0] -eq 'xx') {
    $global:PreferTextless = $true
    $global:OnlyTextless = $false
    Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
}
Else {
    $global:PreferTextless = $false
    $global:OnlyTextless = $false
    Write-Entry -Subtext "PreferTextless Value: $global:PreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    Write-Entry -Subtext "OnlyTextless Value: $global:OnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
}

# Season Lang Settings
if (!$global:PreferredSeasonLanguageOrder) {
    Write-Entry -Message "Season Lang search Order not set in Config, setting it to 'xx,en,de' for you" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:PreferredSeasonLanguageOrder = "xx", "en", "de"
}
$global:PreferredSeasonLanguageOrderTMDB = $global:PreferredSeasonLanguageOrder.Replace('xx', 'null')
$global:PreferredSeasonLanguageOrderFanart = $global:PreferredSeasonLanguageOrder.Replace('xx', '00')
$global:PreferredSeasonLanguageOrderTVDB = $global:PreferredSeasonLanguageOrder.Replace('xx', 'null')
if ($global:PreferredSeasonLanguageOrder.count -eq '1' -and $global:PreferredSeasonLanguageOrder -eq 'xx') {
    $global:SeasonPreferTextless = $true
    $global:SeasonOnlyTextless = $true
}
Elseif ($global:PreferredSeasonLanguageOrder[0] -eq 'xx') {
    $global:SeasonPreferTextless = $true
    $global:SeasonOnlyTextless = $false
}
Else {
    $global:SeasonPreferTextless = $false
    $global:SeasonOnlyTextless = $false
}

# Background Lang Settings
if (!$global:PreferredBackgroundLanguageOrder) {
    Write-Entry -Message "Background Lang search Order not set in Config, setting it to 'xx,en,de' for you" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:PreferredBackgroundLanguageOrder = "xx", "en", "de"
}
$global:PreferredBackgroundLanguageOrderTMDB = $global:PreferredBackgroundLanguageOrder.Replace('xx', 'null')
$global:PreferredBackgroundLanguageOrderFanart = $global:PreferredBackgroundLanguageOrder.Replace('xx', '00')
$global:PreferredBackgroundLanguageOrderTVDB = $global:PreferredBackgroundLanguageOrder.Replace('xx', 'null')
if ($global:PreferredBackgroundLanguageOrder.count -eq '1' -and $global:PreferredBackgroundLanguageOrder -eq 'xx') {
    $global:BackgroundPreferTextless = $true
    $global:BackgroundOnlyTextless = $true
}
Elseif ($global:PreferredBackgroundLanguageOrder[0] -eq 'xx') {
    $global:BackgroundPreferTextless = $true
    $global:BackgroundOnlyTextless = $false
}
Else {
    $global:BackgroundPreferTextless = $false
    $global:BackgroundOnlyTextless = $false
}

# default to TMDB if favprovider missing
if (!$global:FavProvider) {
    Write-Entry -Message "FavProvider not set in config, setting it to 'TMDB' for you" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:FavProvider = 'TMDB'
}

# Define the language direction hash table
$global:languageDirections = @{
    "af" = "LTR"; "am" = "LTR"; "ar" = "RTL"; "az" = "LTR"; "be" = "LTR";
    "bg" = "LTR"; "bn" = "LTR"; "bs" = "LTR"; "ca" = "LTR"; "cs" = "LTR";
    "cy" = "LTR"; "da" = "LTR"; "de" = "LTR"; "dv" = "RTL"; "el" = "LTR";
    "en" = "LTR"; "eo" = "LTR"; "es" = "LTR"; "et" = "LTR"; "eu" = "LTR";
    "fa" = "RTL"; "fi" = "LTR"; "fo" = "LTR"; "fr" = "LTR"; "ga" = "LTR";
    "gd" = "LTR"; "gl" = "LTR"; "gu" = "LTR"; "he" = "RTL"; "hi" = "LTR";
    "hr" = "LTR"; "hu" = "LTR"; "hy" = "LTR"; "id" = "LTR"; "is" = "LTR";
    "it" = "LTR"; "ja" = "LTR"; "ka" = "LTR"; "kk" = "LTR"; "km" = "LTR";
    "kn" = "LTR"; "ko" = "LTR"; "ku" = "LTR"; "ky" = "LTR"; "lo" = "LTR";
    "lt" = "LTR"; "lv" = "LTR"; "mg" = "LTR"; "mk" = "LTR"; "ml" = "LTR";
    "mn" = "LTR"; "mr" = "LTR"; "ms" = "LTR"; "mt" = "LTR"; "my" = "LTR";
    "nb" = "LTR"; "ne" = "LTR"; "nl" = "LTR"; "nn" = "LTR"; "no" = "LTR";
    "om" = "LTR"; "or" = "LTR"; "pa" = "LTR"; "pl" = "LTR"; "ps" = "RTL";
    "pt" = "LTR"; "ro" = "LTR"; "ru" = "LTR"; "sd" = "RTL"; "si" = "LTR";
    "sk" = "LTR"; "sl" = "LTR"; "sq" = "LTR"; "sr" = "LTR"; "sv" = "LTR";
    "sw" = "LTR"; "ta" = "LTR"; "te" = "LTR"; "th" = "LTR"; "tk" = "LTR";
    "tr" = "LTR"; "ug" = "RTL"; "uk" = "LTR"; "ur" = "RTL"; "uz" = "LTR";
    "vi" = "LTR"; "yo" = "LTR"; "zh" = "LTR"
}

# Plex Part
$PlexUrl = $config.PlexPart.PlexUrl
$UsePlex = $config.PlexPart.UsePlex.tolower()
if ($UsePlex -eq 'true') {
    $LibstoExclude = $config.PlexPart.LibstoExclude
    $global:UploadExistingAssets = $config.PlexPart.UploadExistingAssets.tolower()
}

# Jellyfin Part
$JellyfinUrl = $config.JellyfinPart.JellyfinUrl
$UseJellyfin = $config.JellyfinPart.UseJellyfin.tolower()
if ($UseJellyfin -eq 'true') {
    $LibstoExclude = $config.JellyfinPart.LibstoExclude
    $OtherMediaServerUrl = $JellyfinUrl
    $UseOtherMediaServer = $UseJellyfin
    $OtherMediaServerApiKey = $JellyfinAPIKey
    $global:UploadExistingAssets = $config.JellyfinPart.UploadExistingAssets.tolower()
    $global:ReplaceThumbwithBackdrop = $config.JellyfinPart.ReplaceThumbwithBackdrop.tolower()
}

# Emby Part
$EmbyUrl = $config.EmbyPart.EmbyUrl
$UseEmby = $config.EmbyPart.UseEmby.tolower()
if ($UseEmby -eq 'true') {
    $LibstoExclude = $config.EmbyPart.LibstoExclude
    $OtherMediaServerUrl = $EmbyUrl
    $UseOtherMediaServer = $UseEmby
    $OtherMediaServerApiKey = $EmbyAPIKey
    $global:UploadExistingAssets = $config.EmbyPart.UploadExistingAssets.tolower()
    $global:ReplaceThumbwithBackdrop = $config.EmbyPart.ReplaceThumbwithBackdrop.tolower()
}

# Count how many media servers are enabled
$enabledServers = 0
if ($UseEmby -eq 'true') { $enabledServers++ }
if ($UseJellyfin -eq 'true') { $enabledServers++ }
if ($UsePlex -eq 'true') { $enabledServers++ }

# If more than one media server is enabled, exit with an error
if ($enabledServers -gt 1) {
    Write-Entry -Message "You have enabled more than one media server - Please use only one." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "down" -msg "Multiple media servers enabled"
    }
    Exit 0
}

# Prerequisites Part
$AutoUpdateIM = $config.PrerequisitePart.AutoUpdateIM.tolower()
$show_skipped = $config.PrerequisitePart.show_skipped.tolower()
$FollowSymlink = $config.PrerequisitePart.FollowSymlink.tolower()
$ForceRunningDeletion = $config.PrerequisitePart.ForceRunningDeletion.tolower()
$AssetPath = RemoveTrailingSlash $config.PrerequisitePart.AssetPath
$BackupPath = RemoveTrailingSlash $config.PrerequisitePart.BackupPath
$ManualAssetPath = RemoveTrailingSlash $config.PrerequisitePart.ManualAssetPath
$Upload2Plex = $config.PrerequisitePart.PlexUpload.tolower()
$SkipAddText = $config.PrerequisitePart.SkipAddText.tolower()

# Check if its a Network Share
if ($AssetPath.StartsWith("\")) {
    # add \ if it only Starts with one
    if (!$AssetPath.StartsWith("\\")) {
        $AssetPath = "\" + $AssetPath
    }
}

# Check if its a Network Share
if ($ManualAssetPath.StartsWith("\")) {
    # add \ if it only Starts with one
    if (!$ManualAssetPath.StartsWith("\\")) {
        $ManualAssetPath = "\" + $ManualAssetPath
    }
}

# Check if its a Network Share
if ($BackupPath.StartsWith("\")) {
    # add \ if it only Starts with one
    if (!$BackupPath.StartsWith("\\")) {
        $BackupPath = "\" + $BackupPath
    }
}

# Construct cross-platform paths
if ($global:OSType -ne "Win32NT") {
    $joinsymbol = "/"
}
Else {
    $joinsymbol = "\"
}
$font = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.font -join $($joinsymbol))
$RTLFont = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.RTLFont -join $($joinsymbol))
$backgroundfont = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.backgroundfont -join $($joinsymbol))
$titlecardfont = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.titlecardfont -join $($joinsymbol))
$Posteroverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.overlayfile -join $($joinsymbol))
$Seasonoverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.seasonoverlayfile -join $($joinsymbol))
$Backgroundoverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.backgroundoverlayfile -join $($joinsymbol))
$titlecardoverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.titlecardoverlayfile -join $($joinsymbol))
$testimage = Join-Path -Path $global:ScriptRoot -ChildPath ('test', 'testimage.png' -join $($joinsymbol))
$backgroundtestimage = Join-Path -Path $global:ScriptRoot -ChildPath ('test', 'backgroundtestimage.png' -join $($joinsymbol))
$LibraryFolders = $config.PrerequisitePart.LibraryFolders.tolower()
$global:SeasonPosters = $config.PrerequisitePart.SeasonPosters.tolower()
$global:Posters = $config.PrerequisitePart.Posters.tolower()
$global:BackgroundPosters = $config.PrerequisitePart.BackgroundPosters.tolower()
$global:TitleCards = $config.PrerequisitePart.TitleCards.tolower()
$SkipTBA = $config.PrerequisitePart.SkipTBA.tolower()
$SkipJapTitle = $config.PrerequisitePart.SkipJapTitle.tolower()
$AssetCleanup = $config.PrerequisitePart.AssetCleanup.tolower()
$NewLineOnSpecificSymbols = $config.PrerequisitePart.NewLineOnSpecificSymbols.tolower()
$NewLineSymbols = $config.PrerequisitePart.NewLineSymbols

# Resolution Part
$UsePosterResolutionOverlays = $config.PrerequisitePart.UsePosterResolutionOverlays.tolower()

$4kposter = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.poster4k -join $($joinsymbol))
$1080pPoster = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.Poster1080p -join $($joinsymbol))
# Poster Overlay Part
$global:ImageProcessing = $config.OverlayPart.ImageProcessing.tolower()
$global:outputQuality = $config.OverlayPart.outputQuality

# Poster Overlay Part
$fontAllCaps = $config.PosterOverlayPart.fontAllCaps.tolower()
$AddBorder = $config.PosterOverlayPart.AddBorder.tolower()
$AddText = $config.PosterOverlayPart.AddText.tolower()
$AddTextStroke = $config.PosterOverlayPart.AddTextStroke.tolower()
$strokecolor = $config.PosterOverlayPart.strokecolor
$strokewidth = $config.PosterOverlayPart.strokewidth
$AddOverlay = $config.PosterOverlayPart.AddOverlay.tolower()
$fontcolor = $config.PosterOverlayPart.fontcolor
$bordercolor = $config.PosterOverlayPart.bordercolor
$minPointSize = $config.PosterOverlayPart.minPointSize
$maxPointSize = $config.PosterOverlayPart.maxPointSize
$borderwidth = $config.PosterOverlayPart.borderwidth
$MaxWidth = $config.PosterOverlayPart.MaxWidth
$MaxHeight = $config.PosterOverlayPart.MaxHeight
$text_offset = $config.PosterOverlayPart.text_offset
$lineSpacing = $config.PosterOverlayPart.lineSpacing
$textgravity = $config.PosterOverlayPart.TextGravity.tolower()
$borderwidthsecond = $borderwidth + 'x' + $borderwidth
$boxsize = $MaxWidth + 'x' + $MaxHeight

# Season Poster Overlay Part
$ShowFallback = $config.SeasonPosterOverlayPart.ShowFallback.tolower()
$SeasonfontAllCaps = $config.SeasonPosterOverlayPart.fontAllCaps.tolower()
$AddSeasonBorder = $config.SeasonPosterOverlayPart.AddBorder.tolower()
$AddSeasonText = $config.SeasonPosterOverlayPart.AddText.tolower()
$AddSeasonTextStroke = $config.SeasonPosterOverlayPart.AddTextStroke.tolower()
$Seasonstrokecolor = $config.SeasonPosterOverlayPart.strokecolor
$Seasonstrokewidth = $config.SeasonPosterOverlayPart.strokewidth
$AddSeasonOverlay = $config.SeasonPosterOverlayPart.AddOverlay.tolower()
$Seasonfontcolor = $config.SeasonPosterOverlayPart.fontcolor
$Seasonbordercolor = $config.SeasonPosterOverlayPart.bordercolor
$SeasonminPointSize = $config.SeasonPosterOverlayPart.minPointSize
$SeasonmaxPointSize = $config.SeasonPosterOverlayPart.maxPointSize
$Seasonborderwidth = $config.SeasonPosterOverlayPart.borderwidth
$SeasonMaxWidth = $config.SeasonPosterOverlayPart.MaxWidth
$SeasonMaxHeight = $config.SeasonPosterOverlayPart.MaxHeight
$Seasontext_offset = $config.SeasonPosterOverlayPart.text_offset
$SeasonlineSpacing = $config.SeasonPosterOverlayPart.lineSpacing
$Seasontextgravity = $config.SeasonPosterOverlayPart.TextGravity.tolower()
$Seasonborderwidthsecond = $borderwidth + 'x' + $borderwidth
$Seasonboxsize = $SeasonMaxWidth + 'x' + $SeasonMaxHeight

# Show Title on Season Poster Overlay Part
$ShowOnSeasonfontAllCaps = $config.ShowTitleOnSeasonPosterPart.fontAllCaps.tolower()
$AddShowTitletoSeason = $config.ShowTitleOnSeasonPosterPart.AddShowTitletoSeason.tolower()
$AddShowOnSeasonTextStroke = $config.ShowTitleOnSeasonPosterPart.AddTextStroke.tolower()
$ShowOnSeasonstrokecolor = $config.ShowTitleOnSeasonPosterPart.strokecolor
$ShowOnSeasonstrokewidth = $config.ShowTitleOnSeasonPosterPart.strokewidth
$ShowOnSeasonfontcolor = $config.ShowTitleOnSeasonPosterPart.fontcolor
$ShowOnSeasonminPointSize = $config.ShowTitleOnSeasonPosterPart.minPointSize
$ShowOnSeasonmaxPointSize = $config.ShowTitleOnSeasonPosterPart.maxPointSize
$ShowOnSeasonMaxWidth = $config.ShowTitleOnSeasonPosterPart.MaxWidth
$ShowOnSeasonMaxHeight = $config.ShowTitleOnSeasonPosterPart.MaxHeight
$ShowOnSeasontext_offset = $config.ShowTitleOnSeasonPosterPart.text_offset
$ShowOnSeasontextgravity = $config.ShowTitleOnSeasonPosterPart.TextGravity.tolower()
$ShowOnSeasonboxsize = $ShowOnSeasonMaxWidth + 'x' + $ShowOnSeasonMaxHeight
$ShowOnSeasonlineSpacing = $config.ShowTitleOnSeasonPosterPart.lineSpacing

# Background Overlay Part
$BackgroundfontAllCaps = $config.BackgroundOverlayPart.fontAllCaps.tolower()
$AddBackgroundOverlay = $config.BackgroundOverlayPart.AddOverlay.tolower()
$AddBackgroundBorder = $config.BackgroundOverlayPart.AddBorder.tolower()
$AddBackgroundText = $config.BackgroundOverlayPart.AddText.tolower()
$AddBackgroundTextStroke = $config.BackgroundOverlayPart.AddTextStroke.tolower()
$Backgroundstrokecolor = $config.BackgroundOverlayPart.strokecolor
$Backgroundstrokewidth = $config.BackgroundOverlayPart.strokewidth
$Backgroundfontcolor = $config.BackgroundOverlayPart.fontcolor
$Backgroundbordercolor = $config.BackgroundOverlayPart.bordercolor
$BackgroundminPointSize = $config.BackgroundOverlayPart.minPointSize
$BackgroundmaxPointSize = $config.BackgroundOverlayPart.maxPointSize
$Backgroundborderwidth = $config.BackgroundOverlayPart.borderwidth
$BackgroundMaxWidth = $config.BackgroundOverlayPart.MaxWidth
$BackgroundMaxHeight = $config.BackgroundOverlayPart.MaxHeight
$Backgroundtext_offset = $config.BackgroundOverlayPart.text_offset
$BackgroundlineSpacing = $config.BackgroundOverlayPart.lineSpacing
$Backgroundtextgravity = $config.BackgroundOverlayPart.TextGravity.tolower()
$Backgroundborderwidthsecond = $Backgroundborderwidth + 'x' + $Backgroundborderwidth
$Backgroundboxsize = $BackgroundMaxWidth + 'x' + $BackgroundMaxHeight

# Title Card Overlay Part
$AddTitleCardOverlay = $config.TitleCardOverlayPart.AddOverlay.tolower()
$UseBackgroundAsTitleCard = $config.TitleCardOverlayPart.UseBackgroundAsTitleCard.tolower()
$AddTitleCardBorder = $config.TitleCardOverlayPart.AddBorder.tolower()
$TitleCardborderwidth = $config.TitleCardOverlayPart.borderwidth
$TitleCardbordercolor = $config.TitleCardOverlayPart.bordercolor
$BackgroundFallback = $config.TitleCardOverlayPart.BackgroundFallback.tolower()

# Title Card Title Text Part
$TitleCardEPTitlefontAllCaps = $config.TitleCardTitleTextPart.fontAllCaps.tolower()
$AddTitleCardEPTitleText = $config.TitleCardTitleTextPart.AddEPTitleText.tolower()
$AddTitleCardEPTitleTextStroke = $config.TitleCardTitleTextPart.AddTextStroke.tolower()
$TitleCardEPTitlestrokecolor = $config.TitleCardTitleTextPart.strokecolor
$TitleCardEPTitlestrokewidth = $config.TitleCardTitleTextPart.strokewidth
$TitleCardEPTitlefontcolor = $config.TitleCardTitleTextPart.fontcolor
$TitleCardEPTitleminPointSize = $config.TitleCardTitleTextPart.minPointSize
$TitleCardEPTitlemaxPointSize = $config.TitleCardTitleTextPart.maxPointSize
$TitleCardEPTitleMaxWidth = $config.TitleCardTitleTextPart.MaxWidth
$TitleCardEPTitleMaxHeight = $config.TitleCardTitleTextPart.MaxHeight
$TitleCardEPTitletext_offset = $config.TitleCardTitleTextPart.text_offset
$TitleCardEPTitlelineSpacing = $config.TitleCardTitleTextPart.lineSpacing
$TitleCardEPTitletextgravity = $config.TitleCardTitleTextPart.TextGravity.tolower()

# Title Card EP Text Part
$SeasonTCText = $config.TitleCardEPTextPart.SeasonTCText
$EpisodeTCText = $config.TitleCardEPTextPart.EpisodeTCText
$TitleCardEPfontAllCaps = $config.TitleCardEPTextPart.fontAllCaps.tolower()
$AddTitleCardEPText = $config.TitleCardEPTextPart.AddEPText.tolower()
$AddTitleCardTextStroke = $config.TitleCardEPTextPart.AddTextStroke.tolower()
$TitleCardstrokecolor = $config.TitleCardEPTextPart.strokecolor
$TitleCardstrokewidth = $config.TitleCardEPTextPart.strokewidth
$TitleCardEPfontcolor = $config.TitleCardEPTextPart.fontcolor
$TitleCardEPminPointSize = $config.TitleCardEPTextPart.minPointSize
$TitleCardEPmaxPointSize = $config.TitleCardEPTextPart.maxPointSize
$TitleCardEPMaxWidth = $config.TitleCardEPTextPart.MaxWidth
$TitleCardEPMaxHeight = $config.TitleCardEPTextPart.MaxHeight
$TitleCardEPtext_offset = $config.TitleCardEPTextPart.text_offset
$TitleCardEPlineSpacing = $config.TitleCardEPTextPart.lineSpacing
$TitleCardEPtextgravity = $config.TitleCardEPTextPart.TextGravity.tolower()

$TitleCardborderwidthsecond = $TitleCardborderwidth + 'x' + $TitleCardborderwidth
$TitleCardEPTitleboxsize = $TitleCardEPTitleMaxWidth + 'x' + $TitleCardEPTitleMaxHeight
$TitleCardEPboxsize = $TitleCardEPMaxWidth + 'x' + $TitleCardEPMaxHeight

$PosterSize = "2000x3000"
$BackgroundSize = "3840x2160"
$fontImagemagick = $font.replace('\', '\\')
$RTLfontImagemagick = $RTLFont.replace('\', '\\')
$backgroundfontImagemagick = $backgroundfont.replace('\', '\\')
$TitleCardfontImagemagick = $TitleCardfont.replace('\', '\\')
if ($global:OSType -ne "Win32NT") {
    $global:OSarch = [System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture
    if ($global:OSType -eq "Docker" -or $global:OSarch -eq "Arm64") {
        $magick = 'magick'
        if ($AssetPath -match '^./') {
            Write-Entry -Message "You have set your asset path to '$AssetPath', please change it to '/assets'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Wrong asset path"
            }
            Exit 0
        }
        if ($BackupPath -match '^./') {
            Write-Entry -Message "You have set your backup path to '$BackupPath', please change it to '/backuppath'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Wrong backup path"
            }
            Exit 0
        }
        if ($ManualAssetPath -match '^./') {
            Write-Entry -Message "You have set your manualasset path to '$ManualAssetPath', please change it to '/manualassets'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Wrong manual asset path"
            }
            Exit 0
        }
    }
    Else {
        $magickinstalllocation = $global:ScriptRoot
        $magick = Join-Path $global:ScriptRoot 'magick'
    }
}
Else {
    $magickinstalllocation = RemoveTrailingSlash $config.PrerequisitePart.magickinstalllocation
    $magick = Join-Path $magickinstalllocation 'magick.exe'
}
$fileExtensions = @(".otf", ".ttf", ".otc", ".ttc", ".png")

$errorCount = 0

# Initialize Other Variables
$SeasonsTemp = $null
$SeasonNames = $null
$SeasonNumbers = $null
$SeasonRatingkeys = $null

# Define cross-platform paths
$LogsPath = Join-Path $global:ScriptRoot 'Logs'
$TempPath = Join-Path $global:ScriptRoot 'temp'
$TestPath = Join-Path $global:ScriptRoot 'test'
$configLogging = Join-Path $LogsPath 'Scriptlog.log'

if ($Manual) {
    $configLogging = Join-Path $LogsPath 'Manuallog.log'
}
if ($Testing) {
    $configLogging = Join-Path $LogsPath 'Testinglog.log'
}

if ($global:OSarch -eq "Arm64") {
    try {
        $CurrentImagemagickversion = & $magick -version
    }
    catch {
        Write-Entry -Message "Could not query installed Imagemagick" -Path $configLogging -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Imagemagick missing"
        }
        Exit
    }
    $CurrentImagemagickversion = [regex]::Match($CurrentImagemagickversion, 'Version: ImageMagick (\d+(\.\d+){1,2}-\d+)')
    $CurrentImagemagickversion = $CurrentImagemagickversion.Groups[1].Value.replace('-', '.')
    Write-Entry -Message "Current Imagemagick Version: $CurrentImagemagickversion" -Path $configLogging -Color White -log Info
}
Else {
    # Check ImageMagick now:
    CheckImageMagick -magick $magick -magickinstalllocation $magickinstalllocation

    $CurrentImagemagickversion = & $magick -version
    $CurrentImagemagickversion = [regex]::Match($CurrentImagemagickversion, 'Version: ImageMagick (\d+(\.\d+){1,2}-\d+)')
    $CurrentImagemagickversion = $CurrentImagemagickversion.Groups[1].Value.replace('-', '.')
    Write-Entry -Message "Current Imagemagick Version: $CurrentImagemagickversion" -Path $configLogging -Color White -log Info
}
if ($global:OSType -eq "Docker") {
    if ($env:POSTERIZARR_NON_ROOT -eq 'TRUE'){
        $OSVersionTag = (Get-Content /etc/os-release | Select-String -Pattern "^PRETTY_NAME=").ToString().Split('=')[1].Trim('"').replace('Alpine Linux ','')
        $Url = "https://pkgs.alpinelinux.org/package/$OSVersionTag/community/x86_64/imagemagick"
        $response = Invoke-WebRequest -Uri $url
        $htmlContent = $response.Content
        $regexPattern = '<th class="header">Version<\/th>\s*<td>\s*<strong>([\d\.]+-r\d+)<\/strong>\s*<\/td>'
        $Versionmatching = [regex]::Matches($htmlContent, $regexPattern)

        if ($Versionmatching.Count -gt 0) {
            $LatestImagemagickversion = $Versionmatching[0].Groups[1].Value.split('-')[0]
        }
    }
    Else{
        $Url = "https://raw.githubusercontent.com/SoftCreatR/imei/main/versions/imagemagick.version"
        $response = Invoke-WebRequest -Uri $url
        $htmlContent = $response.Content
        $regexPattern = '(\d+\.\d+\.\d+-\d+)'
        $Versionmatching = [regex]::Matches($htmlContent, $regexPattern)

        if ($Versionmatching.Count -gt 0) {
            $LatestImagemagickversion = $Versionmatching[0].Value
        }
    }
}
Elseif ($global:OSType -eq "Win32NT") {
    $Url = "https://imagemagick.org/archive/binaries/?C=M;O=D"
    $result = Invoke-WebRequest -Uri $Url
    $LatestImagemagickversion = ($result.links.href | Where-Object { $_ -like '*portable-Q16-HDRI-x64.zip' } | Sort-Object -Descending)[0].Replace('-portable-Q16-HDRI-x64.zip', '').Replace('ImageMagick-', '')
}
Else {
    $LatestImagemagickversion = (Invoke-RestMethod -Uri "https://api.github.com/repos/ImageMagick/ImageMagick/releases/latest" -Method Get).tag_name
}
if ($LatestImagemagickversion) {
    $LatestImagemagickversion = $LatestImagemagickversion.replace('-', '.')
    Write-Entry -Message "Latest Imagemagick Version: $LatestImagemagickversion" -Path $configLogging -Color Yellow -log Info
}

# Auto Update Magick
if ($AutoUpdateIM -eq 'true' -and $global:OSType -ne "Docker" -and $LatestImagemagickversion -gt $CurrentImagemagickversion -and $global:OSarch -ne "Arm64") {
    if ($global:OSType -eq "Win32NT") {
        Remove-Item -LiteralPath $magickinstalllocation -Recurse -Force
    }
    Else {
        Remove-Item -LiteralPath "$global:ScriptRoot/magick" -Force
    }
    if ($global:OSType -ne "Win32NT") {
        if ($global:OSType -ne "Docker") {
            Write-Entry -Subtext "Downloading the latest Imagemagick portable version for you..." -Path $configLogging -Color Cyan -log Info
            $magickUrl = "https://imagemagick.org/archive/binaries/magick"
            Invoke-WebRequest -Uri $magickUrl -OutFile "$global:ScriptRoot/magick"
            chmod +x "$global:ScriptRoot/magick"
            Write-Entry -Subtext "Made the portable Magick executable..." -Path $configLogging -Color Green -log Info
        }
    }
    else {
        Write-Entry -Subtext "Downloading the latest Imagemagick portable version for you..." -Path $configLogging -Color Cyan -log Info
        $result = Invoke-WebRequest "https://imagemagick.org/archive/binaries/?C=M;O=D"
        $LatestRelease = ($result.links.href | Where-Object { $_ -like '*portable-Q16-HDRI-x64.zip' } | Sort-Object -Descending)[0]
        $DownloadPath = Join-Path -Path $global:ScriptRoot -ChildPath (Join-Path -Path 'temp' -ChildPath $LatestRelease)
        Invoke-WebRequest "https://imagemagick.org/archive/binaries/$LatestRelease" -OutFile $DownloadPath
        Expand-Archive -Path $DownloadPath -DestinationPath $magickinstalllocation -Force
        if ((Get-ChildItem -Directory -LiteralPath $magickinstalllocation).name -eq $($LatestRelease.replace('.zip', ''))) {
            Copy-item -Force -Recurse "$magickinstalllocation\$((Get-ChildItem -Directory -LiteralPath $magickinstalllocation).name)\*" $magickinstalllocation
            Remove-Item -Recurse -LiteralPath "$magickinstalllocation\$((Get-ChildItem -Directory -LiteralPath $magickinstalllocation).name)" -Force
        }
        if (Test-Path -LiteralPath $magickinstalllocation\magick.exe) {
            Write-Entry -Subtext "Placed Portable ImageMagick here: $magickinstalllocation" -Path $configLogging -Color Green -log Info
        }
        Else {
            Write-Entry -Subtext "Error During extraction, please manually install/copy portable Imagemagick from here: https://imagemagick.org/archive/binaries/$LatestRelease" -Path $configLogging -Color Red -log Error
        }
    }
}

# Create directories if they don't exist
foreach ($path in $LogsPath, $TempPath, $TestPath, $AssetPath) {
    if (!(Test-Path $path)) {
        if ($global:OSType -ne "Win32NT" -and $path -eq 'P:\assets') {
            Write-Entry -Message 'Please change default asset Path...' -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                Remove-Item -LiteralPath $CurrentlyRunning | out-null
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Default asset path"
            }
            Exit
        }
        New-Item -ItemType Directory -Path $path -Force | Out-Null
    }
}
# create cache dir if missing
if (!(Test-Path $global:ScriptRoot\Cache)) {
    New-Item -ItemType Directory -Path $global:ScriptRoot\Cache -Force | Out-Null
}
# Check temp dir if there is a Currently running file present
$CurrentlyRunning = Join-Path $TempPath 'Posterizarr.Running'

if ($ForceRunningDeletion -eq 'true') {
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
}

if (Test-Path $CurrentlyRunning) {
    Write-Entry -Message "Another Posterizarr instance already running, exiting now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    Write-Entry -Subtext "If its a false positive message you can manually delete the 'Posterizarr.Running' file in temp dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Warning
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "down" -msg "Another instance running"
    }
    Exit
}
Else {
    New-Item -Path $CurrentlyRunning -Force | out-null

    if ($Tautulli) {
        Write-Entry -Message "Recently Added running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($Testing) {
        Write-Entry -Message "Testing running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($Manual) {
        Write-Entry -Message "Manual running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($SyncJelly) {
        Write-Entry -Message "SyncJelly running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($SyncEmby) {
        Write-Entry -Message "SyncEmby running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($Backup) {
        Write-Entry -Message "Backup running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Else {
        Write-Entry -Message "Posterizarr running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
}
# Delete all files and subfolders within the temp directory
if (Test-Path $TempPath) {
    Get-ChildItem -Path (Join-Path $TempPath '*') -Recurse | Where-Object { $_.Name -ne 'Posterizarr.Running' } | Remove-Item -Force
    Write-Entry -Message "Deleting temp folder: $TempPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
}
if ($Testing) {
    if ((Test-Path $TestPath)) {
        Remove-Item -Path (Join-Path $TestPath '*') -Recurse -Force
        Write-Entry -Message "Deleting test folder: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
}

# Test and download files if they don't exist
if ($config.PrerequisitePart.overlayfile -eq 'overlay.png' -or $config.PrerequisitePart.seasonoverlayfile -eq 'overlay.png') {
    Test-And-Download -url "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/overlay.png" -destination (Join-Path $global:ScriptRoot 'overlay.png')
}
if ($config.PrerequisitePart.backgroundoverlayfile -eq 'backgroundoverlay.png' -or $config.PrerequisitePart.titlecardoverlayfile -eq 'backgroundoverlay.png') {
    Test-And-Download -url "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/backgroundoverlay.png" -destination (Join-Path $global:ScriptRoot 'backgroundoverlay.png')
}
if ($config.PrerequisitePart.font -eq 'Rocky.ttf' -or $config.PrerequisitePart.backgroundfont -eq 'Rocky.ttf' -or $config.PrerequisitePart.titlecardfont -eq 'Rocky.ttf' -or $config.PrerequisitePart.RTLFont -eq 'Rocky.ttf') {
    Test-And-Download -url "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/Rocky.ttf" -destination (Join-Path $global:ScriptRoot 'Rocky.ttf')
}
if ($config.PrerequisitePart.font -eq 'Colus-Regular.ttf' -or $config.PrerequisitePart.backgroundfont -eq 'Colus-Regular.ttf' -or $config.PrerequisitePart.titlecardfont -eq 'Colus-Regular.ttf' -or $config.PrerequisitePart.RTLFont -eq 'Colus-Regular.ttf') {
    Test-And-Download -url "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/Colus-Regular.ttf" -destination (Join-Path $global:ScriptRoot 'Colus-Regular.ttf')
}

# Write log message
Write-Entry -Message "Old log files cleared..." -Path $configLogging -Color White -log Info
# Display Current Config settings:
LogConfigSettings
# Starting main Script now...
Write-Entry -Message "Starting main Script now..." -Path $configLogging -Color Green -log Info

# Fix asset path based on OS (do it here so that we see what is in config.json versus what script should use)
if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
    $AssetPath = $AssetPath.Replace('\', '/')
}
else {
    $AssetPath = $AssetPath.Replace('/', '\')
}

# Fix backup path based on OS (do it here so that we see what is in config.json versus what script should use)
if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
    $BackupPath = $BackupPath.Replace('\', '/')
}
else {
    $BackupPath = $BackupPath.Replace('/', '\')
}

# Get files in script root with specified extensions
try {
    $files = Get-ChildItem -Path $global:ScriptRoot -File | Where-Object { $_.Extension -in $fileExtensions } -ErrorAction SilentlyContinue
}
catch {
    Write-Entry -Subtext "Error retrieving files: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
}

# Copy files to the destination directory
foreach ($file in $files) {
    try {
        Write-Entry -Subtext "Trying to copy '$file' into temp dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $destinationPath = Join-Path -Path (Join-Path -Path $global:ScriptRoot -ChildPath 'temp') -ChildPath $file.Name

        if (!(Test-Path -LiteralPath $destinationPath)) {
            Copy-Item -Path $file.FullName -Destination $destinationPath -Force -ErrorAction Stop
            Write-Entry -Subtext "Found File: '$($file.Name)' in ScriptRoot - copying it into temp folder..." -Path $configLogging -Color Cyan -log Info
        }

        # Check if the file is a font (.ttf or .otf)
        if ($file.Extension -match "\.(ttf|otf)$" -and $env:POSTERIZARR_NON_ROOT -eq 'TRUE') {
            $fontDestination = Join-Path -Path $Font_Cache -ChildPath $file.Name

            Write-Entry -Subtext "Copying font '$($file.Name)' to ImageMagick cache..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            Copy-Item -Path $file.FullName -Destination $fontDestination -Force -ErrorAction Stop

            # Ensure font cache directory exists
            if (!(Test-Path -Path $IM_Font_Cache)) {
                New-Item -ItemType Directory -Path $IM_Font_Cache -Force | Out-Null
            }
        }
    }
    catch {
        Write-Entry -Subtext "Error copying file '$file': $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
}

# Refresh font cache if any fonts were copied
if ($files.Extension -match "\.(ttf|otf)$" -and $env:POSTERIZARR_NON_ROOT -eq 'TRUE') {
    Write-Entry -Subtext "Updating ImageMagick font cache..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    & fc-cache -fv 1> $null 2> $null
}

CheckJsonPaths -font "$font" -RTLfont "$RTLfont" -backgroundfont "$backgroundfont "-titlecardfont "$titlecardfont" -Posteroverlay "$Posteroverlay" -Backgroundoverlay "$Backgroundoverlay" -titlecardoverlay "$titlecardoverlay" -Seasonoverlay "$Seasonoverlay" -Posteroverlay4k "$4kposter" -Posteroverlay1080p "$1080pPoster"
# Check Plex now:
if (!$SyncJelly -and !$SyncEmby) {
    if ($UsePlex -eq 'true') {
        [xml]$Libs = CheckPlexAccess -PlexUrl $PlexUrl -PlexToken $PlexToken
    }

    if ($UseJellyfin -eq 'true') {
        # Check Jellyfin now:
        CheckJellyfinAccess -JellyfinUrl $JellyfinUrl -JellyfinApi $JellyfinAPIKey
    }
    if ($UseEmby -eq 'true') {
        # Check Emby now:
        CheckEmbyAccess -EmbyUrl $EmbyUrl -EmbyAPI $EmbyAPIKey
    }
}
# Check overlay artwork for poster, background, and titlecard dimensions
Write-Entry -Message "Checking size of overlay files..." -Path $configLogging -Color White -log Info
CheckOverlayDimensions -Posteroverlay "$Posteroverlay" -Backgroundoverlay "$Backgroundoverlay" -Titlecardoverlay "$titlecardoverlay" -PosterSize "$PosterSize" -BackgroundSize "$BackgroundSize" -Seasonoverlay "$Seasonoverlay" -Posteroverlay4k "$4kposter" -Posteroverlay1080p "$1080pPoster"

# Check if the FanartTvAPI module is installed
$module = Get-Module -ListAvailable -Name FanartTvAPI

if (-not $module) {
    # Try to install the module
    try {
        Install-Module -Name $moduleName -Force -SkipPublisherCheck -AllowPrerelease -Scope AllUsers
        Write-Entry -Message "FanartTvAPI Module missing, installing it for you..." -Path $configLogging -Color Red -log Error
        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        $errorCount++
        Write-Entry -Subtext "FanartTvAPI Module installed, importing it now..." -Path $configLogging -Color Green -log Info
        Import-Module -Name FanartTvAPI
    }
    catch {
        Write-Host "Failed to install $moduleName module. Error: $_"
    }
}
# Add Fanart API
Add-FanartTvAPIKey -Api_Key $FanartTvAPIKey

# Check TMDB Token before building the Header.
if ($global:tmdbtoken.Length -le '35') {
    Write-Entry -Message "TMDB Token is too short, you may have used the API key in your config file. Please use the 'API Read Access Token'." -Path $configLogging -Color Red -log Error
    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "down" -msg "Wrong TMDB token"
    }
    Exit
}

$maxRetries = 6
$retryCount = 0
$success = $false
Write-Entry -Message "Trying to receive a TVDB Token..." -Path $configLogging -Color White -log Info

while (-not $success -and $retryCount -lt $maxRetries) {
    try {
        # tvdb token Header
        $global:apiUrl = "https://api4.thetvdb.com/v4/login"
        if ($global:tvdbpin) {
            $global:requestBody = @{
                apikey = $global:tvdbapi
                pin    = $global:tvdbpin
            } | ConvertTo-Json
        }
        Else {
            $global:requestBody = @{
                apikey = $global:tvdbapi
            } | ConvertTo-Json
        }
        # tvdb Header
        $global:tvdbtokenheader = @{
            'accept'       = 'application/json'
            'Content-Type' = 'application/json'
        }

        # Make tvdb the POST request
        $global:tvdbtoken = (Invoke-RestMethod -Uri $global:apiUrl -Headers $global:tvdbtokenheader -Method Post -Body $global:requestBody).data.token
        $global:tvdbheader = @{}
        $global:tvdbheader.Add("accept", "application/json")
        $global:tvdbheader.Add("Authorization", "Bearer $global:tvdbtoken")

        if ($global:tvdbtoken) {
            $success = $true
            Write-Entry -Subtext "Successfully received a TVDB Token" -Path $configLogging -Color Green -log Info
        }

    }
    catch {
        $retryCount++

        if ($retryCount -lt $maxRetries) {
            Start-Sleep -Seconds 10  # Wait for 10 seconds before the next retry
        }
        else {
            if ($global:FavProvider -eq 'TVDB') {
                Write-Entry -Subtext "Could not receive a TVDB Token - $($retryCount)/$($maxRetries) - you may have used an legacy API key in your config file. Please use an 'Project Api Key'" -Path $configLogging -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Could not receive a TVDB Token"
                }
                Exit
            }
            Else {
                Write-Entry -Subtext "Could not receive a TVDB Token - $($retryCount)/$($maxRetries) - you may have used an legacy API key in your config file. Please use an 'Project Api Key'" -Path $configLogging -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
                break
            }
        }
    }
}

# tmdb Header
$global:headers = @{}
$global:headers.Add("accept", "application/json")
$global:headers.Add("Authorization", "Bearer $global:tmdbtoken")



# Plex Headers
$extraPlexHeaders = @{
    'X-Plex-Container-Size' = '1000'
}

#### MAIN SCRIPT START ####
if ($Manual) {
    Write-Entry -Message "Manual Poster Creation Started" -Path $global:ScriptRoot\Logs\Manuallog.log -Color DarkMagenta -log Info
    $PicturePath = Read-Host "Enter local path or url to source picture"
    $FolderName = Read-Host "Enter Media Foldername (how plex sees it)"
    $Titletext = Read-Host "Enter Movie/Show Title"
    $CreateSeasonPoster = Read-Host "Create Season Poster? (y/n)"
    $CreateTitleCard = Read-Host "Create TitleCard? (y/n)"

    if ($PicturePath -like 'http*') {
        $isWebPic = 'true'
        $PicturePath = $PicturePath.replace('"', '')
    }
    Else {
        $PicturePath = $PicturePath.replace('"', '')
    }
    $FolderName = $FolderName.replace('"', '')
    $Titletext = $Titletext.replace('"', '')

    if ($LibraryFolders -eq 'true') {
        $LibraryName = Read-Host "Enter Plex Library Name"
        $LibraryName = $LibraryName.replace('"', '')
        $PosterImageoriginal = "$AssetPath\$LibraryName\$FolderName\poster.jpg"
        if ($CreateSeasonPoster -eq 'y') {
            $SeasonPosterName = Read-Host "Enter Season Name"
            if ($SeasonPosterName -match 'Season\s+(\d+)') {
                $global:SeasonNumber = $Matches[1]
                $global:season = "Season" + $global:SeasonNumber.PadLeft(2, '0')
            }
            if ($SeasonPosterName -eq 'Specials') {
                $global:season = "Season00"
            }
            $PosterImageoriginal = "$AssetPath\$LibraryName\$FolderName\$global:season.jpg"
        }
        if ($CreateTitleCard -eq 'y') {
            $EPTitleName = Read-Host "Enter Episode Title Name"
            $EpisodeNumber = Read-Host "Enter Episode Number (eq. 1)"
            $SeasonName = Read-Host "Enter Season Number (eq. 1)"
            if ($SeasonName -match '(\d+)') {
                $global:SeasonNumber = $Matches[1]
                $global:season = "S" + $global:SeasonNumber.PadLeft(2, '0')
            }
            if ($SeasonName -eq 'Specials') {
                $global:season = "S00"
            }
            if ($EpisodeNumber -match '(\d+)') {
                $global:EpisodeNumber = $Matches[1]
                $global:episode = "E" + $global:EpisodeNumber.PadLeft(2, '0')
            }
            $PosterImageoriginal = "$AssetPath\$LibraryName\$FolderName\$global:season$global:episode.jpg"
        }
    }
    Else {
        if ($CreateSeasonPoster -eq 'y') {
            $SeasonPosterName = Read-Host "Enter Season Name"
            if ($SeasonPosterName -match 'Season\s+(\d+)') {
                $global:SeasonNumber = $Matches[1]
                $global:season = "Season" + $global:SeasonNumber.PadLeft(2, '0')
            }
            if ($SeasonPosterName -eq 'Specials') {
                $global:season = "Season00"
            }
            $PosterImageoriginal = "$AssetPath\$($FolderName)_$global:season.jpg"
        }
        if ($CreateTitleCard -eq 'y') {
            $EPTitleName = Read-Host "Enter Episode Title Name"
            $EpisodeNumber = Read-Host "Enter Episode Number (eq. 1)"
            $SeasonName = Read-Host "Enter Season Number (eq. 1)"
            if ($SeasonName -match '(\d+)') {
                $global:SeasonNumber = $Matches[1]
                $global:season = "S" + $global:SeasonNumber.PadLeft(2, '0')
            }
            if ($SeasonName -eq 'Specials') {
                $global:season = "S00"
            }
            if ($EpisodeNumber -match '(\d+)') {
                $global:EpisodeNumber = $Matches[1]
                $global:episode = "E" + $global:EpisodeNumber.PadLeft(2, '0')
            }
            $PosterImageoriginal = "$AssetPath\$($FolderName)_$global:season$global:episode.jpg"
        }
    }

    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$FolderName.jpg"
    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
    if ($global:ImageProcessing -eq 'true') {
        if ($CreateSeasonPoster -eq 'y') {
            $Posteroverlay = $Seasonoverlay
            if ($AddShowTitletoSeason -eq 'true') {
                if ($fontAllCaps -eq 'true') {
                    $joinedTitle = $SeasonPosterName.ToUpper()
                }
                Else {
                    $joinedTitle = $SeasonPosterName
                }

                if ($ShowOnSeasonfontAllCaps -eq 'true') {
                    $ShowjoinedTitle = $titletext.ToUpper()
                }
                Else {
                    $ShowjoinedTitle = $titletext
                }
            }
            Else {
                if ($fontAllCaps -eq 'true') {
                    $joinedTitle = $SeasonPosterName.ToUpper()
                }
                Else {
                    $joinedTitle = $SeasonPosterName
                }
            }
        }
        elseif ($CreateTitleCard -eq 'y') {
            $Posteroverlay = $titlecardoverlay
            if ($AddTitleCardEPTitleText -eq 'true') {
                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                    $joinedTitle = $EPTitleName.ToUpper()
                }
                Else {
                    $joinedTitle = $EPTitleName
                }
            }
            if ($AddTitleCardEPText -eq 'true') {
                $Posteroverlay = $titlecardoverlay
                $bullet = [char]0x2022
                $global:SeasonEPNumber = "$SeasonTCText $global:SeasonNumber $bullet $EpisodeTCText $global:EpisodeNumber"

                if ($TitleCardEPfontAllCaps -eq 'true') {
                    $EPNumberTitle = $global:SeasonEPNumber.ToUpper()
                }
                Else {
                    $EPNumberTitle = $global:SeasonEPNumber
                }
            }
        }
        Else {
            if ($fontAllCaps -eq 'true') {
                $joinedTitle = $Titletext.ToUpper()
            }
            Else {
                $joinedTitle = $Titletext
            }
        }
        if ($isWebPic -eq 'true') {
            Write-Entry -Subtext "Downloading Image from: $PicturePath" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
            Invoke-WebRequest -Uri $PicturePath -OutFile $PosterImage
        }
        Else {
            Move-Item -LiteralPath $PicturePath -destination $PosterImage -Force -ErrorAction SilentlyContinue
        }
        Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info

        $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
        $CommentlogEntry = "`"$magick`" $CommentArguments"
        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
        if (!$global:ImageMagickError -eq 'true') {
            if ($CreateSeasonPoster -eq 'y') {
                if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
            }
            elseif ($CreateTitleCard -eq 'y') {
                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
            }
            Else {
                # Resize Image to 2000x3000 and apply Border and overlay
                if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
            }
            $logEntry = "`"$magick`" $Arguments"
            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
            InvokeMagickCommand -Command $magick -Arguments $Arguments

            if ($AddText -eq 'true' -or $AddSeasonText -eq 'true' -or $AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
                $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                if ($AddShowTitletoSeason -eq 'true') {
                    $ShowjoinedTitle = $ShowjoinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                    # Loop through each symbol and replace it with a newline
                    if ($NewLineOnSpecificSymbols -eq 'true') {
                        foreach ($symbol in $NewLineSymbols) {
                            $ShowjoinedTitle = $ShowjoinedTitle -replace [regex]::Escape($symbol), "`n"
                        }
                    }
                    $ShowjoinedTitlePointSize = $ShowjoinedTitle -replace '""', '""""'
                    $showoptimalFontSize = Get-OptimalPointSize -text $ShowjoinedTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                    Write-Entry -Subtext "Optimal show font size set to: '$showoptimalFontSize'" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info

                }
                if ($AddTitleCardEPText -eq 'true') {
                    $EPNumberjoinedTitle = $EPNumberTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                    $EPNumberjoinedTitlePointSize = $EPNumberjoinedTitle -replace '""', '""""'
                    $EPNumberoptimalFontSize = Get-OptimalPointSize -text $EPNumberjoinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                    Write-Entry -Subtext "Optimal EP Number font size set to: '$EPNumberoptimalFontSize'" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info

                }
                # Loop through each symbol and replace it with a newline
                if ($NewLineOnSpecificSymbols -eq 'true') {
                    foreach ($symbol in $NewLineSymbols) {
                        $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                    }
                }

                $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                if ($CreateSeasonPoster -eq 'y') {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                }
                elseif ($CreateTitleCard -eq 'y') {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                }
                Else {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                }
                Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                if ($CreateSeasonPoster -eq 'y') {
                    # Add Stroke
                    if ($AddSeasonTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    if ($AddShowTitletoSeason -eq 'true') {
                        # Show Part
                        # Add Stroke
                        if ($AddShowOnSeasonTextStroke -eq 'true') {
                            $ShowOnSeasonArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$showoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShowjoinedTitle`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                        Else {
                            $ShowOnSeasonArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$showoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShowjoinedTitle`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                    }
                }
                if ($CreateTitleCard -eq 'y') {
                    # Add Stroke
                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    if ($AddTitleCardEPText -eq 'true') {
                        # EP Number Part
                        # Add Stroke
                        if ($AddTitleCardTextStroke -eq 'true') {
                            $EPNumberArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$EPNumberoptimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EPNumberjoinedTitle`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                        Else {
                            $EPNumberArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$EPNumberoptimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EPNumberjoinedTitle`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                    }
                }
                Else {
                    # Add Stroke
                    if ($AddTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                }
                if ($CreateSeasonPoster -eq 'y') {
                    Write-Entry -Subtext "    Applying Season Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                    if ($AddShowTitletoSeason -eq 'true') {
                        Write-Entry -Subtext "    Applying showTitle text: `"$ShowjoinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                    }
                }
                elseif ($CreateTitleCard -eq 'y') {
                    Write-Entry -Subtext "    Applying TitleCard Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                    if ($AddTitleCardEPText -eq 'true') {
                        Write-Entry -Subtext "    Applying Season + EP text: `"$EPNumberjoinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        $logEntry = "`"$magick`" $EPNumberArguments"
                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                        InvokeMagickCommand -Command $magick -Arguments $EPNumberArguments
                    }
                }
                Else {
                    Write-Entry -Subtext "    Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                }
            }
        }
    }
    Else {
        # Resize Image to 2000x3000
        $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
        $logEntry = "`"$magick`" $Resizeargument"
        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
    }
    if (!$global:ImageMagickError -eq 'true') {
        # Move file back to original naming with Brackets.
        Move-Item -LiteralPath $PosterImage -destination $PosterImageoriginal -Force -ErrorAction SilentlyContinue
        Write-Entry -Subtext "Poster created and moved to: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Manuallog.log -Color Green -log Info
    }

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
Elseif ($Testing) {
    Write-Entry -Message "Poster Testing Started" -Path $global:ScriptRoot\Logs\Testinglog.log -Color DarkMagenta -log Info
    Write-Entry -Subtext "I will now create a few posters for you with different text lengths using your current configuration settings." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Yellow -log Warning
    # Poster Part
    if (!(Test-Path $testimage)) {
        $ArgumentCreate = "-size `"$PosterSize`" xc:pink -background none `"$testimage`""
        $logEntryCreate = "`"$magick`" $ArgumentCreate"
        $logEntryCreate | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $ArgumentCreate
        Write-Entry -Subtext "Test Poster Created..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Cyan -log Info
    }
    if (!(Test-Path $backgroundtestimage)) {
        $backgroundArgumentCreate = "-size `"$BackgroundSize`" xc:pink -background none `"$backgroundtestimage`""
        $backgroundlogEntryCreate = "`"$magick`" $backgroundArgumentCreate"
        $backgroundlogEntryCreate | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentCreate
        Write-Entry -Subtext "Test Background/TitleCard Created..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Cyan -log Info
    }
    $ShortText = "The Hobbit"
    $MediumText = "The Hobbit is a great movie"
    $LongText = "The Hobbit is a great movie that we all loved and enjoyed watching"
    $bullet = [char]0x2022
    $Episodetext = "$SeasonTCText 9999 $bullet $EpisodeTCText 9999"

    $ShortTextCAPS = $ShortText.ToUpper()
    $MediumTextCAPS = $MediumText.ToUpper()
    $LongTextCAPS = $LongText.ToUpper()
    $EpisodetextCAPS = $Episodetext.ToUpper()
    # Posters
    if ($AddText -eq 'true') {
        $TestPosterShort = Join-Path -Path $global:ScriptRoot -ChildPath "test\posterShortText.jpg"
        $TestPosterMedium = Join-Path -Path $global:ScriptRoot -ChildPath "test\posterMediumText.jpg"
        $TestPosterLong = Join-Path -Path $global:ScriptRoot -ChildPath "test\posterLongText.jpg"
        $TestPosterShortCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\posterShortTextCAPS.jpg"
        $TestPosterMediumCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\posterMediumTextCAPS.jpg"
        $TestPosterLongCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\posterLongTextCAPS.jpg"
    }
    Else {
        $TestPosterTextless = Join-Path -Path $global:ScriptRoot -ChildPath "test\PosterTextless.jpg"
    }

    # Season Posters
    if ($AddSeasonText -eq 'true') {
        $TestSeasonPosterShort = Join-Path -Path $global:ScriptRoot -ChildPath "test\SeasonPosterShortText.jpg"
        $TestSeasonPosterMedium = Join-Path -Path $global:ScriptRoot -ChildPath "test\SeasonPosterMediumText.jpg"
        $TestSeasonPosterLong = Join-Path -Path $global:ScriptRoot -ChildPath "test\SeasonPosterLongText.jpg"
        $TestSeasonPosterShortCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\SeasonPosterShortTextCAPS.jpg"
        $TestSeasonPosterMediumCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\SeasonPosterMediumTextCAPS.jpg"
        $TestSeasonPosterLongCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\SeasonPosterLongTextCAPS.jpg"
    }
    Else {
        $TestSeasonPosterTextless = Join-Path -Path $global:ScriptRoot -ChildPath "test\SeasonPosterTextless.jpg"
    }
    # Backgrounds
    if ($AddBackgroundText -eq 'true') {
        $backgroundTestPosterShort = Join-Path -Path $global:ScriptRoot -ChildPath "test\backgroundShortText.jpg"
        $backgroundTestPosterMedium = Join-Path -Path $global:ScriptRoot -ChildPath "test\backgroundMediumText.jpg"
        $backgroundTestPosterLong = Join-Path -Path $global:ScriptRoot -ChildPath "test\backgroundLongText.jpg"
        $backgroundTestPosterShortCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\backgroundShortTextCAPS.jpg"
        $backgroundTestPosterMediumCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\backgroundMediumTextCAPS.jpg"
        $backgroundTestPosterLongCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\backgroundLongTextCAPS.jpg"
    }
    Else {
        $BackgroundTestPosterTextless = Join-Path -Path $global:ScriptRoot -ChildPath "test\BackgroundTextless.jpg"
    }

    # TitleCards
    if ($AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        $TitleCardTestPosterShort = Join-Path -Path $global:ScriptRoot -ChildPath "test\TitleCardShortText.jpg"
        $TitleCardTestPosterMedium = Join-Path -Path $global:ScriptRoot -ChildPath "test\TitleCardMediumText.jpg"
        $TitleCardTestPosterLong = Join-Path -Path $global:ScriptRoot -ChildPath "test\TitleCardLongText.jpg"
        $TitleCardTestPosterShortCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\TitleCardShortTextCAPS.jpg"
        $TitleCardTestPosterMediumCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\TitleCardMediumTextCAPS.jpg"
        $TitleCardTestPosterLongCAPS = Join-Path -Path $global:ScriptRoot -ChildPath "test\TitleCardLongTextCAPS.jpg"
    }
    Else {
        $TitleCardTestPosterTextless = Join-Path -Path $global:ScriptRoot -ChildPath "test\TitleCardTextless.jpg"
    }

    if ($AddText -eq 'true' -or $AddBackgroundText -eq 'true' -or $AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        Write-Entry -Subtext "Calculating Optimal Font Sizes. This may take a while..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Cyan -log Info
    }
    $TruncatedCount = 0
    # Optimal Poster Font Size
    if ($AddText -eq 'true') {
        $optimalFontSizeShort = Get-OptimalPointSize -text $ShortText -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $optimalFontSizeMedium = Get-OptimalPointSize -text $MediumText -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $optimalFontSizeLong = Get-OptimalPointSize -text $LongText -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }

        $optimalFontSizeShortCAPS = Get-OptimalPointSize -text $ShortTextCAPS -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $optimalFontSizeMediumCAPS = Get-OptimalPointSize -text $MediumTextCAPS -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $optimalFontSizeLongCAPS = Get-OptimalPointSize -text $LongTextCAPS -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        Write-Entry -Subtext "Finished Optimal Font Sizes for posters..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Cyan -log Info
    }
    # Optimal Season Poster Font Size
    if ($AddSeasonText -eq 'true') {
        if ($AddShowTitletoSeason -eq 'true') {
            # Title
            $ShowoptimalFontSizeShort = Get-OptimalPointSize -text $ShortText -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $ShowoptimalFontSizeMedium = Get-OptimalPointSize -text $MediumText -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $ShowoptimalFontSizeLong = Get-OptimalPointSize -text $LongText -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }

            $ShowoptimalFontSizeShortCAPS = Get-OptimalPointSize -text $ShortTextCAPS -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $ShowoptimalFontSizeMediumCAPS = Get-OptimalPointSize -text $MediumTextCAPS -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $ShowoptimalFontSizeLongCAPS = Get-OptimalPointSize -text $LongTextCAPS -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }

            # Season
            $seasonoptimalFontSizeShort = Get-OptimalPointSize -text $ShortText -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeMedium = Get-OptimalPointSize -text $MediumText -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeLong = Get-OptimalPointSize -text $LongText -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }

            $seasonoptimalFontSizeShortCAPS = Get-OptimalPointSize -text $ShortTextCAPS -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeMediumCAPS = Get-OptimalPointSize -text $MediumTextCAPS -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeLongCAPS = Get-OptimalPointSize -text $LongTextCAPS -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
        }
        Else {
            $seasonoptimalFontSizeShort = Get-OptimalPointSize -text $ShortText -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeMedium = Get-OptimalPointSize -text $MediumText -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeLong = Get-OptimalPointSize -text $LongText -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }

            $seasonoptimalFontSizeShortCAPS = Get-OptimalPointSize -text $ShortTextCAPS -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeMediumCAPS = Get-OptimalPointSize -text $MediumTextCAPS -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
            $seasonoptimalFontSizeLongCAPS = Get-OptimalPointSize -text $LongTextCAPS -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
        }
        Write-Entry -Subtext "Finished Optimal Font Sizes for season posters..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Cyan -log Info
    }
    # Optimal Background Font Size
    if ($AddBackgroundText -eq 'true') {
        $backgroundoptimalFontSizeShort = Get-OptimalPointSize -text $ShortText -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $backgroundoptimalFontSizeMedium = Get-OptimalPointSize -text $MediumText -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $backgroundoptimalFontSizeLong = Get-OptimalPointSize -text $LongText -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }

        $backgroundoptimalFontSizeShortCAPS = Get-OptimalPointSize -text $ShortTextCAPS -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $backgroundoptimalFontSizeMediumCAPS = Get-OptimalPointSize -text $MediumTextCAPS -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $backgroundoptimalFontSizeLongCAPS = Get-OptimalPointSize -text $LongTextCAPS -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        Write-Entry -Subtext "Finished Optimal Font Sizes for backgrounds..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Cyan -log Info
    }
    # Optimal TitleCard Font Size
    if ($AddTitleCardEPTitleText -eq 'true') {
        $TitleCardoptimalFontSizeShort = Get-OptimalPointSize -text $ShortText -font $titlecardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $TitleCardoptimalFontSizeMedium = Get-OptimalPointSize -text $MediumText -font $titlecardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $TitleCardoptimalFontSizeLong = Get-OptimalPointSize -text $LongText -font $titlecardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $TitleCardoptimalFontSizeShortCAPS = Get-OptimalPointSize -text $ShortTextCAPS -font $titlecardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $TitleCardoptimalFontSizeMediumCAPS = Get-OptimalPointSize -text $MediumTextCAPS -font $titlecardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $TitleCardoptimalFontSizeLongCAPS = Get-OptimalPointSize -text $LongTextCAPS -font $titlecardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
    }
    # Optimal TitleCard EP Font Size
    if ($AddTitleCardEPText -eq 'true') {
        $Episodetext = $Episodetext -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
        $TitleCardoptimalFontSizeEpisodetext = Get-OptimalPointSize -text $Episodetext -font $titlecardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
        $EpisodetextCAPS = $EpisodetextCAPS -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
        $TitleCardoptimalFontSizeEpisodetextCAPS = Get-OptimalPointSize -text $EpisodetextCAPS -font $titlecardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
    }
    if ($AddText -eq 'true' -or $AddBackgroundText -eq 'true' -or $AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        Write-Entry -Subtext "Finished Optimal Font Sizes for titlecards..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color Cyan -log Info
    }

    # Border/Overlay Poster Part

    Write-Entry -Subtext "Poster Part:" -Path $global:ScriptRoot\Logs\Testinglog.log -Color Green -log Info
    if ($AddText -eq 'true') {
        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
            $ArgumentsShort = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterShort`""
            $ArgumentsMedium = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterMedium`""
            $ArgumentsLong = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterLong`""
            $ArgumentsShortCAPS = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterShortCAPS`""
            $ArgumentsMediumCAPS = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterMediumCAPS`""
            $ArgumentsLongCAPS = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Poster Borders | Adding Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
            $ArgumentsShort = "`"$testimage`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterShort`""
            $ArgumentsMedium = "`"$testimage`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterMedium`""
            $ArgumentsLong = "`"$testimage`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterLong`""
            $ArgumentsShortCAPS = "`"$testimage`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterShortCAPS`""
            $ArgumentsMediumCAPS = "`"$testimage`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterMediumCAPS`""
            $ArgumentsLongCAPS = "`"$testimage`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Poster Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
            $ArgumentsShort = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$TestPosterShort`""
            $ArgumentsMedium = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$TestPosterMedium`""
            $ArgumentsLong = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$TestPosterLong`""
            $ArgumentsShortCAPS = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$TestPosterShortCAPS`""
            $ArgumentsMediumCAPS = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$TestPosterMediumCAPS`""
            $ArgumentsLongCAPS = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$TestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
            $ArgumentsShort = "`"$testimage`" -quality $global:outputQuality `"$TestPosterShort`""
            $ArgumentsMedium = "`"$testimage`" -quality $global:outputQuality `"$TestPosterMedium`""
            $ArgumentsLong = "`"$testimage`" -quality $global:outputQuality `"$TestPosterLong`""
            $ArgumentsShortCAPS = "`"$testimage`" -quality $global:outputQuality `"$TestPosterShortCAPS`""
            $ArgumentsMediumCAPS = "`"$testimage`" -quality $global:outputQuality `"$TestPosterMediumCAPS`""
            $ArgumentsLongCAPS = "`"$testimage`" -quality $global:outputQuality `"$TestPosterLongCAPS`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }

        # Poster Logging
        $logEntryShort = "`"$magick`" $ArgumentsShort"
        $logEntryMedium = "`"$magick`" $ArgumentsMedium"
        $logEntryLong = "`"$magick`" $ArgumentsLong"
        $logEntryShortCAPS = "`"$magick`" $ArgumentsShortCAPS"
        $logEntryMediumCAPS = "`"$magick`" $ArgumentsMediumCAPS"
        $logEntryLongCAPS = "`"$magick`" $ArgumentsLongCAPS"

        $logEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Test Poster creation
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsLongCAPS
    }
    Else {
        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
            $ArgumentsTextless = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterTextless`""
            Write-Entry -Subtext "Adding Poster Borders | Adding Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
            $ArgumentsTextless = "`"$testimage`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$TestPosterTextless`""
            Write-Entry -Subtext "Adding Poster Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
            $ArgumentsTextless = "`"$testimage`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$TestPosterTextless`""
            Write-Entry -Subtext "Adding Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
            $ArgumentsTextless = "`"$testimage`" -quality $global:outputQuality `"$TestPosterTextless`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        $PosterlogEntryTextless = "`"$magick`" $ArgumentsTextless"
        $PosterlogEntryTextless | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsTextless
    }
    # Text Poster overlay
    if ($AddText -eq 'true') {
        # Logging Poster
        Write-Entry -Subtext "Optimal font size for Short text is: '$optimalFontSizeShort'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$ShortText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium text is: '$optimalFontSizeMedium'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$MediumText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long text is: '$optimalFontSizeLong'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$LongText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        Write-Entry -Subtext "Optimal font size for Short CAPS text is: '$optimalFontSizeShortCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$ShortTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium CAPS text is: '$optimalFontSizeMediumCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$MediumTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long CAPS text is: '$optimalFontSizeLongCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$LongTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        # Add Stroke
        if ($AddTextStroke -eq 'true') {
            $ArgumentsShort = "`"$TestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeShort`" -fill `"#0000FF`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$ShortText`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterShort`""
            $ArgumentsMedium = "`"$TestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeMedium`" -fill `"#0000FF`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$MediumText`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterMedium`""
            $ArgumentsLong = "`"$TestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeLong`" -fill `"#0000FF`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$LongText`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterLong`""
            $ArgumentsShortCAPS = "`"$TestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeShortCAPS`" -fill `"#0000FF`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterShortCAPS`""
            $ArgumentsMediumCAPS = "`"$TestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeMediumCAPS`" -fill `"#0000FF`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterMediumCAPS`""
            $ArgumentsLongCAPS = "`"$TestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeLongCAPS`" -fill `"#0000FF`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterLongCAPS`""
        }
        Else {
            $ArgumentsShort = "`"$TestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeShort`" -fill `"#0000FF`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$ShortText`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterShort`""
            $ArgumentsMedium = "`"$TestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeMedium`" -fill `"#0000FF`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$MediumText`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterMedium`""
            $ArgumentsLong = "`"$TestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeLong`" -fill `"#0000FF`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$LongText`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterLong`""
            $ArgumentsShortCAPS = "`"$TestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeShortCAPS`" -fill `"#0000FF`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterShortCAPS`""
            $ArgumentsMediumCAPS = "`"$TestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeMediumCAPS`" -fill `"#0000FF`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterMediumCAPS`""
            $ArgumentsLongCAPS = "`"$TestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$optimalFontSizeLongCAPS`" -fill `"#0000FF`" -size `"$boxsize`" -background `"#ACD7E6`" -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$boxsize`" ) -gravity south -geometry +0+`"$text_offset`" -quality $global:outputQuality -composite `"$TestPosterLongCAPS`""
        }

        # Text Poster Logging
        $logEntryShort = "`"$magick`" $ArgumentsShort"
        $logEntryMedium = "`"$magick`" $ArgumentsMedium"
        $logEntryLong = "`"$magick`" $ArgumentsLong"
        $logEntryShortCAPS = "`"$magick`" $ArgumentsShortCAPS"
        $logEntryMediumCAPS = "`"$magick`" $ArgumentsMediumCAPS"
        $logEntryLongCAPS = "`"$magick`" $ArgumentsLongCAPS"

        $logEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $logEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Text Poster overlaying
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsLongCAPS
    }
    Else {
        Write-Entry -Subtext "    Applying textbox only to Poster..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        $ArgumentsNoText = "`"$TestPosterTextless`" -size `"$boxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$text_offset`" -compose over -composite `"$TestPosterTextless`""
        InvokeMagickCommand -Command $magick -Arguments $ArgumentsNoText
    }

    # Border/Overlay Season Poster Part

    Write-Entry -Subtext "Season Poster Part:" -Path $global:ScriptRoot\Logs\Testinglog.log -Color Green -log Info
    if ($AddSeasonText -eq 'true') {
        if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true') {
            $SeasonArgumentsShort = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterShort`""
            $SeasonArgumentsMedium = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterMedium`""
            $SeasonArgumentsLong = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterLong`""
            $SeasonArgumentsShortCAPS = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterShortCAPS`""
            $SeasonArgumentsMediumCAPS = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterMediumCAPS`""
            $SeasonArgumentsLongCAPS = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterLongCAPS`""
            Write-Entry -Subtext "Adding Season Poster Borders | Adding Season Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false') {
            $SeasonArgumentsShort = "`"$testimage`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterShort`""
            $SeasonArgumentsMedium = "`"$testimage`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterMedium`""
            $SeasonArgumentsLong = "`"$testimage`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterLong`""
            $SeasonArgumentsShortCAPS = "`"$testimage`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterShortCAPS`""
            $SeasonArgumentsMediumCAPS = "`"$testimage`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterMediumCAPS`""
            $SeasonArgumentsLongCAPS = "`"$testimage`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterLongCAPS`""
            Write-Entry -Subtext "Adding Season Poster Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true') {
            $SeasonArgumentsShort = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$TestSeasonPosterShort`""
            $SeasonArgumentsMedium = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$TestSeasonPosterMedium`""
            $SeasonArgumentsLong = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$TestSeasonPosterLong`""
            $SeasonArgumentsShortCAPS = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$TestSeasonPosterShortCAPS`""
            $SeasonArgumentsMediumCAPS = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$TestSeasonPosterMediumCAPS`""
            $SeasonArgumentsLongCAPS = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$TestSeasonPosterLongCAPS`""
            Write-Entry -Subtext "Adding Season Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'false') {
            $SeasonArgumentsShort = "`"$testimage`" -quality $global:outputQuality `"$TestSeasonPosterShort`""
            $SeasonArgumentsMedium = "`"$testimage`" -quality $global:outputQuality `"$TestSeasonPosterMedium`""
            $SeasonArgumentsLong = "`"$testimage`" -quality $global:outputQuality `"$TestSeasonPosterLong`""
            $SeasonArgumentsShortCAPS = "`"$testimage`" -quality $global:outputQuality `"$TestSeasonPosterShortCAPS`""
            $SeasonArgumentsMediumCAPS = "`"$testimage`" -quality $global:outputQuality `"$TestSeasonPosterMediumCAPS`""
            $SeasonArgumentsLongCAPS = "`"$testimage`" -quality $global:outputQuality `"$TestSeasonPosterLongCAPS`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }

        # Poster Logging
        $SeasonlogEntryShort = "`"$magick`" $SeasonArgumentsShort"
        $SeasonlogEntryMedium = "`"$magick`" $SeasonArgumentsMedium"
        $SeasonlogEntryLong = "`"$magick`" $SeasonArgumentsLong"
        $SeasonlogEntryShortCAPS = "`"$magick`" $SeasonArgumentsShortCAPS"
        $SeasonlogEntryMediumCAPS = "`"$magick`" $SeasonArgumentsMediumCAPS"
        $SeasonlogEntryLongCAPS = "`"$magick`" $SeasonArgumentsLongCAPS"

        $SeasonlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Test Poster creation
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsLongCAPS
    }
    Else {
        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
            $SeasonArgumentsTextless = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterTextless`""
            Write-Entry -Subtext "Adding Season Poster Borders | Adding Season Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
            $SeasonArgumentsTextless = "`"$testimage`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$TestSeasonPosterTextless`""
            Write-Entry -Subtext "Adding Season Poster Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
            $SeasonArgumentsTextless = "`"$testimage`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$TestSeasonPosterTextless`""
            Write-Entry -Subtext "Adding Season Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
            $SeasonArgumentsTextless = "`"$testimage`" -quality $global:outputQuality `"$TestSeasonPosterTextless`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        $PosterlogEntryTextless = "`"$magick`" $SeasonArgumentsTextless"
        $PosterlogEntryTextless | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsTextless
    }
    # Text Poster overlay
    if ($AddSeasonText -eq 'true') {
        # Logging Poster
        Write-Entry -Subtext "Optimal font size for Short text is: '$seasonoptimalFontSizeShort'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$ShortText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium text is: '$seasonoptimalFontSizeMedium'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$MediumText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long text is: '$seasonoptimalFontSizeLong'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$LongText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        Write-Entry -Subtext "Optimal font size for Short CAPS text is: '$seasonoptimalFontSizeShortCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$ShortTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium CAPS text is: '$seasonoptimalFontSizeMediumCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$MediumTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long CAPS text is: '$seasonoptimalFontSizeLongCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$LongTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        # Add Stroke
        if ($AddSeasonTextStroke -eq 'true') {
            $SeasonArgumentsShort = "`"$TestSeasonPosterShort`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeShort`" -fill `"#0000FF`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShort`""
            $SeasonArgumentsMedium = "`"$TestSeasonPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeMedium`" -fill `"#0000FF`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMedium`""
            $SeasonArgumentsLong = "`"$TestSeasonPosterLong`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeLong`" -fill `"#0000FF`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$LongText`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLong`""
            $SeasonArgumentsShortCAPS = "`"$TestSeasonPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShortCAPS`""
            $SeasonArgumentsMediumCAPS = "`"$TestSeasonPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMediumCAPS`""
            $SeasonArgumentsLongCAPS = "`"$TestSeasonPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLongCAPS`""
        }
        Else {
            $SeasonArgumentsShort = "`"$TestSeasonPosterShort`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeShort`" -fill `"#0000FF`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShort`""
            $SeasonArgumentsMedium = "`"$TestSeasonPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeMedium`" -fill `"#0000FF`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMedium`""
            $SeasonArgumentsLong = "`"$TestSeasonPosterLong`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeLong`" -fill `"#0000FF`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$LongText`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLong`""
            $SeasonArgumentsShortCAPS = "`"$TestSeasonPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShortCAPS`""
            $SeasonArgumentsMediumCAPS = "`"$TestSeasonPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMediumCAPS`""
            $SeasonArgumentsLongCAPS = "`"$TestSeasonPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$seasonoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -size `"$Seasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$Seasonboxsize`" ) -gravity south -geometry +0+`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLongCAPS`""
        }
        # Text Poster Logging
        $SeasonlogEntryShort = "`"$magick`" $SeasonArgumentsShort"
        $SeasonlogEntryMedium = "`"$magick`" $SeasonArgumentsMedium"
        $SeasonlogEntryLong = "`"$magick`" $SeasonArgumentsLong"
        $SeasonlogEntryShortCAPS = "`"$magick`" $SeasonArgumentsShortCAPS"
        $SeasonlogEntryMediumCAPS = "`"$magick`" $SeasonArgumentsMediumCAPS"
        $SeasonlogEntryLongCAPS = "`"$magick`" $SeasonArgumentsLongCAPS"

        $SeasonlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $SeasonlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Text Poster overlaying
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsLongCAPS
    }
    Else {
        Write-Entry -Subtext "    Applying textbox only to Season Poster..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        $SeasonArgumentsNoText = "`"$TestSeasonPosterTextless`" -size `"$Seasonboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$Seasontext_offset`" -compose over -composite `"$TestSeasonPosterTextless`""
        InvokeMagickCommand -Command $magick -Arguments $SeasonArgumentsNoText
    }
    # Show Text on Season Poster Part
    if ($AddShowTitletoSeason -eq 'true') {
        # Logging Poster
        Write-Entry -Subtext "Optimal font size for Short text is: '$ShowoptimalFontSizeShort'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$ShortText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium text is: '$ShowoptimalFontSizeMedium'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$MediumText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long text is: '$ShowoptimalFontSizeLong'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$LongText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        Write-Entry -Subtext "Optimal font size for Short CAPS text is: '$ShowoptimalFontSizeShortCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$ShortTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium CAPS text is: '$ShowoptimalFontSizeMediumCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$MediumTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long CAPS text is: '$ShowoptimalFontSizeLongCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$LongTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        # Add Stroke
        if ($AddSeasonTextStroke -eq 'true') {
            $ShowOnSeasonArgumentsShort = "`"$TestSeasonPosterShort`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeShort`" -fill `"#0000FF`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShort`""
            $ShowOnSeasonArgumentsMedium = "`"$TestSeasonPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeMedium`" -fill `"#0000FF`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMedium`""
            $ShowOnSeasonArgumentsLong = "`"$TestSeasonPosterLong`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeLong`" -fill `"#0000FF`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$LongText`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLong`""
            $ShowOnSeasonArgumentsShortCAPS = "`"$TestSeasonPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShortCAPS`""
            $ShowOnSeasonArgumentsMediumCAPS = "`"$TestSeasonPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMediumCAPS`""
            $ShowOnSeasonArgumentsLongCAPS = "`"$TestSeasonPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLongCAPS`""
        }
        Else {
            $ShowOnSeasonArgumentsShort = "`"$TestSeasonPosterShort`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeShort`" -fill `"#0000FF`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShort`""
            $ShowOnSeasonArgumentsMedium = "`"$TestSeasonPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeMedium`" -fill `"#0000FF`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMedium`""
            $ShowOnSeasonArgumentsLong = "`"$TestSeasonPosterLong`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeLong`" -fill `"#0000FF`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$LongText`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLong`""
            $ShowOnSeasonArgumentsShortCAPS = "`"$TestSeasonPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterShortCAPS`""
            $ShowOnSeasonArgumentsMediumCAPS = "`"$TestSeasonPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterMediumCAPS`""
            $ShowOnSeasonArgumentsLongCAPS = "`"$TestSeasonPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -size `"$ShowOnSeasonboxsize`" -background `"#ACD7E6`" -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$ShowOnSeasonboxsize`" ) -gravity south -geometry +0+`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$TestSeasonPosterLongCAPS`""
        }
        # Text Poster Logging
        $ShowOnSeasonlogEntryShort = "`"$magick`" $ShowOnSeasonArgumentsShort"
        $ShowOnSeasonlogEntryMedium = "`"$magick`" $ShowOnSeasonArgumentsMedium"
        $ShowOnSeasonlogEntryLong = "`"$magick`" $ShowOnSeasonArgumentsLong"
        $ShowOnSeasonlogEntryShortCAPS = "`"$magick`" $ShowOnSeasonArgumentsShortCAPS"
        $ShowOnSeasonlogEntryMediumCAPS = "`"$magick`" $ShowOnSeasonArgumentsMediumCAPS"
        $ShowOnSeasonlogEntryLongCAPS = "`"$magick`" $ShowOnSeasonArgumentsLongCAPS"

        $ShowOnSeasonlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $ShowOnSeasonlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $ShowOnSeasonlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $ShowOnSeasonlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $ShowOnSeasonlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $ShowOnSeasonlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Text Poster overlaying
        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArgumentsLongCAPS
    }

    Write-Entry -Subtext "Background Part:" -Path $global:ScriptRoot\Logs\Testinglog.log -Color Green -log Info
    # Border/Overlay Background Part
    if ($AddBackgroundText -eq 'true') {
        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
            $backgroundArgumentsShort = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterShort`""
            $backgroundArgumentsMedium = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterMedium`""
            $backgroundArgumentsLong = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterLong`""
            $backgroundArgumentsShortCAPS = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterShortCAPS`""
            $backgroundArgumentsMediumCAPS = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterMediumCAPS`""
            $backgroundArgumentsLongCAPS = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Background Borders | Adding Background Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
            $backgroundArgumentsShort = "`"$backgroundtestimage`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterShort`""
            $backgroundArgumentsMedium = "`"$backgroundtestimage`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterMedium`""
            $backgroundArgumentsLong = "`"$backgroundtestimage`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterLong`""
            $backgroundArgumentsShortCAPS = "`"$backgroundtestimage`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterShortCAPS`""
            $backgroundArgumentsMediumCAPS = "`"$backgroundtestimage`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterMediumCAPS`""
            $backgroundArgumentsLongCAPS = "`"$backgroundtestimage`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundTestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Background Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
            $backgroundArgumentsShort = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundTestPosterShort`""
            $backgroundArgumentsMedium = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundTestPosterMedium`""
            $backgroundArgumentsLong = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundTestPosterLong`""
            $backgroundArgumentsShortCAPS = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundTestPosterShortCAPS`""
            $backgroundArgumentsMediumCAPS = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundTestPosterMediumCAPS`""
            $backgroundArgumentsLongCAPS = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundTestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Background Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
            $backgroundArgumentsShort = "`"$backgroundtestimage`" -quality $global:outputQuality `"$backgroundTestPosterShort`""
            $backgroundArgumentsMedium = "`"$backgroundtestimage`" -quality $global:outputQuality `"$backgroundTestPosterMedium`""
            $backgroundArgumentsLong = "`"$backgroundtestimage`" -quality $global:outputQuality `"$backgroundTestPosterLong`""
            $backgroundArgumentsShortCAPS = "`"$backgroundtestimage`" -quality $global:outputQuality `"$backgroundTestPosterShortCAPS`""
            $backgroundArgumentsMediumCAPS = "`"$backgroundtestimage`" -quality $global:outputQuality `"$backgroundTestPosterMediumCAPS`""
            $backgroundArgumentsLongCAPS = "`"$backgroundtestimage`" -quality $global:outputQuality `"$backgroundTestPosterLongCAPS`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        # Background Logging
        $backgroundlogEntryShort = "`"$magick`" $backgroundArgumentsShort"
        $backgroundlogEntryMedium = "`"$magick`" $backgroundArgumentsMedium"
        $backgroundlogEntryLong = "`"$magick`" $backgroundArgumentsLong"
        $backgroundlogEntryShortCAPS = "`"$magick`" $backgroundArgumentsShortCAPS"
        $backgroundlogEntryMediumCAPS = "`"$magick`" $backgroundArgumentsMediumCAPS"
        $backgroundlogEntryLongCAPS = "`"$magick`" $backgroundArgumentsLongCAPS"

        $backgroundlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Test Background creation
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsLongCAPS
    }
    Else {
        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
            $BackgroundArgumentsTextless = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$BackgroundTestPosterTextless`""
            Write-Entry -Subtext "Adding Poster Borders | Adding Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
            $BackgroundArgumentsTextless = "`"$backgroundtestimage`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$BackgroundTestPosterTextless`""
            Write-Entry -Subtext "Adding Poster Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
            $BackgroundArgumentsTextless = "`"$backgroundtestimage`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$BackgroundTestPosterTextless`""
            Write-Entry -Subtext "Adding Poster Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
            $BackgroundArgumentsTextless = "`"$backgroundtestimage`" -quality $global:outputQuality `"$BackgroundTestPosterTextless`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        $BackgroundlogEntryTextless = "`"$magick`" $BackgroundArgumentsTextless"
        $BackgroundlogEntryTextless | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $BackgroundArgumentsTextless
    }
    # Text background overlay
    if ($AddBackgroundText -eq 'true') {
        # Logging Background
        Write-Entry -Subtext "Optimal font size for Short text is: '$backgroundoptimalFontSizeShort'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$ShortText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium text is: '$backgroundoptimalFontSizeMedium'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$MediumText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long text is: '$backgroundoptimalFontSizeLong'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$LongText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        Write-Entry -Subtext "Optimal font size for Short CAPS text is: '$backgroundoptimalFontSizeShortCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$ShortTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium CAPS text is: '$backgroundoptimalFontSizeMediumCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$MediumTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long CAPS text is: '$backgroundoptimalFontSizeLongCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$LongTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        # Add Stroke
        if ($AddBackgroundTextStroke -eq 'true') {
            $backgroundArgumentsShort = "`"$backgroundTestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeShort`" -fill `"#0000FF`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterShort`""
            $backgroundArgumentsMedium = "`"$backgroundTestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeMedium`" -fill `"#0000FF`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterMedium`""
            $backgroundArgumentsLong = "`"$backgroundTestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeLong`" -fill `"#0000FF`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$LongText`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterLong`""
            $backgroundArgumentsShortCAPS = "`"$backgroundTestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterShortCAPS`""
            $backgroundArgumentsMediumCAPS = "`"$backgroundTestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterMediumCAPS`""
            $backgroundArgumentsLongCAPS = "`"$backgroundTestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterLongCAPS`""
        }
        Else {
            $backgroundArgumentsShort = "`"$backgroundTestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeShort`" -fill `"#0000FF`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterShort`""
            $backgroundArgumentsMedium = "`"$backgroundTestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeMedium`" -fill `"#0000FF`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterMedium`""
            $backgroundArgumentsLong = "`"$backgroundTestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeLong`" -fill `"#0000FF`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$LongText`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterLong`""
            $backgroundArgumentsShortCAPS = "`"$backgroundTestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterShortCAPS`""
            $backgroundArgumentsMediumCAPS = "`"$backgroundTestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterMediumCAPS`""
            $backgroundArgumentsLongCAPS = "`"$backgroundTestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$backgroundfontImagemagick`" -pointsize `"$backgroundoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -size `"$Backgroundboxsize`" -background `"#ACD7E6`" -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$Backgroundboxsize`" ) -gravity south -geometry +0+`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundTestPosterLongCAPS`""
        }
        # Text background Logging
        $backgroundlogEntryShort = "`"$magick`" $backgroundArgumentsShort"
        $backgroundlogEntryMedium = "`"$magick`" $backgroundArgumentsMedium"
        $backgroundlogEntryLong = "`"$magick`" $backgroundArgumentsLong"
        $backgroundlogEntryShortCAPS = "`"$magick`" $backgroundArgumentsShortCAPS"
        $backgroundlogEntryMediumCAPS = "`"$magick`" $backgroundArgumentsMediumCAPS"
        $backgroundlogEntryLongCAPS = "`"$magick`" $backgroundArgumentsLongCAPS"

        $backgroundlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $backgroundlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Text Background overlaying
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $backgroundArgumentsLongCAPS
    }
    Else {
        Write-Entry -Subtext "    Applying textbox only to Background..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        $BackgroundArgumentsNoText = "`"$BackgroundTestPosterTextless`" -size `"$Backgroundboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$Backgroundtext_offset`" -compose over -composite `"$BackgroundTestPosterTextless`""
        InvokeMagickCommand -Command $magick -Arguments $BackgroundArgumentsNoText
    }
    Write-Entry -Subtext "TitleCard Part:" -Path $global:ScriptRoot\Logs\Testinglog.log -Color Green -log Info
    # Border/Overlay TitleCard Part
    if ($AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        if ($Addtitlecardborder -eq 'true' -and $Addtitlecardoverlay -eq 'true') {
            $titlecardArgumentsShort = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterShort`""
            $titlecardArgumentsMedium = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterMedium`""
            $titlecardArgumentsLong = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterLong`""
            $titlecardArgumentsShortCAPS = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterShortCAPS`""
            $titlecardArgumentsMediumCAPS = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterMediumCAPS`""
            $titlecardArgumentsLongCAPS = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Background Borders | Adding Background Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($Addtitlecardborder -eq 'true' -and $Addtitlecardoverlay -eq 'false') {
            $titlecardArgumentsShort = "`"$backgroundtestimage`" -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterShort`""
            $titlecardArgumentsMedium = "`"$backgroundtestimage`" -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterMedium`""
            $titlecardArgumentsLong = "`"$backgroundtestimage`" -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterLong`""
            $titlecardArgumentsShortCAPS = "`"$backgroundtestimage`" -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterShortCAPS`""
            $titlecardArgumentsMediumCAPS = "`"$backgroundtestimage`" -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterMediumCAPS`""
            $titlecardArgumentsLongCAPS = "`"$backgroundtestimage`" -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$titlecardtestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Background Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($Addtitlecardborder -eq 'false' -and $Addtitlecardoverlay -eq 'true') {
            $titlecardArgumentsShort = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$titlecardtestPosterShort`""
            $titlecardArgumentsMedium = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$titlecardtestPosterMedium`""
            $titlecardArgumentsLong = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$titlecardtestPosterLong`""
            $titlecardArgumentsShortCAPS = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$titlecardtestPosterShortCAPS`""
            $titlecardArgumentsMediumCAPS = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$titlecardtestPosterMediumCAPS`""
            $titlecardArgumentsLongCAPS = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$titlecardtestPosterLongCAPS`""
            Write-Entry -Subtext "Adding Background Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($Addtitlecardborder -eq 'false' -and $Addtitlecardoverlay -eq 'false') {
            $titlecardArgumentsShort = "`"$backgroundtestimage`" -quality $global:outputQuality `"$titlecardtestPosterShort`""
            $titlecardArgumentsMedium = "`"$backgroundtestimage`" -quality $global:outputQuality `"$titlecardtestPosterMedium`""
            $titlecardArgumentsLong = "`"$backgroundtestimage`" -quality $global:outputQuality `"$titlecardtestPosterLong`""
            $titlecardArgumentsShortCAPS = "`"$backgroundtestimage`" -quality $global:outputQuality `"$titlecardtestPosterShortCAPS`""
            $titlecardArgumentsMediumCAPS = "`"$backgroundtestimage`" -quality $global:outputQuality `"$titlecardtestPosterMediumCAPS`""
            $titlecardArgumentsLongCAPS = "`"$backgroundtestimage`" -quality $global:outputQuality `"$titlecardtestPosterLongCAPS`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        # TitleCard Logging
        $titlecardlogEntryShort = "`"$magick`" $titlecardArgumentsShort"
        $titlecardlogEntryMedium = "`"$magick`" $titlecardArgumentsMedium"
        $titlecardlogEntryLong = "`"$magick`" $titlecardArgumentsLong"
        $titlecardlogEntryShortCAPS = "`"$magick`" $titlecardArgumentsShortCAPS"
        $titlecardlogEntryMediumCAPS = "`"$magick`" $titlecardArgumentsMediumCAPS"
        $titlecardlogEntryLongCAPS = "`"$magick`" $titlecardArgumentsLongCAPS"

        $titlecardlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $titlecardlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $titlecardlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $titlecardlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $titlecardlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $titlecardlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Test TitleCards creation
        InvokeMagickCommand -Command $magick -Arguments $titlecardArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $titlecardArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $titlecardArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $titlecardArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $titlecardArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $titlecardArgumentsLongCAPS
    }
    Else {
        if ($Addtitlecardborder -eq 'true' -and $Addtitlecardoverlay -eq 'true') {
            $TitleCardArgumentsTextless = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$TitleCardTestPosterTextless`""
            Write-Entry -Subtext "Adding TitleCard Borders | Adding TitleCard Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($Addtitlecardborder -eq 'true' -and $Addtitlecardoverlay -eq 'false') {
            $TitleCardArgumentsTextless = "`"$backgroundtestimage`" -shave `"$titlecardborderwidthsecond`"  -bordercolor `"$titlecardbordercolor`" -border `"$titlecardborderwidth`" `"$TitleCardTestPosterTextless`""
            Write-Entry -Subtext "Adding TitleCard Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($Addtitlecardborder -eq 'false' -and $Addtitlecardoverlay -eq 'true') {
            $TitleCardArgumentsTextless = "`"$backgroundtestimage`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$TitleCardTestPosterTextless`""
            Write-Entry -Subtext "Adding TitleCard Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if ($Addtitlecardborder -eq 'false' -and $Addtitlecardoverlay -eq 'false') {
            $TitleCardArgumentsTextless = "`"$backgroundtestimage`" -quality $global:outputQuality `"$TitleCardTestPosterTextless`""
            Write-Entry -Subtext "Nothing specified, just output pic with desired quality" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        $titlecardlogEntryTextless = "`"$magick`" $TitleCardArgumentsTextless"
        $titlecardlogEntryTextless | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $TitleCardArgumentsTextless
    }

    # Text TitleCard Title overlay
    if ($AddTitleCardEPTitleText -eq 'true') {
        # Logging TitleCards
        Write-Entry -Subtext "Optimal font size for Short text is: '$titlecardoptimalFontSizeShort'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$ShortText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium text is: '$titlecardoptimalFontSizeMedium'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$MediumText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long text is: '$titlecardoptimalFontSizeLong'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$LongText`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Short CAPS text is: '$titlecardoptimalFontSizeShortCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$ShortTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Medium CAPS text is: '$titlecardoptimalFontSizeMediumCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$MediumTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Long CAPS text is: '$titlecardoptimalFontSizeLongCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$LongTextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        # Add Stroke
        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
            $TitleCardTitleArgumentsShort = "`"$titlecardtestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeShort`" -fill `"#0000FF`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShort`""
            $TitleCardTitleArgumentsMedium = "`"$titlecardtestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeMedium`" -fill `"#0000FF`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMedium`""
            $TitleCardTitleArgumentsLong = "`"$titlecardtestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeLong`" -fill `"#0000FF`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$LongText`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLong`""
            $TitleCardTitleArgumentsShortCAPS = "`"$titlecardtestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShortCAPS`""
            $TitleCardTitleArgumentsMediumCAPS = "`"$titlecardtestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMediumCAPS`""
            $TitleCardTitleArgumentsLongCAPS = "`"$titlecardtestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLongCAPS`""
        }
        Else {
            $TitleCardTitleArgumentsShort = "`"$titlecardtestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeShort`" -fill `"#0000FF`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$ShortText`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShort`""
            $TitleCardTitleArgumentsMedium = "`"$titlecardtestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeMedium`" -fill `"#0000FF`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$MediumText`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMedium`""
            $TitleCardTitleArgumentsLong = "`"$titlecardtestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeLong`" -fill `"#0000FF`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$LongText`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLong`""
            $TitleCardTitleArgumentsShortCAPS = "`"$titlecardtestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeShortCAPS`" -fill `"#0000FF`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$ShortTextCAPS`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShortCAPS`""
            $TitleCardTitleArgumentsMediumCAPS = "`"$titlecardtestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeMediumCAPS`" -fill `"#0000FF`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$MediumTextCAPS`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMediumCAPS`""
            $TitleCardTitleArgumentsLongCAPS = "`"$titlecardtestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeLongCAPS`" -fill `"#0000FF`" -size `"$TitleCardEPTitleboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$LongTextCAPS`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLongCAPS`""
        }
        # Title Text Titlecard Logging
        $TitleCardTitlelogEntryShort = "`"$magick`" $TitleCardTitleArgumentsShort"
        $TitleCardTitlelogEntryMedium = "`"$magick`" $TitleCardTitleArgumentsMedium"
        $TitleCardTitlelogEntryLong = "`"$magick`" $TitleCardTitleArgumentsLong"
        $TitleCardTitlelogEntryshortCAPS = "`"$magick`" $TitleCardTitleArgumentsShortCAPS"
        $TitleCardTitlelogEntryMediumCAPS = "`"$magick`" $TitleCardTitleArgumentsMediumCAPS"
        $TitleCardTitlelogEntryLongCAPS = "`"$magick`" $TitleCardTitleArgumentsLongCAPS"
        $TitleCardTitlelogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Title Text TitleCard overlaying
        InvokeMagickCommand -Command $magick -Arguments $TitleCardTitleArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $TitleCardTitleArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $TitleCardTitleArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $TitleCardTitleArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardTitleArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardTitleArgumentsLongCAPS
    }
    Elseif ($AddTitleCardEPTitleText -eq 'false' -and $AddTitleCardEPText -eq 'true') {
        Write-Entry -Subtext "    Applying Title textbox only to TitleCard..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        $TitleCardEPTitleArgumentsNoTextShort = "`"$titlecardtestPosterShort`" -size `"$TitleCardEPTitleboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$titlecardtestPosterShort`""
        $TitleCardEPTitleArgumentsNoTextMedium = "`"$titlecardtestPosterMedium`" -size `"$TitleCardEPTitleboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$titlecardtestPosterMedium`""
        $TitleCardEPTitleArgumentsNoTextLong = "`"$titlecardtestPosterLong`" -size `"$TitleCardEPTitleboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$titlecardtestPosterLong`""
        $TitleCardEPTitleArgumentsNoTextShortCAPS = "`"$titlecardtestPosterShortCAPS`" -size `"$TitleCardEPTitleboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$titlecardtestPosterShortCAPS`""
        $TitleCardEPTitleArgumentsNoTextMediumCAPS = "`"$titlecardtestPosterMediumCAPS`" -size `"$TitleCardEPTitleboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$titlecardtestPosterMediumCAPS`""
        $TitleCardEPTitleArgumentsNoTextLongCAPS = "`"$titlecardtestPosterLongCAPS`" -size `"$TitleCardEPTitleboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$titlecardtestPosterLongCAPS`""

        # Title Text Titlecard Logging
        $TitleCardTitlelogEntryShort = "`"$magick`" $TitleCardEPTitleArgumentsNoTextShort"
        $TitleCardTitlelogEntryMedium = "`"$magick`" $TitleCardEPTitleArgumentsNoTextMedium"
        $TitleCardTitlelogEntryLong = "`"$magick`" $TitleCardEPTitleArgumentsNoTextLong"
        $TitleCardTitlelogEntryshortCAPS = "`"$magick`" $TitleCardEPTitleArgumentsNoTextShortCAPS"
        $TitleCardTitlelogEntryMediumCAPS = "`"$magick`" $TitleCardEPTitleArgumentsNoTextMediumCAPS"
        $TitleCardTitlelogEntryLongCAPS = "`"$magick`" $TitleCardEPTitleArgumentsNoTextLongCAPS"
        $TitleCardTitlelogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardTitlelogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPTitleArgumentsNoTextShort
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPTitleArgumentsNoTextMedium
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPTitleArgumentsNoTextLong
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPTitleArgumentsNoTextShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPTitleArgumentsNoTextMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPTitleArgumentsNoTextLongCAPS
    }
    Else {
        Write-Entry -Subtext "    Applying Title textbox only to TitleCard..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        $TitleCardTitleArgumentsNoText = "`"$TitleCardTestPosterTextless`" -size `"$TitleCardEPTitleboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$TitleCardTestPosterTextless`""

        # Episode Text Titlecard Logging
        $TitleCardEPTitlelogEntryNoText = "`"$magick`" $TitleCardTitleArgumentsNoText"
        $TitleCardEPTitlelogEntryNoText | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $TitleCardTitleArgumentsNoText
    }
    # Text TitleCard EP overlay
    if ($AddTitleCardEPText -eq 'true') {
        Write-Entry -Subtext "Optimal font size for Episode CAPS text is: '$TitleCardoptimalFontSizeEpisodetextCAPS'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying CAPS text: `"$EpisodetextCAPS`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "Optimal font size for Episode text is: '$TitleCardoptimalFontSizeEpisodetext'" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        Write-Entry -Subtext "    Applying text: `"$Episodetext`"" -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info

        # Add Stroke
        if ($AddTitleCardTextStroke -eq 'true') {
            $TitleCardEPArgumentsShort = "`"$titlecardtestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetext`" -fill `"#0000FF`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$Episodetext`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShort`""
            $TitleCardEPArgumentsMedium = "`"$titlecardtestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetext`" -fill `"#0000FF`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$Episodetext`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMedium`""
            $TitleCardEPArgumentsLong = "`"$titlecardtestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetext`" -fill `"#0000FF`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$Episodetext`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLong`""
            $TitleCardEPArgumentsShortCAPS = "`"$titlecardtestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetextCAPS`" -fill `"#0000FF`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EpisodetextCAPS`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShortCAPS`""
            $TitleCardEPArgumentsMediumCAPS = "`"$titlecardtestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetextCAPS`" -fill `"#0000FF`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EpisodetextCAPS`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMediumCAPS`""
            $TitleCardEPArgumentsLongCAPS = "`"$titlecardtestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetextCAPS`" -fill `"#0000FF`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EpisodetextCAPS`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLongCAPS`""
        }
        Else {
            $TitleCardEPArgumentsShort = "`"$titlecardtestPosterShort`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetext`" -fill `"#0000FF`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$Episodetext`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShort`""
            $TitleCardEPArgumentsMedium = "`"$titlecardtestPosterMedium`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetext`" -fill `"#0000FF`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$Episodetext`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMedium`""
            $TitleCardEPArgumentsLong = "`"$titlecardtestPosterLong`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetext`" -fill `"#0000FF`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$Episodetext`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLong`""
            $TitleCardEPArgumentsShortCAPS = "`"$titlecardtestPosterShortCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetextCAPS`" -fill `"#0000FF`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EpisodetextCAPS`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterShortCAPS`""
            $TitleCardEPArgumentsMediumCAPS = "`"$titlecardtestPosterMediumCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetextCAPS`" -fill `"#0000FF`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EpisodetextCAPS`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterMediumCAPS`""
            $TitleCardEPArgumentsLongCAPS = "`"$titlecardtestPosterLongCAPS`" -gravity center -background none -layers Flatten ( -font `"$titlecardfontImagemagick`" -pointsize `"$TitleCardoptimalFontSizeEpisodetextCAPS`" -fill `"#0000FF`" -size `"$TitleCardEPboxsize`" -background `"#ACD7E6`" -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EpisodetextCAPS`" -trim +repage -extent `"$TitleCardEPboxsize`" ) -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$titlecardtestPosterLongCAPS`""
        }
        # Episode Text Titlecard Logging
        $TitleCardEPlogEntryShort = "`"$magick`" $TitleCardEPArgumentsShort"
        $TitleCardEPlogEntryMedium = "`"$magick`" $TitleCardEPArgumentsMedium"
        $TitleCardEPlogEntryLong = "`"$magick`" $TitleCardEPArgumentsLong"
        $TitleCardEPlogEntryshortCAPS = "`"$magick`" $TitleCardEPArgumentsShortCAPS"
        $TitleCardEPlogEntryMediumCAPS = "`"$magick`" $TitleCardEPArgumentsMediumCAPS"
        $TitleCardEPlogEntryLongCAPS = "`"$magick`" $TitleCardEPArgumentsLongCAPS"
        $TitleCardEPlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Episode Text TitleCard overlaying
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsShort
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsMedium
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsLong
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsLongCAPS
    }
    Elseif ($AddTitleCardEPText -eq 'false' -and $AddTitleCardEPTitleText -eq 'true') {
        Write-Entry -Subtext "    Applying EP textbox only to TitleCard..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        $TitleCardEPArgumentsNoTextShort = "`"$titlecardtestPosterShort`" -size `"$TitleCardEPboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$titlecardtestPosterShort`""
        $TitleCardEPArgumentsNoTextMedium = "`"$titlecardtestPosterMedium`" -size `"$TitleCardEPboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$titlecardtestPosterMedium`""
        $TitleCardEPArgumentsNoTextLong = "`"$titlecardtestPosterLong`" -size `"$TitleCardEPboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$titlecardtestPosterLong`""
        $TitleCardEPArgumentsNoTextShortCAPS = "`"$titlecardtestPosterShortCAPS`" -size `"$TitleCardEPboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$titlecardtestPosterShortCAPS`""
        $TitleCardEPArgumentsNoTextMediumCAPS = "`"$titlecardtestPosterMediumCAPS`" -size `"$TitleCardEPboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$titlecardtestPosterMediumCAPS`""
        $TitleCardEPArgumentsNoTextLongCAPS = "`"$titlecardtestPosterLongCAPS`" -size `"$TitleCardEPboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$titlecardtestPosterLongCAPS`""

        # Episode Text Titlecard Logging
        $TitleCardEPlogEntryShort = "`"$magick`" $TitleCardEPArgumentsNoTextShort"
        $TitleCardEPlogEntryMedium = "`"$magick`" $TitleCardEPArgumentsNoTextMedium"
        $TitleCardEPlogEntryLong = "`"$magick`" $TitleCardEPArgumentsNoTextLong"
        $TitleCardEPlogEntryshortCAPS = "`"$magick`" $TitleCardEPArgumentsNoTextShortCAPS"
        $TitleCardEPlogEntryMediumCAPS = "`"$magick`" $TitleCardEPArgumentsNoTextMediumCAPS"
        $TitleCardEPlogEntryLongCAPS = "`"$magick`" $TitleCardEPArgumentsNoTextLongCAPS"
        $TitleCardEPlogEntryShort | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryShortCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryMedium | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryMediumCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryLong | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        $TitleCardEPlogEntryLongCAPS | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsNoTextShort
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsNoTextMedium
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsNoTextLong
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsNoTextShortCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsNoTextMediumCAPS
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsNoTextLongCAPS
    }
    Else {
        Write-Entry -Subtext "    Applying EP textbox only to TitleCard..." -Path $global:ScriptRoot\Logs\Testinglog.log -Color White -log Info
        $TitleCardEPArgumentsNoText = "`"$TitleCardTestPosterTextless`" -size `"$TitleCardEPboxsize`" xc:`"#ACD7E6`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$TitleCardTestPosterTextless`""

        # Episode Text Titlecard Logging
        $TitleCardEPlogEntryNoText = "`"$magick`" $TitleCardEPArgumentsNoText"
        $TitleCardEPlogEntryNoText | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $TitleCardEPArgumentsNoText
    }


    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Subtext "Final cleanup starting..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    Write-Entry -Subtext "Deleting testimage: $testimage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Remove-Item -LiteralPath $testimage | out-null
    Write-Entry -Subtext "Deleting backgroundtestimage: $backgroundtestimage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Remove-Item -LiteralPath $backgroundtestimage | out-null
    Write-Entry -Subtext "Poster/Background/TitleCard Tests finished, you can find them here: $(Join-Path $global:ScriptRoot 'test')" -Path (Join-Path $global:ScriptRoot 'Logs\Testinglog.log') -Color Green -log Info
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Testinglog.log -Color Green -log Info
    $gettestimages = Get-ChildItem $global:ScriptRoot\test
    $titlecardscount = ($gettestimages | Where-Object { $_.name -like 'Title*' }).count
    $backgroundsscount = ($gettestimages | Where-Object { $_.name -like 'back*' }).count
    $posterscount = ($gettestimages | Where-Object { $_.name -like 'poster*' -or $_.name -like 'SeasonPoster*' }).count
    if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -notlike 'PSDocker*') {
        $jsonPayload = @"
        {
            "username": "$global:DiscordUserName",
            "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
            "content": "",
            "embeds": [
            {
                "author": {
                "name": "Posterizarr @Github",
                "url": "https://github.com/fscorrupt/Posterizarr"
                },
                "description": "Test run took: $FormattedTimespawn",
                "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                "fields": [
                {
                    "name": "",
                    "value": ":bar_chart:",
                    "inline": false
                },
                {
                    "name": "Truncated",
                    "value": "$TruncatedCount",
                    "inline": false
                },
                {
                    "name": "",
                    "value": ":frame_photo:",
                    "inline": false
                },
                {
                    "name": "Posters",
                    "value": "$posterscount",
                    "inline": true
                },
                {
                    "name": "Backgrounds",
                    "value": "$backgroundsscount",
                    "inline": true
                },
                {
                    "name": "TitleCards",
                    "value": "$titlecardscount",
                    "inline": true
                }
                ],
                "thumbnail": {
                    "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                },
                "footer": {
                    "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                }

            }
            ]
        }
"@
        if ($global:SendNotification -eq 'true') {
            Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
        }
    }
    if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
        if ($global:NotifyUrl -like '*discord*') {
            $jsonPayload = @"
            {
                "username": "$global:DiscordUserName",
                "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                "content": "",
                "embeds": [
                {
                    "author": {
                    "name": "Posterizarr @Github",
                    "url": "https://github.com/fscorrupt/Posterizarr"
                    },
                    "description": "Test run took: $FormattedTimespawn",
                    "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                    "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                    "fields": [
                    {
                        "name": "",
                        "value": ":bar_chart:",
                        "inline": false
                    },
                    {
                        "name": "Truncated",
                        "value": "$TruncatedCount",
                        "inline": false
                    },
                    {
                        "name": "",
                        "value": ":frame_photo:",
                        "inline": false
                    },
                    {
                        "name": "Posters",
                        "value": "$posterscount",
                        "inline": true
                    },
                    {
                        "name": "Backgrounds",
                        "value": "$backgroundsscount",
                        "inline": true
                    },
                    {
                        "name": "TitleCards",
                        "value": "$titlecardscount",
                        "inline": true
                    }
                    ],
                    "thumbnail": {
                        "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                    },
                    "footer": {
                        "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                    }

                }
                ]
            }
"@
            $global:NotifyUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
            if ($global:SendNotification -eq 'true') {
                Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
            }
        }
        Else {
            if ($global:SendNotification -eq 'true') {
                if ($TruncatedCount -ge '1') {
                    apprise --notification-type="failure" --title="Posterizarr" --body="Test run took: $FormattedTimespawn`nDuring execution '$TruncatedCount' times the text got truncated, please check log for detailed description." "$global:NotifyUrl"
                }
                Else {
                    apprise --notification-type="success" --title="Posterizarr" --body="Test run took: $FormattedTimespawn" "$global:NotifyUrl"
                }
            }
        }
    }

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
Elseif ($Tautulli) {
    # Get Plex data for this Show/Movie
    # {rating_key}	The unique identifier for the movie, episode, or track.
    # {parent_rating_key}	The unique identifier for the season or album.
    # {grandparent_rating_key}	The unique identifier for the TV show or artist.

    $Libraries = @()
    if (($RatingKey -or $parentratingkey -or $grandparentratingkey) -and $mediatype) {
        if ($mediatype -eq 'movie') {
            $contentquery = "video"
            $queryKey = $RatingKey
        }
        Elseif ($mediatype -eq 'show') {
            $contentquery = "Directory"
            $queryKey = $RatingKey
        }
        Elseif ($mediatype -eq 'season') {
            $contentquery = "Directory"
            $queryKey = $parentratingkey
        }
        Else {
            $contentquery = "Directory"
            $queryKey = if ($grandparentratingkey) { $grandparentratingkey }Else { $parentratingkey }
        }
        $extractedFolder = $null
        $Seasondata = $null
        if ($PlexToken) {
            if ($contentquery -eq 'Directory') {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
            }
            Else {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
            }
        }
        Else {
            if ($contentquery -eq 'Directory') {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey) -Headers $extraPlexHeaders).content
                [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)/children? -Headers $extraPlexHeaders).content
            }
            Else {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey) -Headers $extraPlexHeaders).content
            }
        }

        $Library = $Libs.mediaContainer.Directory | Where-Object { $_.key -eq $Metadata.MediaContainer.$contentquery.librarySectionID }
        $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
        $tmdbpattern = 'tmdb://(\d+)'
        $imdbpattern = 'imdb://tt(\d+)'
        $tvdbpattern = 'tvdb://(\d+)'
        if ($Metadata.MediaContainer.$contentquery.Location) {
            $location = $Metadata.MediaContainer.$contentquery.Location.path
            if ($location.count -gt '1') {
                $location = $location[0]
                $MultipleVersions = $true
            }
            Else {
                $MultipleVersions = $false
            }
            $libpaths = $($Library.location.path).split(',')
            Write-Entry -Subtext "Plex Lib Paths before split: $($Library.location.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            foreach ($libpath in $libpaths) {
                if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                    Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $Matchedpath = AddTrailingSlash $libpath
                    $libpath = $Matchedpath
                    $relativePath = $location.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }
                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    continue
                }
            }
        }
        Else {
            $location = $Metadata.MediaContainer.$contentquery.media.part.file

            if ($location.count -gt '1') {
                Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $location = $location[0]
                $MultipleVersions = $true
            }
            Else {
                $MultipleVersions = $false
            }
            Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

            if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                $CheckCharLimit = CheckCharLimit
                if ($CheckCharLimit -eq $false) {
                    Write-Entry -Subtext "Skipping [$($Metadata.MediaContainer.$contentquery.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    continue
                }
            }

            $libpaths = $($Library.location.path).split(',')
            Write-Entry -Subtext "Plex Lib Paths before split: $($Library.location.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            foreach ($libpath in $libpaths) {
                if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                    Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $Matchedpath = AddTrailingSlash $libpath
                    $libpath = $Matchedpath
                    $relativePath = $location.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }
                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    continue
                }
            }
        }
        if ($Seasondata) {
            $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
            $SeasonNames = $SeasonsTemp.Title -join ','
            $SeasonNumbers = $SeasonsTemp.index -join ','
            $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
            $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
        }
        $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
        $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
        $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
        if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
        if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
        if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

        # check if there are more then 1 entry in ids
        if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
        if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
        if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

        if ($Metadata.MediaContainer.$contentquery.Label.tag) {
            $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
        }
        Else {
            $Labels = ""
        }
        $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
        $Resolution = $null
        # Get Resolution
        if ($FileMetadata){
            $FileMetadata | ForEach-Object {
                if ($_.streamType -eq '1') {
                    $Resolution = $_.displayTitle
                }
            }
        }
        $temp = New-Object psobject
        $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.title
        $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
        $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
        $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Metadata.MediaContainer.$contentquery.title
        if ($FileMetadata) {
            $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
        }
        $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Metadata.MediaContainer.$contentquery.originalTitle
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
        $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Metadata.MediaContainer.$contentquery.year
        $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
        $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
        $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
        $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $Metadata.MediaContainer.$contentquery.ratingKey
        $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
        $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
        $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
        $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
        $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
        $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
        $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
        $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
        $Libraries += $temp
        Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }

    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    if ($global:TitleCards -eq 'true' -and $mediatype -ne 'movie') {
        Write-Entry -Message "Query episodes data..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata){
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        $Episodedata | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Test if csvs are missing and create dummy file.
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -ErrorAction SilentlyContinue)) {
        $EpisodeDummycsv = New-Object psobject

        # Add members to the object with empty values
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $null

        $EpisodeDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexEpisodeExport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexLibexport.csv" -ErrorAction SilentlyContinue)) {
        # Add members to the object with empty values
        $PlexLibDummycsv = New-Object psobject
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "title" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "year" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Path" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $null

        $PlexLibDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexLibexport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
        $totalSize = 0

        if ($FollowSymlink){
            Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $AssetPath -Recurse | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }

        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }
    # Download poster foreach movie
    Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    $SkipingText = 'false'
                    $global:posterurl = $null
                    $global:ImageMagickError = $null
                    $global:TextlessPoster = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $global:IsFallback = $null
                    $global:PlexartworkDownloaded = $null
                    $global:langCode = $null
                    $global:direction = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern -and $entry.originalTitle) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }
                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }
                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {
                        if ($PlexToken) {
                            $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $entry.PlexPosterUrl
                        }
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkipingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:ImageMagickError = $null
                            $TakeLocal = $null

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                    Default { $global:posterurl = GetFanartMoviePoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                }
                                if ($global:PreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if ($global:OnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Elseif ($global:FavProvider -eq 'FANART') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMoviePoster
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB' -and !$global:OnlyTextless -and !$global:PreferTextless) {
                                        $global:posterurl = GetTVDBMoviePoster
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl -and !$global:OnlyTextless) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                            $global:IsFallback = $true
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl -and $global:imdbid -and !$global:OnlyTextless) {
                                        Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:posterurl = GetIMDBPoster
                                        $global:IsFallback = $true
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        $statusCode = $_.Exception.Response.StatusCode
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $errorCount++
                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UsePosterResolutionOverlays -eq 'true'){
                                            switch ($entry.Resolution) {
                                                '4K' { $Posteroverlay = $4kposter }
                                                '1080p' { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                            $SkipingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkipingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }

                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                # Move file back to original naming with Brackets.
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                if ($PlexToken) {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                                Else {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $movietemp = New-Object psobject
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }

                                            # Export the array to a CSV file
                                            $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $movietemp.Type -title $movietemp.Title.replace('"', '\"').replace("`r", "").replace("`n", "") -Lib $movietemp.LibraryName -DLSource $movietemp.'Download Source' -lang $movietemp.Language -favurl $movietemp.'Fav Provider Link' -fallback $movietemp.Fallback -Truncated $movietemp.TextTruncated
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $movietemp = New-Object psobject
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                    # Now we can start the Background Poster Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        if ($PlexToken) {
                            $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $entry.PlexBackgroundUrl
                        }
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkipingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:ImageMagickError = $null
                            $TakeLocal = $null

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                    Default { $global:posterurl = GetFanartMovieBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMovieBackground
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBMovieBackground
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                            $global:IsFallback = $true
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($BackgroundfontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $BackgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $BackgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        $statusCode = $_.Exception.Response.StatusCode
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $errorCount++
                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                            $SkipingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkipingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }

                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                if ($PlexToken) {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                                Else {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                            $BackgroundCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $moviebackgroundtemp = New-Object psobject
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }
                                            # Export the array to a CSV file
                                            $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $moviebackgroundtemp.Type -title $moviebackgroundtemp.Title.replace('"', '\"').replace("`r", "").replace("`n", "") -Lib $moviebackgroundtemp.LibraryName -DLSource $moviebackgroundtemp.'Download Source' -lang $moviebackgroundtemp.Language -favurl $moviebackgroundtemp.'Fav Provider Link' -fallback $moviebackgroundtemp.Fallback -Truncated $moviebackgroundtemp.TextTruncated
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $moviebackgroundtemp = New-Object psobject
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $movietemoviebackgroundtempmp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            if ($global:OnlyTextless) {
                $moviebackgroundtemp = New-Object psobject
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                switch -Wildcard ($global:FavProvider) {
                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                    Default { $movietemoviebackgroundtempmp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                }

                # Export the array to a CSV file
                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
            }
            $errorCount++
        }
    }

    $SkipTBACount = 0
    $SkipJapTitleCount = 0
    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Define Global Variables
                $SkipingText = 'false'
                $global:tmdbsearched = $null
                $global:tmdbid = $entry.tmdbid
                $global:tvdbid = $entry.tvdbid
                $global:imdbid = $entry.imdbid
                $Seasonpostersearchtext = $null
                $global:ImageMagickError = $null
                $Episodepostersearchtext = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $FanartSearched = $null
                $global:plexalreadysearched = $null
                $global:posterurl = $null
                $global:PosterWithText = $null
                $global:AssetTextLang = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:Fallback = $null
                $global:TextlessPoster = $null
                $global:tvdbalreadysearched = $null
                $global:PlexartworkDownloaded = $null
                $TakeLocal = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    if ($entry.extraFolder) {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                    }
                    Else {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                    }
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $ManualTestPath = $ManualEntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    if ($entry.extraFolder) {
                        $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                    }
                    Else {
                        $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                    }
                    $TestPath = $AssetPath
                    $ManualTestPath = $ManualPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                if ($PlexToken) {
                    $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                }
                Else {
                    $Arturl = $plexurl + $entry.PlexPosterUrl
                }
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                            Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Else {
                            Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                Default { $global:posterurl = GetFanartShowPoster }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                            }
                            if ($global:PreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                # try to find textless on TVDB
                                if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid ) {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                    $global:tvdbalreadysearched = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                    $global:posterurl = GetFanartMoviePoster
                                    $global:IsFallback = $true
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                $global:PosterWithText = $true
                            }

                            if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                $global:posterurl = GetTVDBShowPoster
                                $global:IsFallback = $true
                                if (!$global:posterurl -and !$global:TMDBfallbackposterurl -and !$global:fanartfallbackposterurl) {
                                    if ($ArtUrl -and !$global:OnlyTextless) {
                                        GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                        $global:plexalreadysearched = $True
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                            }
                            if (!$global:posterurl -and !$global:plexalreadysearched -eq 'true') {
                                $global:IsFallback = $true
                                if ($ArtUrl -and !$global:OnlyTextless) {
                                    GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                    $global:plexalreadysearched = $True
                                }
                                Else {
                                    Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                if (!$global:posterurl) {
                                    Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:TMDBfallbackposterurl) {
                                $global:posterurl = $global:TMDBfallbackposterurl
                            }
                            if (!$global:TextlessPoster -eq 'true' -and $global:fanartfallbackposterurl) {
                                $global:posterurl = $global:fanartfallbackposterurl
                            }
                        }
                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    $statusCode = $_.Exception.Response.StatusCode
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    if ($UsePosterResolutionOverlays -eq 'true'){
                                        switch ($entry.Resolution) {
                                            '4K' { $Posteroverlay = $4kposter }
                                            '1080p' { $Posteroverlay = $1080pPoster }
                                            Default { $Posteroverlay = $Posteroverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                        $SkipingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddText -eq 'true' -and $SkipingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $fontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $SeasonlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddTextStroke -eq 'true') {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }

                                            Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                    # Move file back to original naming with Brackets.
                                    if (!$global:IsTruncated) {
                                        try {
                                            Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                            if ($PlexToken) {
                                                $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                            }
                                            Else {
                                                $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                            }
                                        }
                                        catch {
                                            Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$TakeLocal) {
                                        $showtemp = New-Object psobject
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                            'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                            'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                            Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                        }
                                        # Export the array to a CSV file
                                        $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $showtemp.Type -title $showtemp.Title.replace('"', '\"').replace("`r", "").replace("`n", "") -Lib $showtemp.LibraryName -DLSource $showtemp.'Download Source' -lang $showtemp.Language -favurl $showtemp.'Fav Provider Link' -fallback $showtemp.Fallback -Truncated $showtemp.TextTruncated
                                    }
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            if ($global:OnlyTextless) {
                                $showtemp = New-Object psobject
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                    'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                    'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                    Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                }

                                # Export the array to a CSV file
                                $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                            }
                            $errorCount++
                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
                # Now we can start the Background Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                        }
                        Else {
                            $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl
                    }
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkipingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:TextlessPoster = $null
                        $global:ImageMagickError = $null
                        $TakeLocal = $null

                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                            Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Else {
                            Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                Default { $global:posterurl = GetFanartShowBackground }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                            }
                            if ($global:BackgroundPreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                            }
                            if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                if ($global:FavProvider -eq 'TVDB') {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                                Else {
                                    $global:posterurl = GetFanartShowBackground
                                }
                            }
                            if (!$global:posterurl) {
                                if ($global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowBackground
                                    $global:IsFallback = $true
                                }
                                $global:FallbackText = 'True-Background'
                                if (!$global:posterurl) {
                                    if ($ArtUrl) {
                                        GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }

                            }

                            if ($BackgroundfontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    $statusCode = $_.Exception.Response.StatusCode
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                        $SkipingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddBackgroundText -eq 'true' -and $SkipingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $backgroundfontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddBackgroundTextStroke -eq 'true') {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }

                                            Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                # Move file back to original naming with Brackets.
                                if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                    if (!$global:IsTruncated) {
                                        try {
                                            Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                            if ($PlexToken) {
                                                $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                            }
                                            Else {
                                                $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                            }
                                        }
                                        catch {
                                            Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        $BackgroundCount++
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$TakeLocal) {
                                        $showbackgroundtemp = New-Object psobject
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                            'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                            'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                            Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                        }
                                        # Export the array to a CSV file
                                        $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $showbackgroundtemp.Type -title $showbackgroundtemp.Title.replace('"', '\"').replace("`r", "").replace("`n", "") -Lib $showbackgroundtemp.LibraryName -DLSource $showbackgroundtemp.'Download Source' -lang $showbackgroundtemp.Language -favurl $showbackgroundtemp.'Fav Provider Link' -fallback $showbackgroundtemp.Fallback -Truncated $showbackgroundtemp.TextTruncated
                                    }
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            if ($global:OnlyTextless) {
                                $showbackgroundtemp = New-Object psobject
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                    'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                    'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                    Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                }

                                # Export the array to a CSV file
                                $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                            }
                            $errorCount++
                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
                # Now we can start the Season Part
                if ($global:SeasonPosters -eq 'true') {
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:TextlessPoster = $null
                    $global:seasonNames = $entry.SeasonNames -split ','
                    $global:SeasonRatingKeys = $entry.SeasonRatingKeys -split ','
                    $global:seasonNumbers = $entry.seasonNumbers -split ','
                    $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                    for ($i = 0; $i -lt $global:seasonNames.Count; $i++) {
                        $SkipingText = 'false'
                        $global:tmdbsearched = $null
                        $global:posterurl = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TMDBSeasonFallback = $null
                        $global:TVDBSeasonFallback = $null
                        $global:FANARTSeasonFallback = $null
                        $TakeLocal = $null

                        if ($SeasonfontAllCaps -eq 'true') {
                            $global:seasonTitle = $global:seasonNames[$i].ToUpper()
                        }
                        Else {
                            $global:seasonTitle = $global:seasonNames[$i]
                        }
                        $global:SeasonNumber = $global:seasonNumbers[$i]
                        $global:SeasonRatingKey = $global:SeasonRatingKeys[$i]
                        $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                        if ($global:SeasonNumber) {
                            $global:season = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                        }
                        if ($LibraryFolders -eq 'true') {
                            $SeasonImageoriginal = "$EntryDir\$global:season.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "$global:season"
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:season.jpg"
                            }
                            Else {
                                $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:season.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_$global:season"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                        $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:season.jpg"
                        $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        if ($PlexToken) {
                            $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $global:PlexSeasonUrl
                        }
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                if (!$Seasonpostersearchtext) {
                                    Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $Seasonpostersearchtext = $true
                                }
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage } }
                                    Default { $global:posterurl = GetFanartSeasonPoster }
                                }
                                # do a specific order
                                if ($global:SeasonPreferTextless -eq $true) {
                                    if (!$global:posterurl -or !$global:TextlessPoster) {
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            $global:IsFallback = $true
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl -or !$global:TextlessPoster) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                                $global:posterurl = GetTVDBSeasonPoster
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                    if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                        # Lets just try to grab a show poster.
                                        Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'FANART' { $global:posterurl = GetFanartShowPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                            Default { $global:posterurl = GetFanartShowPoster }
                                        }
                                        if ($global:posterurl) {
                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Show'
                                        }
                                        Else {
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:posterurl = GetTMDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                $global:posterurl = GetTVDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                $global:posterurl = GetFanartShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            $global:IsFallback = $true
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if (!$global:posterurl -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                                $global:posterurl = GetTVDBSeasonPoster
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ($ArtUrl) {
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                                GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage
                                                Write-Entry -Subtext "Function GetPlexArtwork called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Season Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                                if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                    # Lets just try to grab a show poster.
                                    Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'FANART' { $global:posterurl = GetFanartShowPoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                        Default { $global:posterurl = GetFanartShowPoster }
                                    }
                                    if ($global:posterurl) {
                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Show'
                                    }
                                    Else {
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:posterurl = GetTMDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                            $global:posterurl = GetTVDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                            $global:posterurl = GetFanartShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                    }
                                }
                                if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                    $global:posterurl = $global:TMDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                    $global:posterurl = $global:FANARTSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                    $global:posterurl = $global:TVDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }

                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($global:ImageProcessing -eq 'true') {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            $statusCode = $_.Exception.Response.StatusCode
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'IMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'true') {
                                            # Resize Image to 2000x3000 and apply Border and overlay
                                            if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }

                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                $SkipingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddSeasonText -eq 'true' -and $SkipingText -eq 'false') {
                                                $global:seasonTitle = $global:seasonTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                    $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                Else {
                                                    $global:ShowTitleOnSeason = $titletext -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), "`n"
                                                        if ($AddShowTitletoSeason -eq 'true') {
                                                            $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), "`n"
                                                        }
                                                    }
                                                }
                                                $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                if ($AddShowTitletoSeason -eq 'true') {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext "Optimal Season font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        Write-Entry -Subtext "Optimal Show font size set to: '$ShowoptimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Season Part
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $SeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                        # Show Part
                                                        # Add Stroke
                                                        if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                    }
                                                }
                                                Else {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Arguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            $statusCode = $_.Exception.Response.StatusCode
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'IMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Resize Image to 2000x3000
                                        $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($SeasonImage)
                                                if ($PlexToken) {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                                Else {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $SeasonCount++
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $seasontemp = New-Object psobject
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | " + $global:season)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }
                                            # Export the array to a CSV file
                                            $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $seasontemp.Type -title $seasontemp.Title.replace('"', '\"').replace("`r", "").replace("`n", "") -Lib $seasontemp.LibraryName -DLSource $seasontemp.'Download Source' -lang $seasontemp.Language -favurl $seasontemp.'Fav Provider Link' -fallback $seasontemp.Fallback -Truncated $seasontemp.TextTruncated
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $seasontemp = New-Object psobject
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Episode Part
                if ($global:TitleCards -eq 'true') {
                    # Loop through each episode
                    foreach ($episode in $Episodedata) {
                        $SkipingText = 'false'
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:TempImagecopied = $false
                        $EpisodeTempImage = $null
                        $global:ImageMagickError = $null
                        $global:season_number = $null
                        $Episodepostersearchtext = $null
                        $global:show_name = $null
                        $global:episodenumber = $null
                        $global:episode_numbers = $null
                        $global:titles = $null
                        $global:posterurl = $null
                        $global:FileNaming = $null
                        $EpisodeImageoriginal = $null
                        $EpisodeImage = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TextlessPoster = $null

                        if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title -and $episode.'Library Name' -eq $entry.'Library Name') {
                            $global:show_name = $episode."Show Name"
                            $global:season_number = $episode."Season Number"
                            $global:episode_numbers = $episode."Episodes".Split(",")
                            $global:episode_ratingkeys = $episode."ratingKeys".Split(",")
                            $global:titles = $episode."Title".Split(";")
                            $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")
                            if ($UseBackgroundAsTitleCard -eq 'true') {
                                $global:ImageMagickError = $null
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkipingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $global:PlexTitleCardUrl = $entry.PlexBackgroundUrl
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                    $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        if ($PlexToken) {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                        }
                                        Else {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl
                                        }
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }

                                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if ($global:tmdbfallbackposterurl) {
                                                                $global:posterurl = $global:tmdbfallbackposterurl
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetFanartShowBackground
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetFanartShowBackground
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded -and $global:TempImagecopied -ne 'true') {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }

                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like "$PlexUrl*") {
                                                                Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                if ($global:FavProvider -ne 'PLEX') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        Else {
                                                            Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                        }
                                                    }
                                                    $global:TempImagecopied = $true
                                                    # Check temp image
                                                    if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                        Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $errorCount++
                                                    }
                                                    Else {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'true') {
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                    $SkipingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkipingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), "`n"
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                    $SkipingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkipingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }
                                                        Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            try {
                                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                if ($PlexToken) {
                                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                }
                                                                Else {
                                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                }
                                                            }
                                                            catch {
                                                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        if (!$TakeLocal) {
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                            SendMessage -type $episodetemp.Type -title $($global:show_name.replace('"', '\"').replace("`r", "").replace("`n", "") + " | " + $episodetemp.Title.replace('"', '\"').replace("`r", "").replace("`n", "")) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                        }
                                                    }
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:OnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                    }

                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }
                                                $errorCount++
                                            }

                                        }
                                        else {
                                            if ($show_skipped -eq 'true' ) {
                                                Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            }
                                        }
                                    }
                                }
                                if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                    Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkipingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:FallbackText = $null
                                    $global:ImageMagickError = $null
                                    $global:TextlessPoster = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        if ($PlexToken) {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                        }
                                        Else {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl
                                        }
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }
                                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if ($global:Fallback -eq "TVDB") {
                                                            $global:posterurl = GetTVDBTitleCard
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if ($global:Fallback -eq "TMDB") {
                                                            $global:posterurl = GetTMDBTitleCard
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }
                                                        Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                        if (!$global:ImageMagickError -eq 'true') {
                                                            # Resize Image to 2000x3000 and apply Border and overlay
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                $SkipingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPTitleText -eq 'true' -and $SkipingText -eq 'false') {
                                                                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                    $global:EPTitle = $global:EPTitle.ToUpper()
                                                                }
                                                                $global:EPTitle = $global:EPTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                                                if ($global:direction -eq "RTL") {
                                                                    $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                }
                                                                # Loop through each symbol and replace it with a newline
                                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                    foreach ($symbol in $NewLineSymbols) {
                                                                        $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), "`n"
                                                                    }
                                                                }
                                                                $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                $SkipingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPText -eq 'true' -and $SkipingText -eq 'false') {
                                                                if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                }
                                                                $global:SeasonEPNumber = $global:SeasonEPNumber -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }
                                                        Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            try {
                                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                if ($PlexToken) {
                                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                }
                                                                Else {
                                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                }
                                                            }
                                                            catch {
                                                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        if (!$TakeLocal) {
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                            SendMessage -type $episodetemp.Type -title $($global:show_name.replace('"', '\"').replace("`r", "").replace("`n", "") + " | " + $episodetemp.Title.replace('"', '\"').replace("`r", "").replace("`n", "")) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                        }
                                                    }
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:OnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                    }

                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }
                                                $errorCount++
                                            }

                                        }
                                        else {
                                            if ($show_skipped -eq 'true' ) {
                                                Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }
    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "

    Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
        Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
            Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextlessCount) {
            Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($FallbackCount) {
            Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextCount) {
            Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($PosterUnknownCount -ge '1') {
            Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextTruncatedCount) {
            Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
        $ImageChoicesDummycsv = New-Object psobject

        # Add members to the object with empty values
        $ImageChoicesDummycsv = New-Object psobject
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

        $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
        Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
Elseif ($Backup) {
    MassDownloadPlexArtwork
}
Elseif ($SyncJelly -or $SyncEmby) {
    # Initialize counter variable
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $UploadCount = 0

    [xml]$Libs = CheckPlexAccess -PlexUrl $PlexUrl -PlexToken $PlexToken
    $LibstoExclude = $config.PlexPart.LibstoExclude

    if ($SyncJelly) {
        # Check Jellyfin now:
        CheckJellyfinAccess -JellyfinUrl $JellyfinUrl -JellyfinApi $JellyfinAPIKey
        $OtherMediaServerUrl = $JellyfinUrl
        $OtherMediaServerApiKey = $JellyfinAPIKey
    }
    if ($SyncEmby) {
        # Check Emby now:
        CheckEmbyAccess -EmbyUrl $EmbyUrl -EmbyAPI $EmbyAPIKey
        $OtherMediaServerUrl = $EmbyUrl
        $OtherMediaServerApiKey = $EmbyAPIKey
    }

    Write-Entry -Message "Query plex libs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libsoverview = @()
    foreach ($lib in $Libs.MediaContainer.Directory) {
        if ($lib.title -notin $LibstoExclude) {
            $libtemp = New-Object psobject
            $libtemp | Add-Member -MemberType NoteProperty -Name "ID" -Value $lib.key
            $libtemp | Add-Member -MemberType NoteProperty -Name "Name" -Value $lib.title
            $libtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $lib.language

            # Check if $lib.location.path is an array
            if ($lib.location.path -is [array]) {
                $paths = $lib.location.path -join ',' # Convert array to string
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $paths
            }
            else {
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $lib.location.path
            }
            # Check if Libname has chars we cant use for Folders
            if ($lib.title -notmatch "^[^\/:*?`"<>\|\\}]+$") {
                Write-Entry -Message  "Lib: '$($lib.title)' contains invalid characters." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Please rename your lib and remove all chars that are listed here: '/, :, *, ?, `", <, >, |, \, or }'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Lib contains invalid chars"
                }
                Exit
            }
            $Libsoverview += $libtemp
        }
    }
    if ($($Libsoverview.count) -lt 1) {
        Write-Entry -Subtext "0 libraries were found. Are you on the correct Plex server?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "No libs found"
        }
        Exit
    }
    Write-Entry -Subtext "Found '$($Libsoverview.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = $Libsoverview.Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libraries = @()
    Foreach ($Library in $Libsoverview) {
        if ($Library.Name -notin $LibstoExclude) {
            $PlexHeaders = @{}
            if ($PlexToken) {
                $PlexHeaders['X-Plex-Token'] = $PlexToken
            }

            # Create a parent XML document
            $Libcontent = New-Object -TypeName System.Xml.XmlDocument
            $mediaContainerNode = $Libcontent.CreateElement('MediaContainer')
            $Libcontent.AppendChild($mediaContainerNode) | Out-Null

            # Initialize variables for pagination
            $searchsize = 0
            $totalContentSize = 1

            # Loop until all content is retrieved
            do {
                # Set headers for the current request
                $PlexHeaders['X-Plex-Container-Start'] = $searchsize
                $PlexHeaders['X-Plex-Container-Size'] = '1000'

                # Fetch content from Plex server
                $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/$($Library.ID)/all" -Headers $PlexHeaders

                # Convert response content to XML
                [xml]$additionalContent = $response.Content

                # Get total content size if not retrieved yet
                if ($totalContentSize -eq 1) {
                    $totalContentSize = $additionalContent.MediaContainer.totalSize
                }

                # Import and append video nodes to the parent XML document
                $contentquery = if ($additionalContent.MediaContainer.video) {
                    'video'
                }
                else {
                    'Directory'
                }
                foreach ($videoNode in $additionalContent.MediaContainer.$contentquery) {
                    $importedNode = $Libcontent.ImportNode($videoNode, $true)
                    [void]$mediaContainerNode.AppendChild($importedNode)
                }

                # Update search size for next request
                $searchsize += [int]$additionalContent.MediaContainer.Size
            } until ($searchsize -ge $totalContentSize)
            if ($Libcontent.MediaContainer.video) {
                $contentquery = 'video'
            }
            Else {
                $contentquery = 'Directory'
            }
            foreach ($item in $Libcontent.MediaContainer.$contentquery) {
                $extractedFolder = $null
                $Seasondata = $null
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children? -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                }
                $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
                $tmdbpattern = 'tmdb://(\d+)'
                $imdbpattern = 'imdb://tt(\d+)'
                $tvdbpattern = 'tvdb://(\d+)'
                if ($Metadata.MediaContainer.$contentquery.Location) {
                    $location = $Metadata.MediaContainer.$contentquery.Location.path
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                Else {
                    $location = $Metadata.MediaContainer.$contentquery.media.part.file
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                        $CheckCharLimit = CheckCharLimit
                        if ($CheckCharLimit -eq $false) {
                            Write-Entry -Subtext "Skipping [$($item.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            continue
                        }
                    }

                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                if ($Seasondata) {
                    $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
                    $SeasonNames = $SeasonsTemp.Title -join ','
                    $SeasonNumbers = $SeasonsTemp.index -join ','
                    $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
                    $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
                }
                $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
                $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
                $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
                if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
                if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
                if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

                # check if there are more then 1 entry in ids
                if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
                if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
                if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

                if ($Metadata.MediaContainer.$contentquery.Label.tag) {
                    $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
                }
                Else {
                    $Labels = ""
                }
                $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata){
                    $FileMetadata | ForEach-Object {
                        if ($_.streamType -eq '1') {
                            $Resolution = $_.displayTitle
                        }
                    }
                }
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.Name
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $($item.title)
                if ($FileMetadata) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $($item.originalTitle)
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $item.year
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
                $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $item.ratingKey
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
                $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
                $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
                $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    # Getting information of all Episodes
    if ($global:TitleCards -eq 'true') {
        Write-Entry -Message "Query episodes data from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata){
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Query Jellyfin/Emby
    Write-Entry -Message "Query Jellyfin/Emby..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $PreferredMetadataLanguage = (Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/System/Configuration?api_key=$OtherMediaServerApiKey").PreferredMetadataLanguage
    $allLibsquery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
    $OtherAllLibs = Invoke-RestMethod -Method Get -Uri $allLibsquery

    write-Entry -Subtext "Found '$($OtherAllLibs.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = ($OtherAllLibs | Where-Object { $_.Name -notin $LibstoExclude }).Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    # Debug Output all Libs
    Write-Entry -Subtext "Media Server Lib overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    Foreach ($lib in $OtherAllLibs) {
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib name: $($lib.name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib Type: $($lib.CollectionType)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib locations: $($lib.Locations)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }

    $OtherAllMovies = @()
    $OtherAllShows = @()
    $OtherAllEpisodes = @()

    foreach ($otherlib in $OtherAllLibs) {
        if ($otherlib.Name -notin $LibstoExclude) {
            if ($otherlib.CollectionType -eq 'movies') {
                Write-Entry -Subtext "Getting all Itmes from [$($otherlib.Name)] with item id [$($otherlib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allMoviesquery = "$OtherMediaServerUrl/Items?ParentId=$($otherlib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,OriginalTitle,Settings,Path,Overview,ProductionYear,Tags&IncludeItemTypes=Movie"
                $Querytemp = Invoke-RestMethod -Method Get -Uri $allMoviesquery
                $OtherAllMovies += $Querytemp
            }
            if ($otherlib.CollectionType -eq 'tvshows') {
                Write-Entry -Subtext "Getting all Itmes from [$($otherlib.Name)] with item id [$($otherlib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allShowsquery = "$OtherMediaServerUrl/Items?ParentId=$($otherlib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags&IncludeItemTypes=Series"
                $allEpisodesquery = "$OtherMediaServerUrl/Items?ParentId=$($otherlib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,Settings,Tags&IncludeItemTypes=Episode"
                $Querytempshow = Invoke-RestMethod -Method Get -Uri $allShowsquery
                $QuerytempEpisodes = Invoke-RestMethod -Method Get -Uri $allEpisodesquery
                $OtherAllShows += $Querytempshow
                $OtherAllEpisodes += $QuerytempEpisodes
            }
        }
    }

    $OtherLibraries = @()
    foreach ($Movie in $OtherAllMovies.Items) {
        if ($SyncEmby) {
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
            $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
            $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations -Unique

            foreach ($singlelibrary in $librariestemp) {
                foreach ($location in $singlelibrary.Locations) {
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$($location)/*" -or $Movie.Path -like "$($location)\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Libpath: $($lib.Path[1])" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $Matchedpath = AddTrailingSlash $($lib.Path[1])
            $libpath = $Matchedpath
            $relativePath = $Movie.Path.Substring($libpath.Length)
            $pathSegments = $relativePath -split '[\\/]'

            # Determine the extracted folder and the root folder path
            if ($pathSegments.Count -gt 2) {
                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
            }
            else {
                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                $extraFolder = $null  # No parent structure
            }
            if ($Movie.Tags) {
                $Labels = $($Movie.Tags -join ',')
            }
            Else {
                $Labels = ""
            }
            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $temp = New-Object psobject
            $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
            $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
            $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
            $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
            $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
            $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
            $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
            $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
            $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
            $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
            $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
            $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
            $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
            $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
            $OtherLibraries += $temp
            Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        }
        Else {
            Write-Entry -Subtext "Processing - '$($Movie.Name)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
            $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
            $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations -Unique

            foreach ($singlelibrary in $librariestemp) {
                # Loop through each location in the library's Locations array
                foreach ($location in $singlelibrary.Locations) {
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$location/*" -or $Movie.Path -like "$location\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            if ($SingleLibName -notin $LibstoExclude) {
                Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $Matchedpath = AddTrailingSlash $($lib.Path)
                $libpath = $Matchedpath
                $relativePath = $Movie.Path.Substring($libpath.Length)
                $pathSegments = $relativePath -split '[\\/]'

                # Determine the extracted folder and the root folder path
                if ($pathSegments.Count -gt 2) {
                    $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                    $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                }
                else {
                    $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                    $extraFolder = $null  # No parent structure
                }
                Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
            if ($Movie.Tags) {
                $Labels = $($Movie.Tags -join ',')
            }
            Else {
                $Labels = ""
            }
            $temp = New-Object psobject
            $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
            $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
            $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
            $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
            $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
            $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
            $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
            $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
            $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
            $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
            $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
            $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
            $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
            $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
            $OtherLibraries += $temp
            Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        }
    }
    foreach ($Show in $OtherAllShows.Items) {
        $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Show.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
        $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, path

        $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
        $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
        $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations -Unique

        foreach ($singlelibrary in $librariestemp) {
            # Loop through each location in the library's Locations array
            foreach ($location in $singlelibrary.Locations) {
                Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                # Compare lib.Path with each location
                if ($Show.Path -like "$location/*" -or $Show.Path -like "$location\*") {
                    $SingleLibName = $singlelibrary.Name
                    Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    break # Exit loop after match
                }
            }
        }

        Write-Entry -Subtext "Location: $($Show.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $Matchedpath = AddTrailingSlash $($lib.Path)
        $libpath = $Matchedpath
        $relativePath = $Show.Path.Substring($libpath.Length)
        $pathSegments = $relativePath -split '[\\/]'

        # Determine the extracted folder and the root folder path
        if ($pathSegments.Count -gt 2) {
            $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
            $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
        }
        else {
            $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
            $extraFolder = $null  # No parent structure
        }
        Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

        if ($Show.Tags) {
            $Labels = $($Show.Tags -join ',')
        }
        Else {
            $Labels = ""
        }

        $temp = New-Object psobject
        $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
        $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Show.Type
        $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
        $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Show.Id
        $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Show.Name
        $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Show.OriginalTitle
        $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Show.ProductionYear
        $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Show.ProviderIds.Imdb
        $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Show.ProviderIds.Tmdb
        $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Show.ProviderIds.Tvdb
        $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
        $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
        $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
        $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Show.ImageTags.Primary
        $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Show.BackdropImageTags -join ",")
        $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
        $OtherLibraries += $temp
        Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }
    Write-Entry -Subtext "Found '$($OtherLibraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $OtherEpisodedata = @()
    $TempShowLibs = $OtherLibraries | Where-Object { $_."Library Type" -eq 'Series' }
    foreach ($show in $TempShowLibs) {
        # Iterate through all shows
        $seasons = $OtherAllEpisodes.Items | Where-Object { $_.SeriesId -eq $show.id } | Group-Object -Property SeasonName | Sort-Object -Property Name
        foreach ($Season in $Seasons) {
            # Sort episodes within the season by IndexNumber
            $SeasonEpisodes = $Season.Group | Sort-Object -Property indexnumber

            # Collect episode IDs, Titles, and PrimaryImageTags
            $EpisodeIds = ($SeasonEpisodes.Id -join ',')
            $EpisodeTitles = ($SeasonEpisodes.Name -join ';')
            $Episodes = ($SeasonEpisodes.IndexNumber -join ',')
            $Thumbs = ($SeasonEpisodes.ImageTags.Primary -join ',')

            # Calculate the ShowID and SeasonId
            $ShowID = if ($SeasonEpisodes.SeriesId) { $SeasonEpisodes.SeriesId[0] } else { $null }
            $SeasonId = if ($SeasonEpisodes.SeasonId) { $SeasonEpisodes.SeasonId[0] } else { $null }

            # Create an object for the current season
            $seasonObject = [PSCustomObject]@{
                "Library Name"                 = $show."Library Name"
                "Show Name"                    = $show.title
                "Show Original Name"           = $show.OriginalTitle
                "Library Language"             = $PreferredMetadataLanguage
                "ShowID"                       = $ShowID
                "SeasonId"                     = $SeasonId
                "EpisodeIds"                   = $EpisodeIds
                "tvdbid"                       = $show.tvdbid
                "imdbid"                       = $show.imdbid
                "tmdbid"                       = $show.tmdbid
                "type"                         = "Episode"
                "Season Number"                = $SeasonEpisodes[0].ParentIndexNumber
                "SeasonName"                   = $Season.Name
                "Episodes"                     = $Episodes
                "Title"                        = $EpisodeTitles
                "OtherMediaServerTitleCardTag" = $Thumbs
                "OtherMediaServerSeasonTag"    = $SeasonEpisodes[0].SeriesPrimaryImageTag
            }

            # Add the season object to the array
            $OtherEpisodedata += $seasonObject
        }
    }
    if ($OtherAllEpisodes) {
        Write-Entry -Subtext "Found '$($OtherAllEpisodes.items.count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }

    $OtherAllShows = $OtherLibraries | Where-Object { $_.'Library Type' -eq 'Series' }
    $OtherAllMovies = $OtherLibraries | Where-Object { $_.'Library Type' -eq 'Movie' }

    # Create an empty array to hold the custom objects
    $FormattedData = @()

    # Iterate over each item in $OtherEpisodedata
    foreach ($data in $OtherEpisodedata) {
        # Create a custom object for each episode using the variables
        $FormattedData += [PSCustomObject]@{
            'Library Name'                 = $data.'Library Name'
            'Show Name'                    = $data.'Show Name'
            'Show Original Name'           = $data.'Show Original Name'
            'Library Language'             = $data.'Library Language'
            'ShowID'                       = $data.'ShowID'
            'SeasonId'                     = $data.'SeasonId'
            'EpisodeIds'                   = $data.'EpisodeIds'
            'tvdbid'                       = $data.'tvdbid'
            'imdbid'                       = $data.'imdbid'
            'tmdbid'                       = $data.'tmdbid'
            'type'                         = $data.'type'
            'Season Number'                = $data.'Season Number'
            'SeasonName'                   = $data.'SeasonName'
            'Episodes'                     = $data.'Episodes'
            'Title'                        = $data.'Title'
            'OtherMediaServerTitleCardTag' = $data.'OtherMediaServerTitleCardTag'
            'OtherMediaServerSeasonTag'    = $data.'OtherMediaServerSeasonTag'
        }
    }

    # Export the formatted data to CSV
    $FormattedData | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherEpisodedata.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    $OtherLibraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherLibraries.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    $Episodedata | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\Episodedata.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\Libraries.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force

    # START HERE
    Write-Entry -Message "Starting artwork sync now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting movie artwork sync part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexPosterUrl
                    }
                    $matchingMovie = $OtherAllMovies | Where-Object {
                        $_.Title -eq $entry.Title -and
                        $_."Library Name" -eq $entry."Library Name" -and (
                            $_.TmdbId -eq $entry.TmdbId -or
                            $_.TvdbId -eq $entry.TvdbId -or
                            $_.ImdbId -eq $entry.ImdbId
                        )
                    }
                    if ($matchingMovie) {
                        $MovieTitle = $entry.Title
                        $imageType = "Primary"
                        Write-Entry -Subtext "Movie Title: $MovieTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($matchingMovie.id.Count -gt 1) {
                            foreach ($id in $matchingMovie.id){
                                $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'poster'
                                Write-Entry -Subtext "Movie ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }
                        Else {
                            $DestUrl = "$OtherMediaServerUrl/items/$($matchingMovie.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                            if ($matchingMovie.id){
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'poster'
                                Write-Entry -Subtext "Movie ID: $($matchingMovie.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                            Else {
                                Write-Entry -Message "Could not find Movie ID for '$MovieTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            }
                        }
                    }
                }
                # Now we can start the Background Poster Part
                if ($global:BackgroundPosters -eq 'true') {
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl
                    }

                    $matchingMovie = $OtherAllMovies | Where-Object {
                        $_.Title -eq $entry.Title -and
                        $_."Library Name" -eq $entry."Library Name" -and (
                            $_.TmdbId -eq $entry.TmdbId -or
                            $_.TvdbId -eq $entry.TvdbId -or
                            $_.ImdbId -eq $entry.ImdbId
                        )
                    }
                    if ($matchingMovie) {
                        $MovieTitle = $entry.Title + " | Background"
                        $imageType = "Backdrop"
                        Write-Entry -Subtext "Movie Title: $MovieTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($matchingMovie.id.Count -gt 1) {
                            foreach ($id in $matchingMovie.id){
                                $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'background'
                                Write-Entry -Subtext "Movie ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }
                        Else {
                            $DestUrl = "$OtherMediaServerUrl/items/$($matchingMovie.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                            if ($matchingMovie.id){
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'background'
                                Write-Entry -Subtext "Movie ID: $($matchingMovie.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                            Else {
                                Write-Entry -Message "Could not find Movie ID for '$MovieTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            }
                        }
                    }
                }
            }
        }
        catch {
            write-Entry -Subtext "For: $MovieTitle in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Could not sync movies to jelly/emby, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }

    Write-Entry -Message "Starting show artwork sync part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    foreach ($entry in $AllShows) {
        try {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexPosterUrl
                    }

                    $matchingShow = $OtherAllShows | Where-Object {
                        ($_.Title -eq $entry.Title -or $_.originalTitle -eq $entry.originalTitle) -and
                        $_."Library Name" -eq $entry."Library Name" -and (
                            $_.TmdbId -eq $entry.TmdbId -or
                            $_.TvdbId -eq $entry.TvdbId
                        )
                    }
                    if ($matchingShow) {
                        $ShowTitle = $entry.Title
                        $imageType = "Primary"
                        Write-Entry -Subtext "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($matchingShow.id.Count -gt 1) {
                            foreach ($id in $matchingShow.id){
                                $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'poster'
                                Write-Entry -Subtext "Show ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }
                        Else {
                            $DestUrl = "$OtherMediaServerUrl/items/$($matchingShow.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                            if ($matchingShow.id){
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'poster'
                                Write-Entry -Subtext "Show ID: $($matchingShow.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                            Else {
                                Write-Entry -Message "Could not find Show ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            }
                        }
                    }
                }
                # Now we can start the Background Poster Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl
                    }

                    $matchingShow = $OtherAllShows | Where-Object {
                        ($_.Title -eq $entry.Title -or $_.originalTitle -eq $entry.originalTitle) -and
                        $_."Library Name" -eq $entry."Library Name" -and (
                            $_.TmdbId -eq $entry.TmdbId -or
                            $_.TvdbId -eq $entry.TvdbId
                        )
                    }
                    if ($matchingShow) {
                        $ShowTitle = $entry.Title + " | Background"
                        $imageType = "Backdrop"
                        Write-Entry -Subtext "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($matchingShow.id.Count -gt 1) {
                            foreach ($id in $matchingShow.id){
                                $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'background'
                                Write-Entry -Subtext "Show ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }
                        Else {
                            $DestUrl = "$OtherMediaServerUrl/items/$($matchingShow.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                            if ($matchingShow.id){
                                SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'background'
                                Write-Entry -Subtext "Show ID: $($matchingShow.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                            Else {
                                Write-Entry -Message "Could not find Show ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            }
                        }
                    }
                }
                # Now we can start the Season Poster Part
                if ($global:SeasonPosters -eq 'true') {
                    $global:seasonNumbers = $entry.seasonNumbers -split ','
                    $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                    for ($i = 0; $i -lt $global:seasonNumbers.Count; $i++) {
                        $global:SeasonNumber = $global:seasonNumbers[$i]
                        $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]

                        if ($PlexToken) {
                            $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $global:PlexSeasonUrl
                        }

                        $matchingSeason = $OtherEpisodedata | Where-Object {
                            ($_.'Show Name' -eq $entry.Title -or $_.'Show Name' -eq $entry.originalTitle -or $_."Show Original Name" -eq $entry.originalTitle -or $_."Show Original Name" -eq $entry.Title) -and
                            $_."Library Name" -eq $entry."Library Name" -and
                            $_."Season Number" -eq $global:SeasonNumber -and (
                                $_.TmdbId -eq $entry.TmdbId -or
                                $_.TvdbId -eq $entry.TvdbId
                            )
                        }
                        if ($matchingSeason) {
                            $ShowTitle = $entry.Title + " | Season $global:SeasonNumber"
                            $imageType = "Primary"
                            Write-Entry -Subtext "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if ($matchingSeason.SeasonId.Count -gt 1) {
                                foreach ($id in $matchingSeason.SeasonId){
                                    $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'season'
                                    Write-Entry -Subtext "Season ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                            }
                            Else {
                                $DestUrl = "$OtherMediaServerUrl/items/$($matchingSeason.SeasonId)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                if ($matchingSeason.SeasonId){
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'season'
                                    Write-Entry -Subtext "Season ID: $($matchingSeason.SeasonId)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                                Else {
                                    Write-Entry -Message "Could not find Season ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                        }
                    }
                }
                # Now we can start the Title Card Part
                if ($global:TitleCards -eq 'true') {
                    foreach ($episode in $Episodedata) {
                        $global:show_name = $episode."Show Name"
                        $global:season_number = $episode."Season Number"
                        $global:episode_numbers = $episode."Episodes".Split(",")
                        $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")

                        # Match based on Show name, tmdbid, tvdbid, and Library Name
                        if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and
                            ($episode.'Show Name' -eq $entry.title -or $episode.'Show Name' -eq $entry.originalTitle) -and
                            $episode.'Library Name' -eq $entry.'Library Name') {

                            # Loop through episodes in $episode_numbers
                            for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                                $global:episodenumber = $($global:episode_numbers[$i].Trim())

                                if ($PlexToken) {
                                    $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                }
                                else {
                                    $Arturl = $plexurl + $global:PlexTitleCardUrl
                                }

                                # Find matching episode in OtherEpisodedata
                                $matchingEpisode = $OtherEpisodedata | Where-Object {
                                    ($_.'Show Name' -eq $entry.title -or $_.'Show Name' -eq $entry.originalTitle) -and
                                    $_."Library Name" -eq $entry."Library Name" -and
                                    $_."Season Number" -eq $global:season_number -and
                                    ($_.Episodes.Split(",") -contains $global:episodenumber) -and (
                                        $_.TmdbId -eq $entry.TmdbId -or
                                        $_.TvdbId -eq $entry.TvdbId
                                    )
                                }
                                if ($matchingEpisode) {
                                    # Select the matching episode ID based on the current index
                                    $global:episodeid = $matchingEpisode.EpisodeIds.Split(",")[$i]
                                    # Construct the show title with the current episode number
                                    $ShowTitle = "$($entry.Title) | Season $($global:season_number) - Episode $global:episodenumber"
                                    # Define the image type and destination URL
                                    $imageType = "Primary"
                                    $DestUrl = "$OtherMediaServerUrl/items/$($global:episodeid)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                    # Call the SyncPlexArtwork function to sync the artwork
                                    if ($matchingShow.id){
                                        SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'tc'
                                    }
                                    Else {
                                        Write-Entry -Message "Could not find Episode ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                    Write-Entry -Subtext "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "Episode ID: $global:episodeid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                            }
                        }
                    }
                }
            }
        }
        catch {
            write-Entry -Subtext "For: $ShowTitle in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Could not sync shows to jelly/emby, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images uploaded: $uploadCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }

    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    if ($global:NotifyUrl -like '*discord*' -and $global:SendNotification -eq 'true') {
        $jsonPayload = @"
            {
                "username": "$global:DiscordUserName",
                "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                "content": "",
                "embeds": [
                {
                    "author": {
                    "name": "Posterizarr @Github",
                    "url": "https://github.com/fscorrupt/Posterizarr"
                    },
                    "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                    "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                    "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                    "fields": [
                    {
                        "name": "",
                        "value": ":bar_chart:",
                        "inline": false
                    },
                    {
                        "name": "Errors",
                        "value": "$errorCount",
                        "inline": false
                    },
                    {
                        "name": "",
                        "value": ":frame_photo:",
                        "inline": false
                    },
                    {
                        "name": "Posters Uploaded",
                        "value": "$($uploadCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                        "inline": false
                    },
                    {
                        "name": "Backgrounds Uploaded",
                        "value": "$BackgroundCount",
                        "inline": true
                    },
                    {
                        "name": "Seasons Uploaded",
                        "value": "$SeasonCount",
                        "inline": true
                    },
                    {
                        "name": "TitleCards Uploaded",
                        "value": "$EpisodeCount",
                        "inline": true
                    }
                    ],
                    "thumbnail": {
                        "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                    },
                    "footer": {
                        "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                    }
                }
                ]
            }
"@
        $global:NotifyUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
        Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
    }
    Else {
        if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*' -and $global:SendNotification -eq 'true') {
            if ($errorCount -ge '1') {
                apprise --notification-type="failure" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images`n`nDuring execution '$errorCount' Errors occurred, please check log for detailed description." "$global:NotifyUrl"
            }
            Else {
                apprise --notification-type="success" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images" "$global:NotifyUrl"
            }
        }
    }

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
Elseif ($OtherMediaServerUrl -and $OtherMediaServerApiKey -and $UseOtherMediaServer -eq 'true') {
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $PosterUnknownCount = 0
    Write-Entry -Message "Query Jellyfin/Emby..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $PreferredMetadataLanguage = (Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/System/Configuration?api_key=$OtherMediaServerApiKey").PreferredMetadataLanguage
    $allLibsquery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
    $AllLibs = Invoke-RestMethod -Method Get -Uri $allLibsquery

    write-Entry -Subtext "Found '$($AllLibs.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = ($AllLibs | Where-Object { $_.Name -notin $LibstoExclude }).Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    # Debug Output all Libs
    Write-Entry -Subtext "Media Server Lib overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    Foreach ($lib in $AllLibs) {
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib name: $($lib.name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib Type: $($lib.CollectionType)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib locations: $($lib.Locations)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }
    $AllMovies = @()
    $AllShows = @()
    $AllEpisodes = @()
    foreach ($slib in $AllLibs) {
        if ($slib.Name -notin $LibstoExclude) {
            if ($slib.CollectionType -eq 'movies') {
                Write-Entry -Subtext "Getting all Itmes from [$($slib.Name)] with item id [$($slib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allMoviesquery = "$OtherMediaServerUrl/Items?ParentId=$($slib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,OriginalTitle,Settings,Path,Overview,ProductionYear,Tags,Width,Height&IncludeItemTypes=Movie"
                $Querytemp = Invoke-RestMethod -Method Get -Uri $allMoviesquery
                $AllMovies += $Querytemp
            }
            if ($slib.CollectionType -eq 'tvshows') {
                Write-Entry -Subtext "Getting all Itmes from [$($slib.Name)] with item id [$($slib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allShowsquery = "$OtherMediaServerUrl/Items?ParentId=$($slib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags,Width,Height&IncludeItemTypes=Series"
                $allEpisodesquery = "$OtherMediaServerUrl/Items?ParentId=$($slib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,Settings,Tags,Width,Height&IncludeItemTypes=Episode"
                $Querytempshow = Invoke-RestMethod -Method Get -Uri $allShowsquery
                $QuerytempEpisodes = Invoke-RestMethod -Method Get -Uri $allEpisodesquery
                $AllShows += $Querytempshow
                $AllEpisodes += $QuerytempEpisodes
            }
        }
    }

    $Libraries = @()
    foreach ($Movie in $AllMovies.Items) {
        $Resolution = $null
        if ($UseEmby -eq 'true') {
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
            $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
            $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations -Unique

            foreach ($singlelibrary in $librariestemp) {
                foreach ($location in $singlelibrary.Locations) {
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$($location)/*" -or $Movie.Path -like "$($location)\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            if ($SingleLibName -notin $LibstoExclude) {
                Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "Libpath: $($lib.Path[1])" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $Matchedpath = AddTrailingSlash $($lib.Path[1])
                $libpath = $Matchedpath
                $relativePath = $Movie.Path.Substring($libpath.Length)
                $pathSegments = $relativePath -split '[\\/]'

                # Determine the extracted folder and the root folder path
                if ($pathSegments.Count -gt 2) {
                    $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                    $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                }
                else {
                    $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                    $extraFolder = $null  # No parent structure
                }

                if ($Movie.Tags) {
                    $Labels = $($Movie.Tags -join ',')
                }
                Else {
                    $Labels = ""
                }
                # Determine resolution category
                if ($movie.Width -and $movie.Height) {
                    $Resolution = Get-Resolution -Width $movie.Width
                }

                Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
                $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
                if ($Resolution) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        Else {
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
            $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
            $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations -Unique

            foreach ($singlelibrary in $librariestemp) {
                # Loop through each location in the library's Locations array
                foreach ($location in $singlelibrary.Locations) {
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$location/*" -or $Movie.Path -like "$location\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            if ($SingleLibName -notin $LibstoExclude) {
                Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                if ($lib.Path.count -gt '1') {
                    $Matchedpath = AddTrailingSlash $($lib.Path[0])
                }
                else {
                    $Matchedpath = AddTrailingSlash $($lib.Path)
                }
                $libpath = $Matchedpath
                $relativePath = $Movie.Path.Substring($libpath.Length)
                $pathSegments = $relativePath -split '[\\/]'

                # Determine the extracted folder and the root folder path
                if ($pathSegments.Count -gt 2) {
                    $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                    $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                }
                else {
                    $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                    $extraFolder = $null  # No parent structure
                }

                if ($Movie.Tags) {
                    $Labels = $($Movie.Tags -join ',')
                }
                Else {
                    $Labels = ""
                }
                # Determine resolution category
                if ($movie.Width -and $movie.Height) {
                    $Resolution = Get-Resolution -Width $movie.Width
                }
                Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
                $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
                if ($Resolution) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    foreach ($Show in $AllShows.Items) {
        $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Show.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
        $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, path

        $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
        $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
        $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations -Unique

        foreach ($singlelibrary in $librariestemp) {
            # Loop through each location in the library's Locations array
            foreach ($location in $singlelibrary.Locations) {
                Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                # Compare lib.Path with each location
                if ($Show.Path -like "$location/*" -or $Show.Path -like "$location\*") {
                    $SingleLibName = $singlelibrary.Name
                    Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    break # Exit loop after match
                }
            }
        }
        if ($SingleLibName -notin $LibstoExclude) {
            Write-Entry -Subtext "Location: $($Show.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $Matchedpath = AddTrailingSlash $($lib.Path)
            $libpath = $Matchedpath
            $relativePath = $Show.Path.Substring($libpath.Length)
            $pathSegments = $relativePath -split '[\\/]'

            # Determine the extracted folder and the root folder path
            if ($pathSegments.Count -gt 2) {
                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
            }
            else {
                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                $extraFolder = $null  # No parent structure
            }

            if ($Show.Tags) {
                $Labels = $($Show.Tags -join ',')
            }
            Else {
                $Labels = ""
            }

            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

            $temp = New-Object psobject
            $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
            $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Show.Type
            $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
            $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Show.Id
            $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Show.Name
            $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Show.OriginalTitle
            $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Show.ProductionYear
            $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Show.ProviderIds.Imdb
            $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Show.ProviderIds.Tmdb
            $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Show.ProviderIds.Tvdb
            $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
            $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
            $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Show.ImageTags.Primary
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Show.BackdropImageTags -join ",")
            $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
            $Libraries += $temp
            Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherMediaServerLibExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    Write-Entry -Message "Export everything to a csv: $global:ScriptRoot\Logs\OtherMediaServerLibExport.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    Write-Entry -Message "Starting episode data query now - This can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -Log Info

    $Episodedata = @()
    $TempShowLibs = $Libraries | Where-Object { $_."Library Type" -eq 'Series' }
    foreach ($show in $TempShowLibs) {
        # Iterate through all shows
        $seasons = $AllEpisodes.Items | Where-Object { $_.SeriesId -eq $show.id } | Group-Object -Property SeasonName | Sort-Object -Property Name
        foreach ($Season in $Seasons) {
            # Sort episodes within the season by IndexNumber
            $SeasonEpisodes = $Season.Group | Sort-Object -Property indexnumber

            # Collect episode IDs, Titles, and PrimaryImageTags
            $EpisodeIds = ($SeasonEpisodes.Id -join ',')
            $EpisodeWidths = ($SeasonEpisodes.Width -join ',')
            $EpisodeHeights = ($SeasonEpisodes.Height -join ',')
            $EpisodeTitles = ($SeasonEpisodes.Name -join ';')
            $Episodes = ($SeasonEpisodes.IndexNumber -join ',')
            $Thumbs = ($SeasonEpisodes.ImageTags.Primary -join ',')

            # Calculate the ShowID and SeasonId
            $ShowID = if ($SeasonEpisodes.SeriesId) { $SeasonEpisodes.SeriesId[0] } else { $null }
            $SeasonId = if ($SeasonEpisodes.SeasonId) { $SeasonEpisodes.SeasonId[0] } else { $null }

            # Create an object for the current season
            $seasonObject = [PSCustomObject]@{
                "Library Name"                 = $show."Library Name"
                "Show Name"                    = $show.title
                "Show Original Name"           = $show.OriginalTitle
                "Library Language"             = $PreferredMetadataLanguage
                "ShowID"                       = $ShowID
                "SeasonId"                     = $SeasonId
                "EpisodeIds"                   = $EpisodeIds
                "EpisodeWidths"                = $EpisodeWidths
                "EpisodeHeights"               = $EpisodeHeights
                "tvdbid"                       = $show.tvdbid
                "imdbid"                       = $show.imdbid
                "tmdbid"                       = $show.tmdbid
                "type"                         = "Episode"
                "Season Number"                = $SeasonEpisodes[0].ParentIndexNumber
                "SeasonName"                   = $Season.Name
                "Episodes"                     = $Episodes
                "Title"                        = $EpisodeTitles
                "OtherMediaServerTitleCardTag" = $Thumbs
                "OtherMediaServerSeasonTag"    = $SeasonEpisodes[0].SeriesPrimaryImageTag
            }

            # Add the season object to the array
            $Episodedata += $seasonObject
        }
    }
    # Create an empty array to hold the custom objects
    $FormattedData = @()

    # Iterate over each item in $OtherEpisodedata
    foreach ($data in $Episodedata) {
        $EpisodeWidths = $data.EpisodeWidths -split ","
        $EpisodeHeights = $data.EpisodeHeights -split ","
        # Initialize an empty array for resolutions
        $Resolution = @()

        # Loop through each episode and determine resolution
        for ($i = 0; $i -lt $EpisodeWidths.Count; $i++) {
            $Width = [int]$EpisodeWidths[$i]
            $Resolution += Get-Resolution -Width $Width
        }
        # Create a custom object for each episode using the variables
        $FormattedData += [PSCustomObject]@{
            'Library Name'                 = $data.'Library Name'
            'Show Name'                    = $data.'Show Name'
            'Show Original Name'           = $data.'Show Original Name'
            'Library Language'             = $data.'Library Language'
            'ShowID'                       = $data.'ShowID'
            'SeasonId'                     = $data.'SeasonId'
            'EpisodeIds'                   = $data.'EpisodeIds'
            'Resolutions'                  = $Resolution -join ","
            'tvdbid'                       = $data.'tvdbid'
            'imdbid'                       = $data.'imdbid'
            'tmdbid'                       = $data.'tmdbid'
            'type'                         = $data.'type'
            'Season Number'                = $data.'Season Number'
            'SeasonName'                   = $data.'SeasonName'
            'Episodes'                     = $data.'Episodes'
            'Title'                        = $data.'Title'
            'OtherMediaServerTitleCardTag' = $data.'OtherMediaServerTitleCardTag'
            'OtherMediaServerSeasonTag'    = $data.'OtherMediaServerSeasonTag'
        }
    }

    # Export the formatted data to CSV
    $FormattedData | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherMediaServerEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    if ($AllEpisodes) {
        Write-Entry -Subtext "Found '$($AllEpisodes.Items.count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }

    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'Series' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'Movie' }

    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")

        if ($FollowSymlink){
            Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $AssetPath -Recurse | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }

        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }

    Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    $checkedItems = @()
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    $global:posterurl = $null
                    $global:ImageMagickError = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $global:IsFallback = $null
                    $global:langCode = $null
                    $global:direction = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern -and $entry.originalTitle) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }
                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {
                        $checkedItems += $hashtestpath
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkipingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:TextlessPoster = $null
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:ImageMagickError = $null
                            $TakeLocal = $null
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    Default { $global:posterurl = GetFanartMoviePoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                }
                                if ($global:PreferTextless -eq 'True') {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if ($global:OnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Elseif ($global:FavProvider -eq 'FANART') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMoviePoster
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB' -and !$global:OnlyTextless -and !$global:PreferTextless) {
                                        $global:posterurl = GetTVDBMoviePoster
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl -and $global:imdbid -and !$global:OnlyTextless) {
                                        Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:posterurl = GetIMDBPoster
                                        $global:IsFallback = $true
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                    try {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                    }
                                    catch {
                                        $statusCode = $_.Exception.Response.StatusCode
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $errorCount++
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if ($UsePosterResolutionOverlays -eq 'true'){
                                            switch ($entry.Resolution) {
                                                '4K' { $Posteroverlay = $4kposter }
                                                '1080p' { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                            $SkipingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkipingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                # Move file back to original naming with Brackets.
                                if (!$global:ImageMagickError -eq 'True') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImage
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $movietemp = New-Object psobject
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }

                                            # Export the array to a CSV file
                                            $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $movietemp = New-Object psobject
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImageoriginal
                            }
                            Else {
                                if ($show_skipped -eq 'True' ) {
                                    Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                    # Now we can start the Background Poster Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        $checkedItems += $hashtestpath
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkipingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:ImageMagickError = $null
                            $global:TextlessPoster = $null
                            $TakeLocal = $null
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    Default { $global:posterurl = GetFanartMovieBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq 'True') {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMovieBackground
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBMovieBackground
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl) {
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($BackgroundfontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                    try {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $backgroundImage -ErrorAction Stop
                                    }
                                    catch {
                                        $statusCode = $_.Exception.Response.StatusCode
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $errorCount++
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'True') {
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                            $SkipingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkipingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }

                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'True') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImage
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                            $BackgroundCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $moviebackgroundtemp = New-Object psobject
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }
                                            # Export the array to a CSV file
                                            $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $moviebackgroundtemp = New-Object psobject
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $movietemoviebackgroundtempmp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImageoriginal
                            }
                            Else {
                                if ($show_skipped -eq 'True' ) {
                                    Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            if ($global:OnlyTextless) {
                $moviebackgroundtemp = New-Object psobject
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                switch -Wildcard ($global:FavProvider) {
                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                    Default { $movietemoviebackgroundtempmp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                }

                # Export the array to a CSV file
                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
            }
            $errorCount++
        }
    }

    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Define Global Variables
                $SkipingText = 'false'
                $global:tmdbsearched = $null
                $global:tmdbid = $entry.tmdbid
                $global:tvdbid = $entry.tvdbid
                $global:imdbid = $entry.imdbid
                $Seasonpostersearchtext = $null
                $global:ImageMagickError = $null
                $Episodepostersearchtext = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $FanartSearched = $null
                $global:posterurl = $null
                $global:PosterWithText = $null
                $global:AssetTextLang = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:Fallback = $null
                $global:TextlessPoster = $null
                $global:tvdbalreadysearched = $null
                $TakeLocal = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    if ($entry.extraFolder) {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                    }
                    Else {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                    }
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $ManualTestPath = $ManualEntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    if ($entry.extraFolder) {
                        $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                    }
                    Else {
                        $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                    }
                    $TestPath = $AssetPath
                    $ManualTestPath = $ManualPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $checkedItems += $hashtestpath
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }

                        if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                            Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Else {
                            Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                Default { $global:posterurl = GetFanartShowPoster }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                            }
                            if ($global:PreferTextless -eq 'True') {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TVDBfallbackposterurl) {
                                    $global:posterurl = $global:TVDBfallbackposterurl
                                    Write-Entry -Subtext "Took TVDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                # try to find textless on TVDB
                                if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid -and $global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                    $global:tvdbalreadysearched = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                    $global:posterurl = GetFanartMoviePoster
                                    $global:IsFallback = $true
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                $global:PosterWithText = $true
                            }

                            if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                $global:posterurl = GetTVDBShowPoster
                                $global:IsFallback = $true
                            }
                            if (!$global:posterurl) {
                                $global:IsFallback = $true
                                if (!$global:posterurl) {
                                    Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                        }
                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if (!$TakeLocal) {
                            if (!$global:TextlessPoster -eq 'True' -and $global:TMDBfallbackposterurl) {
                                $global:posterurl = $global:TMDBfallbackposterurl
                            }
                            if (!$global:TextlessPoster -eq 'True' -and $global:fanartfallbackposterurl) {
                                $global:posterurl = $global:fanartfallbackposterurl
                            }
                        }
                        if ($global:posterurl -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                try {
                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                }
                                catch {
                                    $statusCode = $_.Exception.Response.StatusCode
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'True') {
                                    if ($UsePosterResolutionOverlays -eq 'true'){
                                        switch ($entry.Resolution) {
                                            '4K' { $Posteroverlay = $4kposter }
                                            '1080p' { $Posteroverlay = $1080pPoster }
                                            Default { $Posteroverlay = $Posteroverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                        $SkipingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddText -eq 'true' -and $SkipingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $fontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $SeasonlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            # Add Stroke
                                            if ($AddTextStroke -eq 'true') {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }

                                            Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'True') {
                                if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                    # Move file back to original naming with Brackets.
                                    if (!$global:IsTruncated) {
                                        UploadOtherMediaServerArtwork -itemId $entry.Id -imageType "Primary" -imagePath $PosterImage
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$TakeLocal) {
                                        $showtemp = New-Object psobject
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                            'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                            'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                            Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                        }
                                        # Export the array to a CSV file
                                        $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            if ($global:OnlyTextless) {
                                $showtemp = New-Object psobject
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                    'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                    'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                    Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                }

                                # Export the array to a CSV file
                                $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                            }
                            $errorCount++
                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImageoriginal
                        }
                        Else {
                            if ($show_skipped -eq 'True' ) {
                                Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Background Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                        }
                        Else {
                            $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkipingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:TextlessPoster = $null
                        $global:ImageMagickError = $null
                        $TakeLocal = $null
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }

                        if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                            Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Else {
                            Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                Default { $global:posterurl = GetFanartShowBackground }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                            }
                            if ($global:BackgroundPreferTextless -eq 'True') {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                            }
                            if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                if ($global:FavProvider -eq 'TVDB') {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                                Else {
                                    $global:posterurl = GetFanartShowBackground
                                }
                            }
                            if (!$global:posterurl) {
                                if ($global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowBackground
                                    $global:IsFallback = $true
                                }
                                $global:FallbackText = 'True-Background'
                                if (!$global:posterurl) {
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }

                            }
                        }
                        if ($BackgroundfontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                }
                                try {
                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $backgroundImage -ErrorAction Stop
                                }
                                catch {
                                    $statusCode = $_.Exception.Response.StatusCode
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'True') {
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                        $SkipingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddBackgroundText -eq 'true' -and $SkipingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $backgroundfontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            # Add Stroke
                                            if ($AddBackgroundTextStroke -eq 'true') {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'True') {
                                # Move file back to original naming with Brackets.
                                if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                    if (!$global:IsTruncated) {
                                        UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImage
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        $BackgroundCount++
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$TakeLocal) {
                                        $showbackgroundtemp = New-Object psobject
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                            'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                            'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                            Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                        }
                                        # Export the array to a CSV file
                                        $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            if ($global:OnlyTextless) {
                                $showbackgroundtemp = New-Object psobject
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                    'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                    'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                    Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                }

                                # Export the array to a CSV file
                                $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                            }
                            $errorCount++
                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImageoriginal
                        }
                        Else {
                            if ($show_skipped -eq 'True' ) {
                                Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Season Part
                if ($global:SeasonPosters -eq 'true') {
                    # Loop through each Season
                    foreach ($season in $Episodedata) {
                        $SkipingText = 'false'
                        $global:tmdbsearched = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TextlessPoster = $null
                        $global:seasonNames = $null
                        $global:posterurl = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TMDBSeasonFallback = $null
                        $global:TVDBSeasonFallback = $null
                        $global:FANARTSeasonFallback = $null
                        $global:seasonId = $null
                        $global:SeasonNumber = $null
                        $TakeLocal = $null

                        if ($season.tmdbid -eq $entry.tmdbid -or $season.tvdbid -eq $entry.tvdbid) {
                            $global:seasonId = $season.SeasonId
                            $global:seasonNames = $season.SeasonName
                            $global:SeasonNumber = $season."Season Number"
                            if ($SeasonfontAllCaps -eq 'true') {
                                $global:seasonTitle = $global:seasonNames.ToUpper()
                                if (!$global:seasonTitle) {
                                    $global:seasonTitle = ("Season " + $global:SeasonNumber).ToUpper()
                                }
                            }
                            Else {
                                $global:seasonTitle = $global:seasonNames
                                if (!$global:seasonTitle) {
                                    $global:seasonTitle = "Season " + $global:SeasonNumber
                                }
                            }
                            if ($global:SeasonNumber) {
                                $global:season = "Season" + $global:SeasonNumber.ToString().PadLeft(2, '0')
                            }
                            if ($LibraryFolders -eq 'true') {
                                $SeasonImageoriginal = "$EntryDir\$global:season.jpg"
                                $TestPath = $EntryDir
                                $ManualTestPath = $ManualEntryDir
                                $Testfile = "$global:season"
                            }
                            Else {
                                if ($entry.extraFolder) {
                                    $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:season.jpg"
                                }
                                Else {
                                    $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:season.jpg"
                                }
                                $TestPath = $AssetPath
                                $ManualTestPath = $ManualPath
                                $Testfile = "$($entry.RootFoldername)_$global:season"
                            }

                            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            }
                            else {
                                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                if ($fullTestPath) {
                                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                }
                                Else {
                                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                }
                            }

                            Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                            $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:season.jpg"
                            $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                            $checkedItems += $hashtestpath
                            if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                foreach ($ext in $allowedExtensions) {
                                    $filePath = "$ManualTestPath$ext"
                                    if (Test-Path -LiteralPath $filePath) {
                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        $posterext = $ext
                                        break
                                    }
                                }

                                if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                    Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $TakeLocal = $true
                                }
                                Else {
                                    if (!$Seasonpostersearchtext) {
                                        Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $Seasonpostersearchtext = $true
                                    }
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                        'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                        Default { $global:posterurl = GetFanartSeasonPoster }
                                    }
                                    # do a specific order
                                    if ($global:SeasonPreferTextless -eq 'True') {
                                        if (!$global:posterurl -or !$global:TextlessPoster) {
                                            if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                $global:posterurl = GetTMDBSeasonPoster
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                            if (!$global:posterurl -or !$global:TextlessPoster) {
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:posterurl = GetFanartSeasonPoster
                                                    Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                    $global:posterurl = GetTVDBSeasonPoster
                                                    Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                        if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                            # Lets just try to grab a show poster.
                                            Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                                Default { $global:posterurl = GetFanartShowPoster }
                                            }
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                            Else {
                                                if ($global:FavProvider -ne 'TMDB') {
                                                    $global:posterurl = GetTMDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                    $global:posterurl = GetTVDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                    $global:posterurl = GetFanartShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        if (!$global:posterurl) {
                                            if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                $global:posterurl = GetTMDBSeasonPoster
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                            if (!$global:posterurl) {
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:posterurl = GetFanartSeasonPoster
                                                    Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            if (!$global:posterurl -and $entry.tvdbid) {
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                    $global:posterurl = GetTVDBSeasonPoster
                                                    Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                    if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                        # Lets just try to grab a show poster.
                                        Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'FANART' { $global:posterurl = GetFanartShowPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                            Default { $global:posterurl = GetFanartShowPoster }
                                        }
                                        if ($global:posterurl) {
                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Show'
                                        }
                                        Else {
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:posterurl = GetTMDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                $global:posterurl = GetTVDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                $global:posterurl = GetFanartShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                        }
                                    }
                                    if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                        $global:posterurl = $global:TMDBSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                        $global:posterurl = $global:FANARTSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                        $global:posterurl = $global:TVDBSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }

                                }
                                if ($global:posterurl -or $TakeLocal) {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Poster url: $global:posterurl" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'IMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        try {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                        }
                                        catch {
                                            $statusCode = $_.Exception.Response.StatusCode
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                    }
                                    if ($global:ImageProcessing -eq 'true') {
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                            if (!$global:ImageMagickError -eq 'True') {
                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }

                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                    $SkipingText = 'true'
                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                }
                                                if ($AddSeasonText -eq 'true' -and $SkipingText -eq 'false') {
                                                    $global:seasonTitle = $global:seasonTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                    if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                        $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                    }
                                                    Else {
                                                        $global:ShowTitleOnSeason = $titletext -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                    }
                                                    # Loop through each symbol and replace it with a newline
                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                        foreach ($symbol in $NewLineSymbols) {
                                                            $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), "`n"
                                                            if ($AddShowTitletoSeason -eq 'true') {
                                                                $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), "`n"
                                                            }
                                                        }
                                                    }
                                                    $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                    $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                    if ($AddShowTitletoSeason -eq 'true') {
                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                        $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                        if (!$global:IsTruncated) {
                                                            Write-Entry -Subtext "Optimal Season font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            Write-Entry -Subtext "Optimal Show font size set to: '$ShowoptimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            # Season Part
                                                            # Add Stroke
                                                            if ($AddSeasonTextStroke -eq 'true') {
                                                                $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $SeasonArguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                            # Show Part
                                                            # Add Stroke
                                                            if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                                $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                        }
                                                    }
                                                    Else {
                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                        if (!$global:IsTruncated) {
                                                            Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            # Add Stroke
                                                            if ($AddSeasonTextStroke -eq 'true') {
                                                                $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            # Resize Image to 2000x3000
                                            $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                            Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Resizeargument"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                        }
                                    }
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            # Move file back to original naming with Brackets.
                                            if (!$global:IsTruncated) {
                                                UploadOtherMediaServerArtwork -itemId $global:seasonId -imageType "Primary" -imagePath $SeasonImage
                                                try {
                                                    # Attempt to move the item
                                                    Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                    # Log success if move was successful
                                                    Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                }
                                                catch {
                                                    # Log the error if the move operation fails
                                                    Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    $errorCount++
                                                }
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $SeasonCount++
                                                $posterCount++
                                            }
                                            Else {
                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            if (!$TakeLocal) {
                                                $seasontemp = New-Object psobject
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | " + $global:season)
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                                switch -Wildcard ($global:FavProvider) {
                                                    'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                    'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                    'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                    Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                }
                                                # Export the array to a CSV file
                                                $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            }
                                        }
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Missing poster URL for: $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    if ($global:OnlyTextless) {
                                        $seasontemp = New-Object psobject
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                            'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                            'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                            Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                        }

                                        # Export the array to a CSV file
                                        $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                    $errorCount++
                                }
                            }
                            else {
                                if ($global:UploadExistingAssets -eq 'true') {
                                    Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $SeasonImageoriginal
                                }
                                Else {
                                    if ($show_skipped -eq 'True' ) {
                                        Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    }
                                }
                            }
                        }
                    }
                }
                # Now we can start the Episode Part
                if ($global:TitleCards -eq 'true') {
                    # Loop through each episode
                    foreach ($episode in $Episodedata) {
                        $SkipingText = 'false'
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:TempImagecopied = $false
                        $EpisodeTempImage = $null
                        $global:ImageMagickError = $null
                        $global:season_number = $null
                        $Episodepostersearchtext = $null
                        $global:show_name = $null
                        $global:episodenumber = $null
                        $global:episode_numbers = $null
                        $global:titles = $null
                        $global:posterurl = $null
                        $global:FileNaming = $null
                        $EpisodeImageoriginal = $null
                        $EpisodeImage = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TextlessPoster = $null

                        if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title) {
                            $global:show_name = $episode."Show Name"
                            $global:season_number = $episode."Season Number"
                            $global:episode_numbers = $episode."Episodes".Split(",")
                            $global:episodeids = $episode."EpisodeIDs".Split(",")
                            $global:titles = $episode."Title".Split(";")
                            if ($UseBackgroundAsTitleCard -eq 'True') {
                                $global:ImageMagickError = $null
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkipingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:episodeid = $($global:episodeids[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.ToString().PadLeft(2, '0') + "E" + $global:episodenumber.ToString().PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                    $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'True' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'True' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }

                                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                                Write-Entry -Message "Found Manual Title Card for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($global:tmdbfallbackposterurl) {
                                                                $global:posterurl = $global:tmdbfallbackposterurl
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetFanartShowBackground
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetFanartShowBackground
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $TakeLocal) {
                                                if ($TakeLocal) {
                                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                        Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                    }
                                                    if ($global:TempImagecopied -ne 'true') {
                                                        Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                    }
                                                    Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                                Else {
                                                    if ($global:TempImagecopied -ne 'True') {
                                                        Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                    }
                                                    try {
                                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                    }
                                                    catch {
                                                        $statusCode = $_.Exception.Response.StatusCode
                                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $errorCount++
                                                    }
                                                }
                                                if ($global:ImageProcessing -eq 'true') {
                                                    $global:TempImagecopied = $true
                                                    # Check temp image
                                                    if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                        Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $errorCount++
                                                    }
                                                    Else {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'True') {
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                    $SkipingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkipingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), "`n"
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                    $SkipingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkipingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'True') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImage
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        if (!$TakeLocal) {
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'True' } Else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                        }
                                                    }
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:OnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                    }

                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }
                                                $errorCount++
                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImageoriginal
                                            }
                                            Else {
                                                if ($show_skipped -eq 'True' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                                if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                    Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkipingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:FallbackText = $null
                                    $global:ImageMagickError = $null
                                    $global:TextlessPoster = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:episodeid = $($global:episodeids[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.ToString().PadLeft(2, '0') + "E" + $global:episodenumber.ToString().PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'True' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'True' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }

                                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if ($global:Fallback -eq "TVDB") {
                                                            $global:posterurl = GetTVDBTitleCard
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if ($global:Fallback -eq "TMDB") {
                                                            $global:posterurl = GetTMDBTitleCard
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $TakeLocal) {
                                                if ($TakeLocal) {
                                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                        Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                    }
                                                    Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                                Else {
                                                    Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                        Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                                        if ($global:FavProvider -ne 'TMDB') {
                                                            $global:IsFallback = $true
                                                        }
                                                    }
                                                    if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                        Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                                        if ($global:FavProvider -ne 'TVDB') {
                                                            $global:IsFallback = $true
                                                        }
                                                    }
                                                    try {
                                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                    }
                                                    catch {
                                                        $statusCode = $_.Exception.Response.StatusCode
                                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $errorCount++
                                                    }
                                                }
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                        if (!$global:ImageMagickError -eq 'True') {
                                                            # Resize Image to 2000x3000 and apply Border and overlay
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                $SkipingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPTitleText -eq 'true' -and $SkipingText -eq 'false') {
                                                                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                    $global:EPTitle = $global:EPTitle.ToUpper()
                                                                }
                                                                $global:EPTitle = $global:EPTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                if ($global:direction -eq "RTL") {
                                                                    $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                }
                                                                # Loop through each symbol and replace it with a newline
                                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                    foreach ($symbol in $NewLineSymbols) {
                                                                        $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), "`n"
                                                                    }
                                                                }
                                                                $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                    # Add Stroke
                                                                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                $SkipingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPText -eq 'true' -and $SkipingText -eq 'false') {
                                                                if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                }
                                                                $global:SeasonEPNumber = $global:SeasonEPNumber -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                    # Add Stroke
                                                                    if ($AddTitleCardTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'True') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImage
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        if (!$TakeLocal) {
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'True' } Else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                        }
                                                    }
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:OnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                    }

                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }
                                                $errorCount++
                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImageoriginal
                                            }
                                            Else {
                                                if ($show_skipped -eq 'True' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }
    # Asset Cleanup
    if ($AssetCleanup -eq 'true') {
        $ImagesCleared = 0
        $PathsCleared = 0
        $savedsizestring = 0
        Write-Entry -Subtext "Starting Asset Cleanup, this can take some time..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        Write-Entry -Subtext "Only removing Artwork with posterizarr exif data" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        $processedDirectories = @()
        $uncheckedItems = $directoryHashtable.Keys | Where-Object { $_ -notin $checkedItems }

        # Perform deletion of unchecked items
        foreach ($uncheckedItem in $uncheckedItems) {
            if ($uncheckedItem -notlike '*.jpg') {
                # Full path to the item
                $uncheckedItemPath = $uncheckedItem + ".jpg"

                # Check if its a asset from Posterizarr
                $exifmagickcommand = "& `"$magick`" identify -verbose `"$uncheckedItemPath`""
                $exifmagickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

                $ExifData = (Invoke-Expression $exifmagickcommand | Select-String -Pattern 'created with ppm|created with posterizarr')

                if ($ExifData) {
                    # Remove unchecked item from filesystem
                    Remove-Item -LiteralPath $uncheckedItemPath -Force | Out-Null
                    $ImagesCleared++
                    Write-Entry -Subtext "Artwork Removed: $uncheckedItemPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    if ($LibraryFolders -eq 'true') {
                        # Determine the parent directory of the item
                        $parentDir = Split-Path -Path $uncheckedItemPath -Parent

                        # Add the directory to the list if it's not already included
                        if ($parentDir -notin $processedDirectories) {
                            $processedDirectories += $parentDir
                        }
                    }
                }
            }
        }

        # Cleanup empty Asset dirs
        if ($LibraryFolders -eq 'true') {
            # After all files are removed, check each directory in the list
            foreach ($dir in $processedDirectories) {
                # Check if the directory is now empty (including hidden and system files)
                if (-not (Get-ChildItem -LiteralPath $dir -Force)) {
                    # Remove the parent directory if it is empty
                    $PathsCleared++
                    Remove-Item -LiteralPath $dir -Force -Recurse -Confirm:$false | Out-Null
                    Write-Entry -Subtext "Removed empty directory: $dir" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                }
            }
        }
        if ($ImagesCleared -ge '1' -or $PathsCleared -ge '1') {
            Write-Entry -Message "Asset Cleanup overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        # Check new dir Size
        if ($ImagesCleared -ge '1') {
            $newtotalSize = Get-ChildItem $AssetPath -Recurse | Measure-Object -Property Length -Sum
            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($newtotalSize.Sum -gt 1GB) {
                $newtotalSizeString = "{0:N2} GB" -f ($newtotalSize.Sum / 1GB)
            }
            elseif ($newtotalSize.Sum -gt 1MB) {
                $newtotalSizeString = "{0:N2} MB" -f ($newtotalSize.Sum / 1MB)
            }
            elseif ($newtotalSize.Sum -gt 1KB) {
                $newtotalSizeString = "{0:N2} KB" -f ($newtotalSize.Sum / 1KB)
            }
            else {
                $newtotalSizeString = "$($newtotalSize.Sum) bytes"
            }

            # Saved space
            $SavedSpace = $totalSize - $newtotalSize.Sum

            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($SavedSpace -gt 1GB) {
                $savedsizestring = "{0:N2} GB" -f ($SavedSpace / 1GB)
            }
            elseif ($SavedSpace -gt 1MB) {
                $savedsizestring = "{0:N2} MB" -f ($SavedSpace / 1MB)
            }
            elseif ($SavedSpace -gt 1KB) {
                $savedsizestring = "{0:N2} KB" -f ($SavedSpace / 1KB)
            }
            else {
                $savedsizestring = "$SavedSpace bytes"
            }

            if ($ImagesCleared -ge '1') {
                Write-Entry -Subtext "Images Cleared: $ImagesCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Images Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($PathsCleared -ge '1') {
            if ($PathsCleared -ge '1') {
                Write-Entry -Subtext "Empty Folders Cleared: $PathsCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Empty Folders Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($ImagesCleared -ge '1') {
            Write-Entry -Subtext "Cleanup saved: $savedsizestring" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($UploadCount -ge '1') {
        Write-Entry -Message "Finished, Total images Uploaded: $UploadCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
        Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
            Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextlessCount) {
            Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($FallbackCount) {
            Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextCount) {
            Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($PosterUnknownCount -ge '1') {
            Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextTruncatedCount) {
            Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
        $ImageChoicesDummycsv = New-Object psobject

        # Add members to the object with empty values
        $ImageChoicesDummycsv = New-Object psobject
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

        $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    if ($global:NotifyUrl -like '*discord*' -and $global:SendNotification -eq 'true') {
        if ($SkipTBA -eq 'true' -or $SkipJapTitle -eq 'true') {
            if ($AssetCleanup -eq 'true') {
                $jsonPayload = @"
                    {
                        "username": "$global:DiscordUserName",
                        "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                        "content": "",
                        "embeds": [
                        {
                            "author": {
                            "name": "Posterizarr @Github",
                            "url": "https://github.com/fscorrupt/Posterizarr"
                            },
                            "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                            "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                            "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                            "fields": [
                            {
                                "name": "",
                                "value": ":bar_chart:",
                                "inline": false
                            },
                            {
                                "name": "Errors",
                                "value": "$errorCount",
                                "inline": false
                            },
                            {
                                "name": "Fallbacks",
                                "value": "$($FallbackCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Textless",
                                "value": "$($TextlessCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Truncated",
                                "value": "$($TextTruncatedCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Unknown",
                                "value": "$PosterUnknownCount",
                                "inline": true
                            },
                            {
                                "name": "TBA Skipped",
                                "value": "$SkipTBACount",
                                "inline": true
                            },
                            {
                                "name": "Jap/Chinese Skipped",
                                "value": "$SkipJapTitleCount",
                                "inline": true
                            },
                            {
                                "name": "",
                                "value": ":frame_photo:",
                                "inline": false
                            },
                            {
                                "name": "Posters",
                                "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                                "inline": false
                            },
                            {
                                "name": "Backgrounds",
                                "value": "$BackgroundCount",
                                "inline": true
                            },
                            {
                                "name": "Seasons",
                                "value": "$SeasonCount",
                                "inline": true
                            },
                            {
                                "name": "TitleCards",
                                "value": "$EpisodeCount",
                                "inline": true
                            },
                            {
                                "name": "",
                                "value": ":recycle:",
                                "inline": false
                            },
                            {
                                "name": "Images cleared",
                                "value": "$ImagesCleared",
                                "inline": true
                            },
                            {
                                "name": "Folders Cleared",
                                "value": "$PathsCleared",
                                "inline": true
                            },
                            {
                                "name": "Space saved",
                                "value": "$savedsizestring",
                                "inline": true
                            }
                            ],
                            "thumbnail": {
                                "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                            },
                            "footer": {
                                "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                            }
                        }
                        ]
                    }
"@
            }
            Else {
                $jsonPayload = @"
                {
                    "username": "$global:DiscordUserName",
                    "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                    "content": "",
                    "embeds": [
                    {
                        "author": {
                        "name": "Posterizarr @Github",
                        "url": "https://github.com/fscorrupt/Posterizarr"
                        },
                        "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                        "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                        "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                        "fields": [
                        {
                            "name": "",
                            "value": ":bar_chart:",
                            "inline": false
                        },
                        {
                            "name": "Errors",
                            "value": "$errorCount",
                            "inline": false
                        },
                        {
                            "name": "Fallbacks",
                            "value": "$($FallbackCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Textless",
                            "value": "$($TextlessCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Truncated",
                            "value": "$($TextTruncatedCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Unknown",
                            "value": "$PosterUnknownCount",
                            "inline": true
                        },
                        {
                            "name": "TBA Skipped",
                            "value": "$SkipTBACount",
                            "inline": true
                        },
                        {
                            "name": "Jap/Chinese Skipped",
                            "value": "$SkipJapTitleCount",
                            "inline": true
                        },
                        {
                            "name": "",
                            "value": ":frame_photo:",
                            "inline": false
                        },
                        {
                            "name": "Posters",
                            "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                            "inline": false
                        },
                        {
                            "name": "Backgrounds",
                            "value": "$BackgroundCount",
                            "inline": true
                        },
                        {
                            "name": "Seasons",
                            "value": "$SeasonCount",
                            "inline": true
                        },
                        {
                            "name": "TitleCards",
                            "value": "$EpisodeCount",
                            "inline": true
                        }
                        ],
                        "thumbnail": {
                            "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                        },
                        "footer": {
                            "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                        }
                    }
                    ]
                }
"@
            }
        }
        Else {
            if ($AssetCleanup -eq 'true') {
                $jsonPayload = @"
                    {
                        "username": "$global:DiscordUserName",
                        "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                        "content": "",
                        "embeds": [
                        {
                            "author": {
                            "name": "Posterizarr @Github",
                            "url": "https://github.com/fscorrupt/Posterizarr"
                            },
                            "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                            "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                            "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                            "fields": [
                            {
                                "name": "",
                                "value": ":bar_chart:",
                                "inline": false
                            },
                            {
                                "name": "Errors",
                                "value": "$errorCount",
                                "inline": false
                            },
                            {
                                "name": "Fallbacks",
                                "value": "$($FallbackCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Textless",
                                "value": "$($TextlessCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Truncated",
                                "value": "$($TextTruncatedCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Unknown",
                                "value": "$PosterUnknownCount",
                                "inline": true
                            },
                            {
                                "name": "",
                                "value": ":frame_photo:",
                                "inline": false
                            },
                            {
                                "name": "Posters",
                                "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                                "inline": false
                            },
                            {
                                "name": "Backgrounds",
                                "value": "$BackgroundCount",
                                "inline": true
                            },
                            {
                                "name": "Seasons",
                                "value": "$SeasonCount",
                                "inline": true
                            },
                            {
                                "name": "TitleCards",
                                "value": "$EpisodeCount",
                                "inline": true
                            },
                            {
                                "name": "",
                                "value": ":recycle:",
                                "inline": false
                            },
                            {
                                "name": "Images cleared",
                                "value": "$ImagesCleared",
                                "inline": true
                            },
                            {
                                "name": "Folders Cleared",
                                "value": "$PathsCleared",
                                "inline": true
                            },
                            {
                                "name": "Space saved",
                                "value": "$savedsizestring",
                                "inline": true
                            }
                            ],
                            "thumbnail": {
                                "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                            },
                            "footer": {
                                "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                            }
                        }
                        ]
                    }
"@
            }
            Else {
                $jsonPayload = @"
                    {
                        "username": "$global:DiscordUserName",
                        "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                        "content": "",
                        "embeds": [
                        {
                            "author": {
                            "name": "Posterizarr @Github",
                            "url": "https://github.com/fscorrupt/Posterizarr"
                            },
                            "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                            "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                            "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                            "fields": [
                            {
                                "name": "",
                                "value": ":bar_chart:",
                                "inline": false
                            },
                            {
                                "name": "Errors",
                                "value": "$errorCount",
                                "inline": false
                            },
                            {
                                "name": "Fallbacks",
                                "value": "$($FallbackCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Textless",
                                "value": "$($TextlessCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Truncated",
                                "value": "$($TextTruncatedCount.count)",
                                "inline": true
                            },
                            {
                                "name": "Unknown",
                                "value": "$PosterUnknownCount",
                                "inline": true
                            },
                            {
                                "name": "",
                                "value": ":frame_photo:",
                                "inline": false
                            },
                            {
                                "name": "Posters",
                                "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                                "inline": false
                            },
                            {
                                "name": "Backgrounds",
                                "value": "$BackgroundCount",
                                "inline": true
                            },
                            {
                                "name": "Seasons",
                                "value": "$SeasonCount",
                                "inline": true
                            },
                            {
                                "name": "TitleCards",
                                "value": "$EpisodeCount",
                                "inline": true
                            }
                            ],
                            "thumbnail": {
                                "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                            },
                            "footer": {
                                "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                            }
                        }
                        ]
                    }
"@
            }
        }
        $global:NotifyUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
        Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
    }
    Else {
        if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*' -and $global:SendNotification -eq 'true') {
            if ($errorCount -ge '1') {
                apprise --notification-type="failure" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images`n`nDuring execution '$errorCount' Errors occurred, please check log for detailed description." "$global:NotifyUrl"
            }
            Else {
                apprise --notification-type="success" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images" "$global:NotifyUrl"
            }
        }
    }

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
ElseIf ($PosterReset) {
    if ($UsePlex -eq 'true' -and $null -ne $LibraryToReset) {
        Write-Entry -Message "Poster reset requested for library: $LibraryToReset" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
        Write-Entry -Subtext "This action will reset all posters and cannot be undone." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Warning
        Write-Entry -Subtext "Starting in 20 seconds... Press Ctrl+C to cancel." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Info

        Start-Sleep -Seconds 20

        Write-Entry -Subtext "Resetting posters for library: $LibraryToReset" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
        Reset-PlexLibraryPictures -LibraryName $LibraryToReset
    }
    Else {
        Write-Entry -Message "This only works for plex servers..." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
    }
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
}
else {
    Write-Entry -Message "Query plex libs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libsoverview = @()
    foreach ($lib in $Libs.MediaContainer.Directory) {
        if ($lib.title -notin $LibstoExclude) {
            $libtemp = New-Object psobject
            $libtemp | Add-Member -MemberType NoteProperty -Name "ID" -Value $lib.key
            $libtemp | Add-Member -MemberType NoteProperty -Name "Name" -Value $lib.title
            $libtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $lib.language

            # Check if $lib.location.path is an array
            if ($lib.location.path -is [array]) {
                $paths = $lib.location.path -join ',' # Convert array to string
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $paths
            }
            else {
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $lib.location.path
            }
            # Check if Libname has chars we cant use for Folders
            if ($lib.title -notmatch "^[^\/:*?`"<>\|\\}]+$") {
                Write-Entry -Message  "Lib: '$($lib.title)' contains invalid characters." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Please rename your lib and remove all chars that are listed here: '/, :, *, ?, `", <, >, |, \, or }'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    Remove-Item -LiteralPath $CurrentlyRunning | out-null
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Invalid chars on lib"
                }
                Exit
            }
            $Libsoverview += $libtemp
        }
    }
    if ($($Libsoverview.count) -lt 1) {
        Write-Entry -Subtext "0 libraries were found. Are you on the correct Plex server?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "No libs found"
        }
        Exit
    }
    Write-Entry -Subtext "Found '$($Libsoverview.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = $Libsoverview.Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libraries = @()
    Foreach ($Library in $Libsoverview) {
        if ($Library.Name -notin $LibstoExclude) {
            $PlexHeaders = @{}
            if ($PlexToken) {
                $PlexHeaders['X-Plex-Token'] = $PlexToken
            }

            # Create a parent XML document
            $Libcontent = New-Object -TypeName System.Xml.XmlDocument
            $mediaContainerNode = $Libcontent.CreateElement('MediaContainer')
            $Libcontent.AppendChild($mediaContainerNode) | Out-Null

            # Initialize variables for pagination
            $searchsize = 0
            $totalContentSize = 1

            # Loop until all content is retrieved
            do {
                # Set headers for the current request
                $PlexHeaders['X-Plex-Container-Start'] = $searchsize
                $PlexHeaders['X-Plex-Container-Size'] = '1000'

                # Fetch content from Plex server
                $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/$($Library.ID)/all" -Headers $PlexHeaders

                # Convert response content to XML
                [xml]$additionalContent = $response.Content

                # Get total content size if not retrieved yet
                if ($totalContentSize -eq 1) {
                    $totalContentSize = $additionalContent.MediaContainer.totalSize
                }

                # Import and append video nodes to the parent XML document
                $contentquery = if ($additionalContent.MediaContainer.video) {
                    'video'
                }
                else {
                    'Directory'
                }
                foreach ($videoNode in $additionalContent.MediaContainer.$contentquery) {
                    $importedNode = $Libcontent.ImportNode($videoNode, $true)
                    [void]$mediaContainerNode.AppendChild($importedNode)
                }

                # Update search size for next request
                $searchsize += [int]$additionalContent.MediaContainer.Size
            } until ($searchsize -ge $totalContentSize)
            if ($Libcontent.MediaContainer.video) {
                $contentquery = 'video'
            }
            Else {
                $contentquery = 'Directory'
            }
            foreach ($item in $Libcontent.MediaContainer.$contentquery) {
                $extractedFolder = $null
                $Seasondata = $null
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children? -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $errorCount++
                        }
                    }
                }
                $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
                $tmdbpattern = 'tmdb://(\d+)'
                $imdbpattern = 'imdb://tt(\d+)'
                $tvdbpattern = 'tvdb://(\d+)'
                if ($Metadata.MediaContainer.$contentquery.Location) {
                    $location = $Metadata.MediaContainer.$contentquery.Location.path
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                Else {
                    $location = $Metadata.MediaContainer.$contentquery.media.part.file
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                        $CheckCharLimit = CheckCharLimit
                        if ($CheckCharLimit -eq $false) {
                            Write-Entry -Subtext "Skipping [$($item.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            continue
                        }
                    }

                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                if ($Seasondata) {
                    $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
                    $SeasonNames = $SeasonsTemp.Title -join ','
                    $SeasonNumbers = $SeasonsTemp.index -join ','
                    $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
                    $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
                }
                $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
                $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
                $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
                if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
                if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
                if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

                # check if there are more then 1 entry in ids
                if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
                if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
                if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

                if ($Metadata.MediaContainer.$contentquery.Label.tag) {
                    $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
                }
                Else {
                    $Labels = ""
                }
                $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata){
                    $FileMetadata | ForEach-Object {
                        if ($_.streamType -eq '1') {
                            $Resolution = $_.displayTitle
                        }
                    }
                }
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.Name
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $($item.title)
                if ($FileMetadata) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $($item.originalTitle)
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $item.year
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
                $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $item.ratingKey
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
                $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
                $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
                $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    Write-Entry -Message "Export everything to a csv: $global:ScriptRoot\Logs\PlexLibexport.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Initialize counter variable
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $PosterUnknownCount = 0
    $SkipTBACount = 0
    $SkipJapTitleCount = 0
    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    # Getting information of all Episodes
    if ($global:TitleCards -eq 'true') {
        Write-Entry -Message "Query episodes data from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata){
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        $Episodedata | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Test if csvs are missing and create dummy file.
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -ErrorAction SilentlyContinue)) {
        $EpisodeDummycsv = New-Object psobject

        # Add members to the object with empty values
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $null

        $EpisodeDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexEpisodeExport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexLibexport.csv" -ErrorAction SilentlyContinue)) {
        # Add members to the object with empty values
        $PlexLibDummycsv = New-Object psobject
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "title" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "year" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Path" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $null

        $PlexLibDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexLibexport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
        if ($FollowSymlink){
            Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $AssetPath -Recurse | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            Remove-Item -LiteralPath $CurrentlyRunning | out-null
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }

    # Download poster foreach movie
    Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

    $checkedItems = @()
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    $SkipingText = 'false'
                    $global:posterurl = $null
                    $global:ImageMagickError = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $global:IsFallback = $null
                    $global:PlexartworkDownloaded = $null
                    $global:langCode = $null
                    $global:direction = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }
                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexPosterUrl
                    }
                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {
                        $checkedItems += $hashtestpath
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkipingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:TextlessPoster = $null
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:ImageMagickError = $null
                            $TakeLocal = $null

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                    Default { $global:posterurl = GetFanartMoviePoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                }
                                if ($global:PreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if ($global:OnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Elseif ($global:FavProvider -eq 'FANART') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMoviePoster
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB' -and !$global:OnlyTextless -and !$global:PreferTextless) {
                                        $global:posterurl = GetTVDBMoviePoster
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl -and !$global:OnlyTextless) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                            $global:IsFallback = $true
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl -and $global:imdbid -and !$global:OnlyTextless) {
                                        Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:posterurl = GetIMDBPoster
                                        $global:IsFallback = $true
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        $statusCode = $_.Exception.Response.StatusCode
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $errorCount++
                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UsePosterResolutionOverlays -eq 'true'){
                                            switch ($entry.Resolution) {
                                                '4K' { $Posteroverlay = $4kposter }
                                                '1080p' { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                            $SkipingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkipingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }

                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                # Move file back to original naming with Brackets.
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            if ($Upload2Plex -eq 'true') {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                    if ($PlexToken) {
                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                    }
                                                    Else {
                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    $errorCount++
                                                }
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $movietemp = New-Object psobject
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }

                                            # Export the array to a CSV file
                                            $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $movietemp = New-Object psobject
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                try {
                                    GetPlexArtwork -Type "$Titletext Artwork." -ArtUrl $Arturl -TempImage $PosterImage
                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $fileContent = [System.IO.File]::ReadAllBytes($PosterImageoriginal)
                                        if ($PlexToken) {
                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                        }
                                        Else {
                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                        }
                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        $UploadCount++
                                    }
                                }
                                catch {
                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                if (Test-Path $PosterImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $PosterImage | Out-Null
                                    Write-Entry -Message "Deleting Temp Image: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                    # Now we can start the Background Poster Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        $checkedItems += $hashtestpath
                        if ($PlexToken) {
                            $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $entry.PlexBackgroundUrl
                        }
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkipingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:ImageMagickError = $null
                            $global:TextlessPoster = $null
                            $TakeLocal = $null

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                    Default { $global:posterurl = GetFanartMovieBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMovieBackground
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBMovieBackground
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                            $global:IsFallback = $true
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }

                                if ($BackgroundfontAllCaps -eq 'true') {
                                    $joinedTitle = $Titletext.ToUpper()
                                }
                                Else {
                                    $joinedTitle = $Titletext
                                }
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $BackgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $BackgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        $statusCode = $_.Exception.Response.StatusCode
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $errorCount++
                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                            $SkipingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkipingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }

                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            if ($Upload2Plex -eq 'true') {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                    if ($PlexToken) {
                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                    }
                                                    Else {
                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    $errorCount++
                                                }
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                            $BackgroundCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $moviebackgroundtemp = New-Object psobject
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }
                                            # Export the array to a CSV file
                                            $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $moviebackgroundtemp = New-Object psobject
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $movietemoviebackgroundtempmp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                try {
                                    GetPlexArtwork -Type " $Titletext | Backgound Artwork." -ArtUrl $Arturl -TempImage $backgroundImage
                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $fileContent = [System.IO.File]::ReadAllBytes($backgroundImageoriginal)
                                        if ($PlexToken) {
                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                        }
                                        Else {
                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                        }
                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        $UploadCount++
                                    }
                                }
                                catch {
                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                if (Test-Path $backgroundImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $backgroundImage | Out-Null
                                    Write-Entry -Message "Deleting Temp Image: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $errorCount++
            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            if ($global:OnlyTextless) {
                $moviebackgroundtemp = New-Object psobject
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                switch -Wildcard ($global:FavProvider) {
                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                    Default { $movietemoviebackgroundtempmp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                }

                # Export the array to a CSV file
                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
            }
            $errorCount++
        }
    }

    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Define Global Variables
                $SkipingText = 'false'
                $global:tmdbsearched = $null
                $global:tmdbid = $entry.tmdbid
                $global:tvdbid = $entry.tvdbid
                $global:imdbid = $entry.imdbid
                $Seasonpostersearchtext = $null
                $global:ImageMagickError = $null
                $Episodepostersearchtext = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $FanartSearched = $null
                $global:plexalreadysearched = $null
                $global:posterurl = $null
                $global:PosterWithText = $null
                $global:AssetTextLang = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:Fallback = $null
                $global:TextlessPoster = $null
                $global:tvdbalreadysearched = $null
                $global:PlexartworkDownloaded = $null
                $global:langCode = $null
                $global:direction = $null
                $TakeLocal = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    if ($entry.extraFolder) {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                    }
                    Else {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                    }
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $ManualTestPath = $ManualEntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    if ($entry.extraFolder) {
                        $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                    }
                    Else {
                        $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                    }
                    $TestPath = $AssetPath
                    $ManualTestPath = $ManualPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                if ($PlexToken) {
                    $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                }
                Else {
                    $Arturl = $plexurl + $entry.PlexPosterUrl
                }
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $checkedItems += $hashtestpath
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                            Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Else {
                            Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                Default { $global:posterurl = GetFanartShowPoster }
                            }
                            if (!$global:posterurl) {
                                Write-Entry -Subtext "Could not find a poster on: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                            }
                            if ($global:PreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TVDBfallbackposterurl) {
                                    $global:posterurl = $global:TVDBfallbackposterurl
                                    Write-Entry -Subtext "Took TVDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                # try to find textless on TVDB
                                if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid -and $global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                    $global:tvdbalreadysearched = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                    $global:posterurl = GetFanartMoviePoster
                                    $global:IsFallback = $true
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                $global:PosterWithText = $true
                            }

                            if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                $global:posterurl = GetTVDBShowPoster
                                $global:IsFallback = $true
                                if (!$global:posterurl -and !$global:TMDBfallbackposterurl -and !$global:fanartfallbackposterurl) {
                                    if ($ArtUrl -and !$global:OnlyTextless) {
                                        GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                        $global:plexalreadysearched = $True
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                            }
                            if (!$global:posterurl -and !$global:plexalreadysearched -eq 'true') {
                                $global:IsFallback = $true
                                if ($ArtUrl -and !$global:OnlyTextless) {
                                    GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                    $global:plexalreadysearched = $True
                                }
                                Else {
                                    Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                if (!$global:posterurl) {
                                    Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                            if (!$global:TextlessPoster -eq 'true' -and $global:TMDBfallbackposterurl) {
                                $global:posterurl = $global:TMDBfallbackposterurl
                            }
                            if (!$global:TextlessPoster -eq 'true' -and $global:fanartfallbackposterurl) {
                                $global:posterurl = $global:fanartfallbackposterurl
                            }
                        }
                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    $statusCode = $_.Exception.Response.StatusCode
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    if ($UsePosterResolutionOverlays -eq 'true'){
                                        switch ($entry.Resolution) {
                                            '4K' { $Posteroverlay = $4kposter }
                                            '1080p' { $Posteroverlay = $1080pPoster }
                                            Default { $Posteroverlay = $Posteroverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBorder -eq 'false' -and $AddOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                        $SkipingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddText -eq 'true' -and $SkipingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $fontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddTextStroke -eq 'true') {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }

                                            Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                    # Move file back to original naming with Brackets.
                                    if (!$global:IsTruncated) {
                                        if ($Upload2Plex -eq 'true') {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                if ($PlexToken) {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                                Else {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$TakeLocal) {
                                        $showtemp = New-Object psobject
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                            'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                            'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                            Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                        }
                                        # Export the array to a CSV file
                                        $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            if ($global:OnlyTextless) {
                                $showtemp = New-Object psobject
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                    'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                    'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                    Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                }

                                # Export the array to a CSV file
                                $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                            }
                            $errorCount++
                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            try {
                                GetPlexArtwork -Type " $Titletext Artwork." -ArtUrl $Arturl -TempImage $PosterImage
                                if ($global:PlexartworkDownloaded -eq 'true') {
                                    Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $fileContent = [System.IO.File]::ReadAllBytes($PosterImageoriginal)
                                    if ($PlexToken) {
                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                    }
                                    Else {
                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                    }
                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    $UploadCount++
                                }
                            }
                            catch {
                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $errorCount++
                            }
                            if (Test-Path $PosterImage -ErrorAction SilentlyContinue) {
                                Remove-Item -LiteralPath $PosterImage | Out-Null
                                Write-Entry -Message "Deleting Temp Image: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                        }
                        Else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Background Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                        }
                        Else {
                            $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath
                    if ($PlexToken) {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                    }
                    Else {
                        $Arturl = $plexurl + $entry.PlexBackgroundUrl
                    }
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkipingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:TextlessPoster = $null
                        $global:ImageMagickError = $null
                        $TakeLocal = $null

                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                            Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Else {
                            Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                Default { $global:posterurl = GetFanartShowBackground }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                            }
                            if ($global:BackgroundPreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                            }
                            if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                if ($global:FavProvider -eq 'TVDB') {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                                Else {
                                    $global:posterurl = GetFanartShowBackground
                                }
                            }
                            if (!$global:posterurl) {
                                if ($global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowBackground
                                    $global:IsFallback = $true
                                }
                                $global:FallbackText = 'True-Background'
                                if (!$global:posterurl) {
                                    if ($ArtUrl) {
                                        GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }

                            }
                        }
                        if ($BackgroundfontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $BackgroundImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $BackgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    $statusCode = $_.Exception.Response.StatusCode
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                        $SkipingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddBackgroundText -eq 'true' -and $SkipingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $backgroundfontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), "`n"
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddBackgroundTextStroke -eq 'true') {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }

                                            Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                # Move file back to original naming with Brackets.
                                if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                    if (!$global:IsTruncated) {
                                        if ($Upload2Plex -eq 'true') {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                if ($PlexToken) {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                                Else {
                                                    $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        $BackgroundCount++
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$TakeLocal) {
                                        $showbackgroundtemp = New-Object psobject
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                            'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                            'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                            Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                        }
                                        # Export the array to a CSV file
                                        $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            if ($global:OnlyTextless) {
                                $showbackgroundtemp = New-Object psobject
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                    'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                    'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                    Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                }

                                # Export the array to a CSV file
                                $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                            }
                            $errorCount++
                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            try {
                                GetPlexArtwork -Type " $Titletext | Background Artwork." -ArtUrl $Arturl -TempImage $backgroundImage
                                if ($global:PlexartworkDownloaded -eq 'true') {
                                    Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $fileContent = [System.IO.File]::ReadAllBytes($backgroundImageoriginal)
                                    if ($PlexToken) {
                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                    }
                                    Else {
                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                    }
                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    $UploadCount++
                                }
                            }
                            catch {
                                Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $errorCount++
                            }
                            if (Test-Path $backgroundImage -ErrorAction SilentlyContinue) {
                                Remove-Item -LiteralPath $backgroundImage | Out-Null
                                Write-Entry -Message "Deleting Temp Image: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                        }
                        Else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Season Part
                if ($global:SeasonPosters -eq 'true') {
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:TextlessPoster = $null
                    $global:seasonNames = $entry.SeasonNames -split ','
                    $global:SeasonRatingKeys = $entry.SeasonRatingKeys -split ','
                    $global:seasonNumbers = $entry.seasonNumbers -split ','
                    $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                    for ($i = 0; $i -lt $global:seasonNames.Count; $i++) {
                        $SkipingText = 'false'
                        $global:tmdbsearched = $null
                        $global:posterurl = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TMDBSeasonFallback = $null
                        $global:TVDBSeasonFallback = $null
                        $global:FANARTSeasonFallback = $null
                        $TakeLocal = $null
                        if ($SeasonfontAllCaps -eq 'true') {
                            $global:seasonTitle = $global:seasonNames[$i].ToUpper()
                        }
                        Else {
                            $global:seasonTitle = $global:seasonNames[$i]
                        }
                        $global:SeasonNumber = $global:seasonNumbers[$i]
                        $global:SeasonRatingKey = $global:SeasonRatingKeys[$i]
                        $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                        if ($global:SeasonNumber) {
                            $global:season = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                        }
                        if ($LibraryFolders -eq 'true') {
                            $SeasonImageoriginal = "$EntryDir\$global:season.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "$global:season"
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:season.jpg"
                            }
                            Else {
                                $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:season.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_$global:season"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                        $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:season.jpg"
                        $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        $checkedItems += $hashtestpath
                        if ($PlexToken) {
                            $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $global:PlexSeasonUrl
                        }
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }
                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Else {
                                if (!$Seasonpostersearchtext) {
                                    Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $Seasonpostersearchtext = $true
                                }
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage } }
                                    Default { $global:posterurl = GetFanartSeasonPoster }
                                }
                                # do a specific order
                                if ($global:SeasonPreferTextless -eq $true) {
                                    if (!$global:posterurl -or !$global:TextlessPoster) {
                                        if (!$entry.tmdbid -and $global:FavProvider -ne 'TMDB') {
                                            Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$entry.tvdbid -and $global:FavProvider -ne 'TVDB') {
                                            Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            $global:IsFallback = $true
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl -or !$global:TextlessPoster) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                                $global:posterurl = GetTVDBSeasonPoster
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                    if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                        # Lets just try to grab a show poster.
                                        Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'FANART' { $global:posterurl = GetFanartShowPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                            Default { $global:posterurl = GetFanartShowPoster }
                                        }
                                        if ($global:posterurl) {
                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Show'
                                        }
                                        Else {
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:posterurl = GetTMDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                $global:posterurl = GetTVDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                $global:posterurl = GetFanartShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            $global:IsFallback = $true
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if (!$global:posterurl -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                                $global:posterurl = GetTVDBSeasonPoster
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ($ArtUrl) {
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                                GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage
                                                Write-Entry -Subtext "Function GetPlexArtwork called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Season Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                                if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                    # Lets just try to grab a show poster.
                                    Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'FANART' { $global:posterurl = GetFanartShowPoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                        Default { $global:posterurl = GetFanartShowPoster }
                                    }
                                    if ($global:posterurl) {
                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Show'
                                    }
                                    Else {
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:posterurl = GetTMDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                            $global:posterurl = GetTVDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                            $global:posterurl = GetFanartShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                    }
                                }
                                if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                    $global:posterurl = $global:TMDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                    $global:posterurl = $global:FANARTSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                    $global:posterurl = $global:TVDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }

                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($global:ImageProcessing -eq 'true') {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            $statusCode = $_.Exception.Response.StatusCode
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'IMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'true') {
                                            # Resize Image to 2000x3000 and apply Border and overlay
                                            if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            if ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }

                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                $SkipingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddSeasonText -eq 'true' -and $SkipingText -eq 'false') {
                                                $global:seasonTitle = $global:seasonTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                    $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                Else {
                                                    $global:ShowTitleOnSeason = $titletext -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), "`n"
                                                        if ($AddShowTitletoSeason -eq 'true') {
                                                            $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), "`n"
                                                        }
                                                    }
                                                }
                                                $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                if ($AddShowTitletoSeason -eq 'true') {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext "Optimal Season font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        Write-Entry -Subtext "Optimal Show font size set to: '$ShowoptimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Season Part
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $SeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                        # Show Part
                                                        # Add Stroke
                                                        if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                    }
                                                }
                                                Else {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Arguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            $statusCode = $_.Exception.Response.StatusCode
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $errorCount++
                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'IMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Resize Image to 2000x3000
                                        $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        if (!$global:IsTruncated) {
                                            if ($Upload2Plex -eq 'true') {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($SeasonImage)
                                                    if ($PlexToken) {
                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                    }
                                                    Else {
                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    $errorCount++
                                                }
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $errorCount++
                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $SeasonCount++
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$TakeLocal) {
                                            $seasontemp = New-Object psobject
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | " + $global:season)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                            }
                                            # Export the array to a CSV file
                                            $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        }
                                    }
                                }
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                if ($global:OnlyTextless) {
                                    $seasontemp = New-Object psobject
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                        'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                        'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                        Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                    }

                                    # Export the array to a CSV file
                                    $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                                $errorCount++
                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                try {
                                    GetPlexArtwork -Type " $Titletext | $global:season Artwork." -ArtUrl $Arturl -TempImage $SeasonImage
                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $fileContent = [System.IO.File]::ReadAllBytes($SeasonImageoriginal)
                                        if ($PlexToken) {
                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                        }
                                        Else {
                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                        }
                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        $UploadCount++
                                    }
                                }
                                catch {
                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $errorCount++
                                }
                                if (Test-Path $SeasonImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $SeasonImage | Out-Null
                                    Write-Entry -Message "Deleting Temp Image: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
                # Now we can start the Episode Part
                if ($global:TitleCards -eq 'true') {
                    # Loop through each episode
                    foreach ($episode in $Episodedata) {
                        $SkipingText = 'false'
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:TempImagecopied = $false
                        $EpisodeTempImage = $null
                        $global:ImageMagickError = $null
                        $global:season_number = $null
                        $Episodepostersearchtext = $null
                        $global:show_name = $null
                        $global:episodenumber = $null
                        $global:episode_numbers = $null
                        $global:titles = $null
                        $global:posterurl = $null
                        $global:FileNaming = $null
                        $EpisodeImageoriginal = $null
                        $EpisodeImage = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TextlessPoster = $null

                        if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title -and $episode.'Library Name' -eq $entry.'Library Name') {
                            $global:show_name = $episode."Show Name"
                            $global:season_number = $episode."Season Number"
                            $global:episode_numbers = $episode."Episodes".Split(",")
                            $global:episode_ratingkeys = $episode."ratingKeys".Split(",")
                            $global:titles = $episode."Title".Split(";")
                            $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")
                            if ($UseBackgroundAsTitleCard -eq 'true') {
                                $global:ImageMagickError = $null
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkipingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $global:PlexTitleCardUrl = $entry.PlexBackgroundUrl
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                    $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath
                                        if ($PlexToken) {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                        }
                                        Else {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl
                                        }
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }
                                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                                $Episodepostersearchtext = $true
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if ($global:tmdbfallbackposterurl) {
                                                                $global:posterurl = $global:tmdbfallbackposterurl
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetFanartShowBackground
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBShowBackground
                                                        if (!$global:posterurl) {
                                                            $global:posterurl = GetFanartShowBackground
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded -and $global:TempImagecopied -ne 'true') {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }
                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like "$PlexUrl*") {
                                                                Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                if ($global:FavProvider -ne 'PLEX') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        Else {
                                                            Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                        }
                                                    }
                                                    $global:TempImagecopied = $true
                                                    # Check temp image
                                                    if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                        Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $errorCount++
                                                    }
                                                    Else {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'true') {
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                    $SkipingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkipingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''

                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), "`n"
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                    $SkipingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkipingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }
                                                        Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            if ($Upload2Plex -eq 'true') {
                                                                try {
                                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                    if ($PlexToken) {
                                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                    }
                                                                    Else {
                                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                    }
                                                                }
                                                                catch {
                                                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    $errorCount++
                                                                }
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        if (!$TakeLocal) {
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                        }
                                                    }
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:OnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                    }

                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }
                                                $errorCount++
                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                try {
                                                    GetPlexArtwork -Type " $Titletext | $global:FileNaming Artwork." -ArtUrl $Arturl -TempImage $EpisodeImage
                                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImageoriginal)
                                                        if ($PlexToken) {
                                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                        }
                                                        Else {
                                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                        }
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        $UploadCount++
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    $errorCount++
                                                }
                                                if (Test-Path $EpisodeImage -ErrorAction SilentlyContinue) {
                                                    Remove-Item -LiteralPath $EpisodeImage | Out-Null
                                                    Write-Entry -Message "Deleting Temp Image: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                            }
                                            Else {
                                                if ($show_skipped -eq 'true' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                                if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                    Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkipingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:FallbackText = $null
                                    $global:ImageMagickError = $null
                                    $global:TextlessPoster = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath
                                        if ($PlexToken) {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                        }
                                        Else {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl
                                        }
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }
                                            if (Test-Path -LiteralPath "$($Manualtestpath)$posterext") {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if ($global:Fallback -eq "TVDB") {
                                                            $global:posterurl = GetTVDBTitleCard
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if ($global:Fallback -eq "TMDB") {
                                                            $global:posterurl = GetTMDBTitleCard
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }
                                                        Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                        if (!$global:ImageMagickError -eq 'true') {
                                                            # Resize Image to 2000x3000 and apply Border and overlay
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            if ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                $SkipingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPTitleText -eq 'true' -and $SkipingText -eq 'false') {
                                                                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                    $global:EPTitle = $global:EPTitle.ToUpper()
                                                                }
                                                                $global:EPTitle = $global:EPTitle -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                if ($global:direction -eq "RTL") {
                                                                    $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                }
                                                                # Loop through each symbol and replace it with a newline
                                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                    foreach ($symbol in $NewLineSymbols) {
                                                                        $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), "`n"
                                                                    }
                                                                }
                                                                $joinedTitlePointSize = $global:EPTitle -replace '""', '""""' -replace '`', ''
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                            if ($SkipAddText -eq 'true' -and $global:PosterWithText) {
                                                                $SkipingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPText -eq 'true' -and $SkipingText -eq 'false') {
                                                                if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                }
                                                                $global:SeasonEPNumber = $global:SeasonEPNumber -replace '', '"' -replace '', '"' -replace '', '"' -replace '"', '""' -replace '`', ''
                                                                $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext "Optimal font size set to: '$optimalFontSize'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            $statusCode = $_.Exception.Response.StatusCode
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $errorCount++
                                                        }
                                                        Write-Entry -Subtext "Title Card url: $global:posterurl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            if ($Upload2Plex -eq 'true') {
                                                                try {
                                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                    if ($PlexToken) {
                                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                    }
                                                                    Else {
                                                                        $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                                    }
                                                                }
                                                                catch {
                                                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    $errorCount++
                                                                }
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $errorCount++
                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        if (!$TakeLocal) {
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $global:posterurl
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                        }
                                                    }
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:OnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value "N/A"
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value "N/A"
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "N/A" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "N/A" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "N/A" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value "N/A" }
                                                    }

                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }
                                                $errorCount++
                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                try {
                                                    GetPlexArtwork -Type " $Titletext | $global:FileNaming Artwork." -ArtUrl $Arturl -TempImage $EpisodeImage
                                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImageoriginal)
                                                        if ($PlexToken) {
                                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                        }
                                                        Else {
                                                            $Upload = Invoke-WebRequest -Uri "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?" -Method Post -Headers $extraPlexHeaders -Body $fileContent -ContentType 'application/octet-stream'
                                                        }
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        $UploadCount++
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Could not upload Artwork to plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    $errorCount++
                                                }
                                                if (Test-Path $EpisodeImage -ErrorAction SilentlyContinue) {
                                                    Remove-Item -LiteralPath $EpisodeImage | Out-Null
                                                    Write-Entry -Message "Deleting Temp Image: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                            }
                                            Else {
                                                if ($show_skipped -eq 'true' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $errorCount++
        }
    }

    # Asset Cleanup
    if ($AssetCleanup -eq 'true') {
        $ImagesCleared = 0
        $PathsCleared = 0
        $savedsizestring = 0
        Write-Entry -Subtext "Starting Asset Cleanup, this can take some time..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        Write-Entry -Subtext "Only removing Artwork with posterizarr exif data" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        $processedDirectories = @()
        $uncheckedItems = $directoryHashtable.Keys | Where-Object { $_ -notin $checkedItems }

        # Perform deletion of unchecked items
        foreach ($uncheckedItem in $uncheckedItems) {
            if ($uncheckedItem -notlike '*.jpg') {
                # Full path to the item
                $uncheckedItemPath = $uncheckedItem + ".jpg"

                # Check if its a asset from Posterizarr
                $exifmagickcommand = "& `"$magick`" identify -verbose `"$uncheckedItemPath`""
                $exifmagickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

                $ExifData = (Invoke-Expression $exifmagickcommand | Select-String -Pattern 'created with ppm|created with posterizarr')

                if ($ExifData) {
                    # Remove unchecked item from filesystem
                    Remove-Item -LiteralPath $uncheckedItemPath -Force | Out-Null
                    $ImagesCleared++
                    Write-Entry -Subtext "Artwork Removed: $uncheckedItemPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    if ($LibraryFolders -eq 'true') {
                        # Determine the parent directory of the item
                        $parentDir = Split-Path -Path $uncheckedItemPath -Parent

                        # Add the directory to the list if it's not already included
                        if ($parentDir -notin $processedDirectories) {
                            $processedDirectories += $parentDir
                        }
                    }
                }
            }
        }

        # Cleanup empty Asset dirs
        if ($LibraryFolders -eq 'true') {
            # After all files are removed, check each directory in the list
            foreach ($dir in $processedDirectories) {
                # Check if the directory is now empty (including hidden and system files)
                if (-not (Get-ChildItem -LiteralPath $dir -Force)) {
                    # Remove the parent directory if it is empty
                    $PathsCleared++
                    Remove-Item -LiteralPath $dir -Force -Recurse -Confirm:$false | Out-Null
                    Write-Entry -Subtext "Removed empty directory: $dir" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                }
            }
        }
        if ($ImagesCleared -ge '1' -or $PathsCleared -ge '1') {
            Write-Entry -Message "Asset Cleanup overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        # Check new dir Size
        if ($ImagesCleared -ge '1') {
            $newtotalSize = Get-ChildItem $AssetPath -Recurse | Measure-Object -Property Length -Sum
            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($newtotalSize.Sum -gt 1GB) {
                $newtotalSizeString = "{0:N2} GB" -f ($newtotalSize.Sum / 1GB)
            }
            elseif ($newtotalSize.Sum -gt 1MB) {
                $newtotalSizeString = "{0:N2} MB" -f ($newtotalSize.Sum / 1MB)
            }
            elseif ($newtotalSize.Sum -gt 1KB) {
                $newtotalSizeString = "{0:N2} KB" -f ($newtotalSize.Sum / 1KB)
            }
            else {
                $newtotalSizeString = "$($newtotalSize.Sum) bytes"
            }

            # Saved space
            $SavedSpace = $totalSize - $newtotalSize.Sum

            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($SavedSpace -gt 1GB) {
                $savedsizestring = "{0:N2} GB" -f ($SavedSpace / 1GB)
            }
            elseif ($SavedSpace -gt 1MB) {
                $savedsizestring = "{0:N2} MB" -f ($SavedSpace / 1MB)
            }
            elseif ($SavedSpace -gt 1KB) {
                $savedsizestring = "{0:N2} KB" -f ($SavedSpace / 1KB)
            }
            else {
                $savedsizestring = "$SavedSpace bytes"
            }

            if ($ImagesCleared -ge '1') {
                Write-Entry -Subtext "Images Cleared: $ImagesCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Images Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($PathsCleared -ge '1') {
            if ($PathsCleared -ge '1') {
                Write-Entry -Subtext "Empty Folders Cleared: $PathsCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Empty Folders Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($ImagesCleared -ge '1') {
            Write-Entry -Subtext "Cleanup saved: $savedsizestring" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($UploadCount -ge '1') {
        Write-Entry -Message "Finished, Total images Uploaded: $UploadCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
        Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
            Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextlessCount) {
            Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($FallbackCount) {
            Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextCount) {
            Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($PosterUnknownCount -ge '1') {
            Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextTruncatedCount) {
            Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
        $ImageChoicesDummycsv = New-Object psobject

        # Add members to the object with empty values
        $ImageChoicesDummycsv = New-Object psobject
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

        $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    if ($global:NotifyUrl -like '*discord*' -and $global:SendNotification -eq 'true') {
        if ($SkipTBA -eq 'true' -or $SkipJapTitle -eq 'true') {
            if ($AssetCleanup -eq 'true') {
                $jsonPayload = @"
                {
                    "username": "$global:DiscordUserName",
                    "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                    "content": "",
                    "embeds": [
                    {
                        "author": {
                        "name": "Posterizarr @Github",
                        "url": "https://github.com/fscorrupt/Posterizarr"
                        },
                        "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                        "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                        "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                        "fields": [
                        {
                            "name": "",
                            "value": ":bar_chart:",
                            "inline": false
                        },
                        {
                            "name": "Errors",
                            "value": "$errorCount",
                            "inline": false
                        },
                        {
                            "name": "Fallbacks",
                            "value": "$($FallbackCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Textless",
                            "value": "$($TextlessCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Truncated",
                            "value": "$($TextTruncatedCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Unknown",
                            "value": "$PosterUnknownCount",
                            "inline": true
                        },
                        {
                            "name": "TBA Skipped",
                            "value": "$SkipTBACount",
                            "inline": true
                        },
                        {
                            "name": "Jap/Chinese Skipped",
                            "value": "$SkipJapTitleCount",
                            "inline": true
                        },
                        {
                            "name": "",
                            "value": ":frame_photo:",
                            "inline": false
                        },
                        {
                            "name": "Posters",
                            "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                            "inline": false
                        },
                        {
                            "name": "Backgrounds",
                            "value": "$BackgroundCount",
                            "inline": true
                        },
                        {
                            "name": "Seasons",
                            "value": "$SeasonCount",
                            "inline": true
                        },
                        {
                            "name": "TitleCards",
                            "value": "$EpisodeCount",
                            "inline": true
                        },
                        {
                            "name": "",
                            "value": ":recycle:",
                            "inline": false
                        },
                        {
                            "name": "Images cleared",
                            "value": "$ImagesCleared",
                            "inline": true
                        },
                        {
                            "name": "Folders Cleared",
                            "value": "$PathsCleared",
                            "inline": true
                        },
                        {
                            "name": "Space saved",
                            "value": "$savedsizestring",
                            "inline": true
                        }
                        ],
                        "thumbnail": {
                            "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                        },
                        "footer": {
                            "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                        }
                    }
                    ]
                }
"@
            }
            Else {
                $jsonPayload = @"
            {
                "username": "$global:DiscordUserName",
                "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                "content": "",
                "embeds": [
                {
                    "author": {
                    "name": "Posterizarr @Github",
                    "url": "https://github.com/fscorrupt/Posterizarr"
                    },
                    "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                    "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                    "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                    "fields": [
                    {
                        "name": "",
                        "value": ":bar_chart:",
                        "inline": false
                    },
                    {
                        "name": "Errors",
                        "value": "$errorCount",
                        "inline": false
                    },
                    {
                        "name": "Fallbacks",
                        "value": "$($FallbackCount.count)",
                        "inline": true
                    },
                    {
                        "name": "Textless",
                        "value": "$($TextlessCount.count)",
                        "inline": true
                    },
                    {
                        "name": "Truncated",
                        "value": "$($TextTruncatedCount.count)",
                        "inline": true
                    },
                    {
                        "name": "Unknown",
                        "value": "$PosterUnknownCount",
                        "inline": true
                    },
                    {
                        "name": "TBA Skipped",
                        "value": "$SkipTBACount",
                        "inline": true
                    },
                    {
                        "name": "Jap/Chinese Skipped",
                        "value": "$SkipJapTitleCount",
                        "inline": true
                    },
                    {
                        "name": "",
                        "value": ":frame_photo:",
                        "inline": false
                    },
                    {
                        "name": "Posters",
                        "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                        "inline": false
                    },
                    {
                        "name": "Backgrounds",
                        "value": "$BackgroundCount",
                        "inline": true
                    },
                    {
                        "name": "Seasons",
                        "value": "$SeasonCount",
                        "inline": true
                    },
                    {
                        "name": "TitleCards",
                        "value": "$EpisodeCount",
                        "inline": true
                    }
                    ],
                    "thumbnail": {
                        "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                    },
                    "footer": {
                        "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                    }
                }
                ]
            }
"@
            }
        }
        Else {
            if ($AssetCleanup -eq 'true') {
                $jsonPayload = @"
                {
                    "username": "$global:DiscordUserName",
                    "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                    "content": "",
                    "embeds": [
                    {
                        "author": {
                        "name": "Posterizarr @Github",
                        "url": "https://github.com/fscorrupt/Posterizarr"
                        },
                        "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                        "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                        "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                        "fields": [
                        {
                            "name": "",
                            "value": ":bar_chart:",
                            "inline": false
                        },
                        {
                            "name": "Errors",
                            "value": "$errorCount",
                            "inline": false
                        },
                        {
                            "name": "Fallbacks",
                            "value": "$($FallbackCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Textless",
                            "value": "$($TextlessCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Truncated",
                            "value": "$($TextTruncatedCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Unknown",
                            "value": "$PosterUnknownCount",
                            "inline": true
                        },
                        {
                            "name": "",
                            "value": ":frame_photo:",
                            "inline": false
                        },
                        {
                            "name": "Posters",
                            "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                            "inline": false
                        },
                        {
                            "name": "Backgrounds",
                            "value": "$BackgroundCount",
                            "inline": true
                        },
                        {
                            "name": "Seasons",
                            "value": "$SeasonCount",
                            "inline": true
                        },
                        {
                            "name": "TitleCards",
                            "value": "$EpisodeCount",
                            "inline": true
                        },
                        {
                            "name": "",
                            "value": ":recycle:",
                            "inline": false
                        },
                        {
                            "name": "Images cleared",
                            "value": "$ImagesCleared",
                            "inline": true
                        },
                        {
                            "name": "Folders Cleared",
                            "value": "$PathsCleared",
                            "inline": true
                        },
                        {
                            "name": "Space saved",
                            "value": "$savedsizestring",
                            "inline": true
                        }
                        ],
                        "thumbnail": {
                            "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                        },
                        "footer": {
                            "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                        }
                    }
                    ]
                }
"@
            }
            Else {
                $jsonPayload = @"
                {
                    "username": "$global:DiscordUserName",
                    "avatar_url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png",
                    "content": "",
                    "embeds": [
                    {
                        "author": {
                        "name": "Posterizarr @Github",
                        "url": "https://github.com/fscorrupt/Posterizarr"
                        },
                        "description": "Run took: $FormattedTimespawn $(if ($errorCount -ge '1') {"\n During execution Errors occurred, please check log for detailed description."})",
                        "timestamp": "$(((Get-Date).ToUniversalTime()).ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))",
                        "color": $(if ($errorCount -ge '1') {16711680}Elseif ($Testing){8388736}Elseif ($FallbackCount.count -gt '1' -or $PosterUnknownCount -ge '1' -or $TextTruncatedCount.count -gt '1'){15120384}Else{5763719}),
                        "fields": [
                        {
                            "name": "",
                            "value": ":bar_chart:",
                            "inline": false
                        },
                        {
                            "name": "Errors",
                            "value": "$errorCount",
                            "inline": false
                        },
                        {
                            "name": "Fallbacks",
                            "value": "$($FallbackCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Textless",
                            "value": "$($TextlessCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Truncated",
                            "value": "$($TextTruncatedCount.count)",
                            "inline": true
                        },
                        {
                            "name": "Unknown",
                            "value": "$PosterUnknownCount",
                            "inline": true
                        },
                        {
                            "name": "",
                            "value": ":frame_photo:",
                            "inline": false
                        },
                        {
                            "name": "Posters",
                            "value": "$($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)",
                            "inline": false
                        },
                        {
                            "name": "Backgrounds",
                            "value": "$BackgroundCount",
                            "inline": true
                        },
                        {
                            "name": "Seasons",
                            "value": "$SeasonCount",
                            "inline": true
                        },
                        {
                            "name": "TitleCards",
                            "value": "$EpisodeCount",
                            "inline": true
                        }
                        ],
                        "thumbnail": {
                            "url": "https://github.com/fscorrupt/Posterizarr/raw/$($Branch)/images/webhook.png"
                        },
                        "footer": {
                            "text": "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $CurrentImagemagickversion | IM vNext: $LatestImagemagickversion"
                        }
                    }
                    ]
                }
"@
            }
        }
        $global:NotifyUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
        Push-ObjectToDiscord -strDiscordWebhook $global:NotifyUrl -objPayload $jsonPayload
    }
    Else {
        if ($global:NotifyUrl -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*' -and $global:SendNotification -eq 'true') {
            if ($errorCount -ge '1') {
                apprise --notification-type="failure" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images`n`nDuring execution '$errorCount' Errors occurred, please check log for detailed description." "$global:NotifyUrl"
            }
            Else {
                apprise --notification-type="success" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images" "$global:NotifyUrl"
            }
        }
    }

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        Remove-Item -LiteralPath $CurrentlyRunning | out-null
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
